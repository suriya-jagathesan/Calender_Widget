<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
    <title>Day & Week Calendar View - With Employees</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f7fa;
        }
        .filter-option-header {
    background: #f3f4f6;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 700;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-top: 1px solid #e5e7eb;
}
.filter-date-input, .filter-n-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    margin-top: 5px;
}
.filter-n-input {
    width: 80px;
}
        /* Container that holds the header and the scrollable area */
.calendar-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    /* overflow: hidden; Keeps the rounded corners clean */
    display: flex;
    flex-direction: column;
}

/* Add this class to the div containing your rows */
.calendar-body-scrollable {
    flex: 1;
    overflow-y: auto;   /* ✅ vertical scroll lives here */
    overflow-x: hidden;
    position: relative;
}


/* Make the header sticky so it stays visible while scrolling down */
.calendar-header-grid, .week-days-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
}
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
        }
        .view-toggle {
            display: flex;
            gap: 0;
            background: #f3f4f6;
            border-radius: 6px;
            /* overflow: hidden; */
        }
        .view-toggle button {
            padding: 8px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .view-toggle button.active {
            background: #4f46e5;
            color: white;
        }
        .date-title {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
        }
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .nav-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: #f9fafb; }
        .calendar-icon {
            padding: 8px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .mini-calendar {
            position: absolute;
            right: 30px;
            top: 70px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 200;
            display: none;
            width: 320px;
        }

        .mini-calendar.active {
            display: block;
        }

        .mini-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }

        .mini-nav {
            display: flex;
            gap: 10px;
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .mini-day-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            padding: 8px 5px;
            text-transform: uppercase;
        }

        .mini-day {
            padding: 10px;
            font-size: 13px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .mini-day:hover {
            background: #f3f4f6;
        }

        .mini-day.other-month {
            color: #d1d5db;
           
        }

        .mini-day.today {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }

        .mini-day.selected {
            background: #4f46e5;
            color: white;
            font-weight: 600;
        }
        
        .mini-day.week-highlighted {
            background: #e0e7ff;
            color: #4338ca;
        }
        
        .mini-day.week-highlighted.today {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        
        .mini-day.week-highlighted.selected {
            background: #4f46e5;
            color: white;
            font-weight: 600;
        }
        
        .mini-day.week-hover {
            background: #f3f4f6 !important;
        }
        
        /* Search Filters Display Section */
        .search-filters-section {
            padding-left: 15px;
            background: #fafafa;
            border-bottom: 1px solid #e5e7eb;
            display: none;
        }

        .search-filters-section.active {
            display: block;
        }

        .search-filters-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-filter-pill {
            display: inline-flex;
            align-items: center;
            background: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            color: #1f2937;
            gap: 8px;
            transition: background 0.2s;
        }

        .search-filter-pill:hover {
            background: #d1d5db;
        }

        .filter-pill-text {
            line-height: 1.4;
        }

        .filter-pill-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .filter-pill-remove:hover {
            background: #9ca3af;
            color: white;
        }

        /* Search Panel Styles */
        .search-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 200;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .search-panel.active {
            right: 0;
        }

.sticky-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: #ffffff;
}

/* Prevent overlap shadow glitch */
.day-header-row {
    border-bottom: 2px solid #e5e7eb;
}
.day-header-row.sticky-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: #ffffff;
}



        .search-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .close-search {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-search:hover {
            color: #1f2937;
        }

        .search-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .search-filter {
            margin-bottom: 15px;
        }

        .search-filter label {
            display: flex;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
            color: #374151;
            font-size: 14px;
        }

        .search-filter input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #6b46c1;
        }

        .filter-inputs {
            display: none;
            margin-left: 30px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .filter-inputs.active {
            display: block;
        }

        .filter-input-group {
            margin-bottom: 12px;
        }

        .filter-input-group:last-child {
            margin-bottom: 0;
        }

        .filter-input-group label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
            font-weight: 500;
            padding: 0;
        }

        .filter-select-wrapper {
            position: relative;
            width: 100%;
        }

        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .filter-select:hover {
            border-color: #9ca3af;
        }

        .filter-select.active {
            border-color: #6b46c1;
            box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.2);
        }

        .filter-select-arrow {
            width: 12px;
            height: 12px;
            transition: transform 0.2s;
        }

        .filter-select.active .filter-select-arrow {
            transform: rotate(180deg);
        }

        .filter-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .filter-options.active {
            display: block;
        }

        .filter-option {
            padding: 8px 12px;
            font-size: 14px;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            cursor: pointer;
            transition: background-color 0.15s;
        }

        .filter-option:hover {
            background-color: #f6f6f6;
        }

        .filter-option.selected {
            background-color: #4285f4;
            color: white;
        }

        .filter-option.selected:hover {
            background-color: #3367d6;
        }

        .filter-options::-webkit-scrollbar {
            width: 8px;
        }

        .filter-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .filter-options::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .filter-options::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .tags-input-container {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 2px solid #6b46c1;
            border-radius: 4px;
            background: white;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: flex-start;
            cursor: text;
        }

        .tags-input-container:focus-within {
            outline: none;
            border-color: #6b46c1;
            box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.2);
        }

        .tags-input-container.hidden {
            display: none;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background: #e9d5ff;
            color: #6b21a8;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 13px;
            gap: 6px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: #6b21a8;
            cursor: pointer;
            padding: 0;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }

        .tag-remove:hover {
            color: #581c87;
        }

        .tags-input-container input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 120px;
            padding: 4px;
            font-size: 14px;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .tags-input-container input::placeholder {
            color: #9ca3af;
        }

        .search-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
        }

        .search-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .search-btn:hover {
            background: #4338ca;
        }

        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 199;
            display: none;
        }

        .search-overlay.active {
            display: block;
        }
        
        /* Day View Styles - Modified for Employee Rows with Single Scroll */
        .day-view { display: none; }
        .day-view.active { display: block; }
        
        .day-view-container {
            display: flex;
            flex-direction: column;
            height: 87vh;
        }
        
        .day-header-row {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            z-index: 30;
        }
        
        .employee-header {
            flex: 0 0 150px;
            min-width: 12.5%;
            padding: 12px 15px;
            text-align: center;
            font-size: 15px;
            color: #000;
            font-weight: bolder;
            border-right: 2px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .hour-header-container {
            flex: 1;
            overflow: hidden;
        }
        
        .hour-header {
            display: flex;
            min-width: 2400px;
        }
        
        .hour-label {
            flex: 0 0 100px;
            min-width: 100px;
            padding: 12px 8px;
            text-align: center;
            font-size: 15px;
            color: #000;
            font-weight: bolder;
            border-right: 1px solid #e5e7eb;
        }
        
        .day-body {
            display: flex;
            flex: 1;
            /* overflow: hidden; */
        }
        
        .employee-column {
            flex: 0 0 150px;
            min-width: 12.5%;
            border-right: 2px solid #e5e7eb;
            background: #f9fafb;
            /* overflow: hidden; */
        }
        
        .employee-row {
            display: flex;
            align-items: start;
            justify-content: start;
            border-bottom: 1px solid #e5e7eb;
            padding: 1px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            text-align: center;
        }
        
        .calendar-scroll-wrapper { 
            flex: 1;
            overflow: auto;
            overflow-y: hidden; /* ❗IMPORTANT */

        }
        .hour-header-container {
    cursor: grab;
}

.hour-header-container.grabbing {
    cursor: grabbing;
    user-select: none;
}        
        .calendar-rows {
            min-width: 2400px;
        }
        
        .employee-calendar-row {
            position: relative;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calendar-grid {
            display: flex;
            position: relative;
            height: 100%;
        }
        
        .hour-column {
            flex: 0 0 100px;
            min-width: 100px;
            border-right: 1px solid #e5e7eb;
            position: relative;
            height: 100%;
            /* min-height: 100vh; */
             display: flex;
    flex-direction: column;
        }
        
        .hour-column-inner {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            pointer-events: none;
            height: 100%;
        }
        
        .quarter-line { 
            border-right: 1px dotted #d1d5db; 
        }
        
        .quarter-line:last-child { 
            border-right: none; 
        }
        
        .quarter-slot {
            position: absolute;
            top: 0; 
            bottom: 0;
            padding: 2px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            pointer-events: auto;
        }
        
        .quarter-slot[data-quarter="0"] { left: 0; width: 25%; }
        .quarter-slot[data-quarter="1"] { left: 25%; width: 25%; }
        .quarter-slot[data-quarter="2"] { left: 50%; width: 25%; }
        .quarter-slot[data-quarter="3"] { left: 75%; width: 25%; }
        
        .events-container {
            position: absolute;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Week View Styles - MODIFIED FOR EMPLOYEES */
        .week-view { display: none; }
        .week-view.active { display: block; }
        
        .week-view-container {
            display: flex;
            flex-direction: column;
            height: 87vh;
        }
        
        /* Week header with days */
        .week-header-row {
            position: sticky;
            top: 0;
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            z-index: 100;
        }
        
        .week-employee-header {
            flex: 0 0 150px;
            min-width: 12.5%;
            padding: 12px 15px;
            text-align: center;
            font-size: 15px;
            color: #000;
            font-weight: bolder;
            border-right: 2px solid #e5e7eb;
            background: #f9fafb;
        }

        
        .employee-header, .employee-column {
    flex: 0 0 150px;
    /* Remove min-width: 12.5% if you want a fixed 150px sidebar */
    /* Or keep it if you want the sidebar itself to be responsive */
    border-right: 2px solid #e5e7eb;
    background: #f9fafb;
}

  

        
        
        /* .week-days-container {
            flex: 1;
            overflow: hidden;
        } */
        
        .week-days-header {
            display: flex;
            width: 100%;
        }
        
        .week-day-header {
    flex: 1; /* This ensures all 7 columns share equal space and fill the container */
    min-width: 100px; /* Provides a minimum size for responsiveness */
    padding: 12px 8px;
    text-align: center;
    border-right: 1px solid #e5e7eb;
    background: #f9fafb;
}
        
        .week-day-header:last-child {
            border-right: none;
        }
        
        .week-day-header.today {
            background: #dbeafe;
        }
        
        .week-day-name {
            font-size: 12px;
            font-weight: bolder;
            color: black;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .week-day-date {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .week-day-header.today .week-day-date {
            color: #1e40af;
            font-weight: 700;
        }
        
        /* Week body */
        .week-body {
            display: flex;
            flex: 1;
            /* overflow: hidden; */
        }
        
        .week-employee-column {
            flex: 0 0 150px;
            /* min-width: 12.5%;
            border-right: 2px solid #e5e7eb; */
            background: #f9fafb;
            /* overflow: hidden; */
        }
        
        .week-employee-row {
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #e5e7eb;
            padding: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            text-align: center;
        }
        
        .week-scroll-wrapper {
                display: block;  
                overflow-y: auto;
                overflow-x: auto;
                flex: 1;
                position: relative;
        }
        
        .week-calendar-rows {
           flex:1;
        }

        .week-employee-calendar-row {
            position: relative;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
        }
        
        .week-day-column {
            flex:1;
min-width: 100px;
            border-right: 1px solid #e5e7eb;
            position: relative;
        }
        
        .week-day-column:last-child {
            border-right: none;
        }
        
        .week-day-column:hover {
            background: #f9fafb;
        }
        
        .week-hour-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 5;
        }
        
        .week-hour-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 0;
            border-top: 1px solid #e0e0e0;
        }
        
        .week-hour-line.major {
            border-top: 1px solid #d1d5db;
        }
        
        .week-events-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Resize handles */
        .event .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            z-index: 30;
            cursor: ew-resize;
        }

        .event .resize-handle.left {
            left: 0;
        }

        .event .resize-handle.right {
            right: 0;
        }

        /* While resizing, disable drag */
        .event.resizing {
            cursor: ew-resize;
            opacity: 0.7;
        }

        /* Event Styles - Modified for stacking */
        .event {
            position: absolute;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 4px;
            padding: 4px 6px;
            color: white;
            font-size: 10px;
            cursor: move;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            user-select: none;
            pointer-events: auto;
            /* overflow: hidden; */
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .event.dragging {
            opacity: 0.5;
        }
        
        /* Disable pointer events on all OTHER events when dragging (not the dragged one) */
        body.dragging-active .event:not(.dragging) {
            pointer-events: none;
        }
        
        .event:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 20;
        }
        .event-title {
            font-weight: 600;
            margin-bottom: 1px;
            white-space: nowrap;
            /* overflow: hidden; */
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        .event-time {
            font-size: 9px;
            opacity: 0.9;
            line-height: 1.2;
        }
        .drop-highlight { background-color: rgba(99, 102, 241, 0.15) !important; }
        .week-employee-header, .week-employee-column {
    flex: 0 0 150px;
    /* Remove min-width: 12.5% if you want a fixed 150px sidebar */
    /* Or keep it if you want the sidebar itself to be responsive */
    border-right: 2px solid #e5e7eb;
    background: #f9fafb;
}

/* 1. Force the sidebar widths to be identical and use border-box */
.week-employee-header, .week-employee-column {
    flex: 0 0 150px !important;
    width: 150px !important;
    min-width: 150px !important;
    max-width: 150px !important;
    border-right: 2px solid #e5e7eb;
    box-sizing: border-box;
}

/* 2. Important: Add a "gutter" to the header to account for the scrollbar width */
.week-days-container {
    flex: 1;
    overflow-y: scroll; /* Force a scrollbar area */
    scrollbar-color: transparent transparent; /* Make it invisible */
}

/* For Chrome/Safari/Edge to hide that ghost scrollbar in the header */
.week-days-container::-webkit-scrollbar {
    width: 12px; /* Match this to your system scrollbar width if possible, or use a standard 12-16px */
    background: transparent;
}

/* 3. Ensure the columns use a shared flex logic */
.week-days-header, .week-employee-calendar-row {
    display: flex;
    width: 100%;
}

.week-day-header, .week-day-column {
    flex: 1 1 0; /* Ensure they all grow and shrink from 0 equally */
    min-width: 0; /* Allow columns to shrink below content size */
    box-sizing: border-box;
}

.event-edit {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    cursor: pointer;
    opacity: 0.85;
    z-index: 40;
}

.event-edit:hover {
    opacity: 1;
}
/* ===== GLOBAL LOADING OVERLAY ===== */
#loadingOverlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Spinner */
.loader {
    width: 48px;
    height: 48px;
    border: 4px solid #e5e7eb;
    border-top-color: #4f46e5;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
}

.loading-text {
    margin-top: 12px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Hide helper */
#loadingOverlay.hidden {
    display: none;
}
.event.status-Not_Started {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
}
.event.status-Missed {
    background: linear-gradient(135deg, #ef4444, #b91c1c);
}

.event.status-Completed {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.employee-header-controls {
    display: flex;
    align-items: center;
    gap: 2px;
    position: relative;
    padding: 0;
}

.employee-header-controls input {
    flex: 1;
    min-width: 0; /* IMPORTANT: prevents overflow in flex containers */

    padding: 7px 10px;
    font-size: 12.5px;
    font-weight: 500;

    color: #111827;
    background: #ffffff;

    border: none;
    border-bottom: 2px solid #e5e7eb;
    border-radius: 0;

    outline: none;
    transition: 
        border-color 0.2s ease,
        background-color 0.2s ease;
}

.employee-header-controls input::placeholder {
    color: #9ca3af;
    font-weight: 400;
}

/* Focus state */
.employee-header-controls input:focus {
    border-bottom-color: #4f46e5; /* Indigo */
    background-color: #f9fafb;
}

/* Hover (subtle, not noisy) */
.employee-header-controls input:hover:not(:focus) {
    border-bottom-color: #c7d2fe;
}

.employee-add-btn {
    width: 28px;
    height: 28px;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
}

.employee-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    padding: 6px;
    z-index: 200;
    display: none;
}

.employee-dropdown.active {
    display: block;
}

.employee-dropdown input {
    width: 100%;
    padding: 6px;
    margin-bottom: 6px;
    font-size: 12px;
}

.employee-dropdown-list {
    max-height: 180px;
    overflow-y: auto;
}

.employee-dropdown-item {
    padding: 6px;
    font-size: 13px;
    cursor: pointer;
    border-radius: 4px;
}

.employee-dropdown-item:hover {
    background: #eef2ff;
}
    </style>
</head>
<body>
    <div id="loadingOverlay">
    <div class="loader"></div>
    <div class="loading-text">Loading calendar…</div>
</div>
    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay" onclick="toggleSearch()"></div>

    <!-- Search Panel -->
    <div class="search-panel" id="searchPanel">
        <div class="search-header">
            <h2>Search</h2>
            <button class="close-search" onclick="toggleSearch()">×</button>
        </div>
        
        <div class="search-body">
    <!-- 1. Persons Filter (Restored) -->
    <div class="search-filter">
        <label>
            <input type="checkbox" name="persons" onchange="toggleFilterInputs('persons')">
            Persons
        </label>
        <div class="filter-inputs" id="persons-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="persons-filter-display" onclick="toggleFilterDropdown('persons')">
                        <span id="persons-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="persons-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('persons', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="persons-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="persons-tags-group">
                <div class="tags-input-container" id="persons-tags-container" onclick="focusTagInput('persons')">
                    <input type="text" id="persons-tags-input" placeholder="" onkeydown="handleTagInput(event, 'persons')">
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Advanced From Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="from" onchange="toggleFilterInputs('from')"> From</label>
        <div class="filter-inputs" id="from-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="from-filter-display" onclick="toggleFilterDropdown('from')">
                        <span id="from-filter-text">Is</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="from-filter-options">
                        <div class="filter-option-header">Basic</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'isNotEmpty', this)">Is Not Empty</div>
                        <div class="filter-option-header">Comparison</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'gtDate', this)">Is greater than specific date</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'ltDate', this)">Is lesser than specific date</div>
                        <div class="filter-option-header">Dynamic "n" Based</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'gtNDays', this)">Is > n days from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'gtNMonths', this)">Is > n months from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'gtNYears', this)">Is > n years from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'ltNDays', this)">Is < n days from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'ltNMonths', this)">Is < n months from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'ltNYears', this)">Is < n years from today</div>
                        <div class="filter-option-header">Relative</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'today', this)">Today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'yesterday', this)">Yesterday</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'tomorrow', this)">Tomorrow</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'thisWeek', this)">This Week</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'lastWeek', this)">Last Week</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'nextWeek', this)">Next Week</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'thisMonth', this)">This Month</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'lastMonth', this)">Last Month</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'nextMonth', this)">Next Month</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'thisYear', this)">This Year</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'lastYear', this)">Last Year</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'nextYear', this)">Next Year</div>
                        <div class="filter-option-header">Rolling</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'last7', this)">Last 7 Days</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'last30', this)">Last 30 Days</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'last60', this)">Last 60 Days</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'last90', this)">Last 90 Days</div>
                    </div>
                    <input type="hidden" id="from-filter" value="is">
                </div>
            </div>
            <div class="filter-input-group date-input-container" id="from-date-group" style="display:none;"><input type="date" id="from-date-val" class="filter-date-input"></div>
            <div class="filter-input-group n-input-container" id="from-n-group" style="display:none;"><label>Enter "n" value:</label><input type="number" id="from-n-val" class="filter-n-input" value="1" min="1"></div>
        </div>
    </div>

    <!-- 3. Advanced To Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="to" onchange="toggleFilterInputs('to')"> To</label>
        <div class="filter-inputs" id="to-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="to-filter-display" onclick="toggleFilterDropdown('to')">
                        <span id="to-filter-text">Is</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="to-filter-options">
                        <div class="filter-option-header">Basic</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'isNotEmpty', this)">Is Not Empty</div>
                        <div class="filter-option-header">Comparison</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'gtDate', this)">Is greater than specific date</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'ltDate', this)">Is lesser than specific date</div>
                        <div class="filter-option-header">Dynamic "n" Based</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'gtNDays', this)">Is > n days from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'gtNMonths', this)">Is > n months from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'gtNYears', this)">Is > n years from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'ltNDays', this)">Is < n days from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'ltNMonths', this)">Is < n months from today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'ltNYears', this)">Is < n years from today</div>
                        <div class="filter-option-header">Relative</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'today', this)">Today</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'yesterday', this)">Yesterday</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'tomorrow', this)">Tomorrow</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'thisWeek', this)">This Week</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'lastWeek', this)">Last Week</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'nextWeek', this)">Next Week</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'thisMonth', this)">This Month</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'lastMonth', this)">Last Month</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'nextMonth', this)">Next Month</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'thisYear', this)">This Year</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'lastYear', this)">Last Year</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'nextYear', this)">Next Year</div>
                        <div class="filter-option-header">Rolling</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'last7', this)">Last 7 Days</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'last30', this)">Last 30 Days</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'last60', this)">Last 60 Days</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'last90', this)">Last 90 Days</div>
                    </div>
                    <input type="hidden" id="to-filter" value="is">
                </div>
            </div>
            <div class="filter-input-group date-input-container" id="to-date-group" style="display:none;"><input type="date" id="to-date-val" class="filter-date-input"></div>
            <div class="filter-input-group n-input-container" id="to-n-group" style="display:none;"><label>Enter "n" value:</label><input type="number" id="to-n-val" class="filter-n-input" value="1" min="1"></div>
        </div>
    </div>

    <!-- 4. Type Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="type" onchange="toggleFilterInputs('type')"> Type</label>
        <div class="filter-inputs" id="type-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="type-filter-display" onclick="toggleFilterDropdown('type')">
                        <span id="type-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="type-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('type', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('type', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('type', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('type', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('type', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="type-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="type-tags-group">
                <div class="tags-input-container" id="type-tags-container" onclick="focusTagInput('type')">
                    <input type="text" id="type-tags-input" onkeydown="handleTagInput(event, 'type')">
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Service Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="service" onchange="toggleFilterInputs('service')"> Service</label>
        <div class="filter-inputs" id="service-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="service-filter-display" onclick="toggleFilterDropdown('service')">
                        <span id="service-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="service-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('service', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="service-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="service-tags-group">
                <div class="tags-input-container" id="service-tags-container" onclick="focusTagInput('service')">
                    <input type="text" id="service-tags-input" onkeydown="handleTagInput(event, 'service')">
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Staff Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="staff" onchange="toggleFilterInputs('staff')"> Staff</label>
        <div class="filter-inputs" id="staff-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="staff-filter-display" onclick="toggleFilterDropdown('staff')">
                        <span id="staff-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="staff-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('staff', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="staff-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="staff-tags-group">
                <div class="tags-input-container" id="staff-tags-container" onclick="focusTagInput('staff')">
                    <input type="text" id="staff-tags-input" onkeydown="handleTagInput(event, 'staff')">
                </div>
            </div>
        </div>
    </div>

    <!-- 7. Activity Type Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="activityType" onchange="toggleFilterInputs('activityType')"> Activity Type</label>
        <div class="filter-inputs" id="activityType-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="activityType-filter-display" onclick="toggleFilterDropdown('activityType')">
                        <span id="activityType-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="activityType-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('activityType', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('activityType', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('activityType', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('activityType', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('activityType', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="activityType-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="activityType-tags-group">
                <div class="tags-input-container" id="activityType-tags-container" onclick="focusTagInput('activityType')">
                    <input type="text" id="activityType-tags-input" onkeydown="handleTagInput(event, 'activityType')">
                </div>
            </div>
        </div>
    </div>

    <!-- 8. Location Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="location" onchange="toggleFilterInputs('location')"> Location</label>
        <div class="filter-inputs" id="location-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="location-filter-display" onclick="toggleFilterDropdown('location')">
                        <span id="location-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="location-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('location', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('location', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('location', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('location', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('location', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="location-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="location-tags-group">
                <div class="tags-input-container" id="location-tags-container" onclick="focusTagInput('location')">
                    <input type="text" id="location-tags-input" onkeydown="handleTagInput(event, 'location')">
                </div>
            </div>
        </div>
    </div>

    <!-- 9. Activity Notes Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="activityNotes" onchange="toggleFilterInputs('activityNotes')"> Activity Notes</label>
        <div class="filter-inputs" id="activityNotes-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="activityNotes-filter-display" onclick="toggleFilterDropdown('activityNotes')">
                        <span id="activityNotes-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="activityNotes-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('activityNotes', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('activityNotes', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('activityNotes', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('activityNotes', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('activityNotes', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="activityNotes-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="activityNotes-tags-group">
                <div class="tags-input-container" id="activityNotes-tags-container" onclick="focusTagInput('activityNotes')">
                    <input type="text" id="activityNotes-tags-input" onkeydown="handleTagInput(event, 'activityNotes')">
                </div>
            </div>
        </div>
    </div>

    <!-- 10. Health Appointment Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="healthAppointment" onchange="toggleFilterInputs('healthAppointment')"> Health Appointment</label>
        <div class="filter-inputs" id="healthAppointment-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="healthAppointment-filter-display" onclick="toggleFilterDropdown('healthAppointment')">
                        <span id="healthAppointment-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="healthAppointment-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('healthAppointment', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('healthAppointment', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('healthAppointment', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('healthAppointment', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('healthAppointment', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="healthAppointment-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="healthAppointment-tags-group">
                <div class="tags-input-container" id="healthAppointment-tags-container" onclick="focusTagInput('healthAppointment')">
                    <input type="text" id="healthAppointment-tags-input" onkeydown="handleTagInput(event, 'healthAppointment')">
                </div>
            </div>
        </div>
    </div>
</div>
        
        <div class="search-footer">
            <button class="search-btn" onclick="performSearch()">Search</button>
        </div>
    </div>

    <div class="calendar-container">
        
        <div class="calendar-header">
            <div class="view-toggle">
                <button id="weekViewBtn" onclick="switchView('week')">Week</button>
                <button id="dayViewBtn" class="active" onclick="switchView('day')">Day</button>

                <div class="search-filters-section" id="searchFiltersSection">
            <div class="search-filters-container" id="searchFiltersContainer">
                <span class="search-label">🔍</span>
            </div>
        </div>
            </div>
            <!-- Search Filters Display Section -->
        

            <div class="date-title" id="dateTitle"></div>
            <div class="header-controls">
                <button class="nav-btn" onclick="navigatePeriod(-1)"><i class="fa fa-angle-left"></i></button>
                <button class="nav-btn" onclick="navigatePeriod(1)"><i class="fa fa-angle-right"></i></button>
                <button class="nav-btn" onclick="goToday()">Today</button>
                <button class="calendar-icon" onclick="toggleSearch()"><i class="fa fa-search fa-lg"></i></button>
                <button class="calendar-icon" onclick="toggleMiniCalendar()"><i class="fa fa-calendar fa-lg"></i></button>
            </div>
        </div>

        
        <div class="mini-calendar" id="miniCalendar">
            <div class="mini-header">
                <span id="miniMonthYear">JANUARY 2026</span>
                <div class="mini-nav">
                    <button class="nav-btn" onclick="changeMiniMonth(-1)">‹</button>
                    <button class="nav-btn" onclick="changeMiniMonth(1)">›</button>
                </div>
            </div>
            <div class="mini-grid" id="miniGrid">
                <div class="mini-day-label">Su</div>
                <div class="mini-day-label">Mo</div>
                <div class="mini-day-label">Tu</div>
                <div class="mini-day-label">We</div>
                <div class="mini-day-label">Th</div>
                <div class="mini-day-label">Fr</div>
                <div class="mini-day-label">Sa</div>
            </div>
        </div>

        <!-- Day View with Employee Rows -->
        <div class="day-view active" id="dayView">
            <div class="day-view-container">
                        <div class="calendar-body-scrollable">

                <div class="day-header-row sticky-header">
                    <div class="employee-header employee-header-controls">
    <input 
        type="text" 
        id="employeeSearchInput" 
        placeholder="Search staff"
        oninput="filterEmployees(this.value)"
    />

    <button class="employee-add-btn" onclick="toggleEmployeeDropdown(event)">+</button>

    <div class="employee-dropdown" id="employeeDropdown">
        <input 
            type="text" 
            placeholder="Add staff"
            oninput="filterDropdownEmployees(this.value)"
        />
        <div class="employee-dropdown-list" id="employeeDropdownList"></div>
    </div>
</div>
                    <div class="hour-header-container">
                        <div class="hour-header" id="hourHeader"></div>
                    </div>
                </div>
                <div class="day-body">
                    <div class="employee-column" id="employeeColumn"></div>
                    <div class="calendar-scroll-wrapper" id="calendarScrollWrapper">
                        <div class="calendar-rows" id="calendarRows"></div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Week View with Employee Rows -->
        <!-- <div class="week-view" id="weekView">
            <div class="week-view-container">
                <div class="week-header-row">
                    <div class="week-employee-header">Employee</div>
                    <div class="week-days-container">
                        <div class="week-days-header" id="weekDaysHeader"></div>
                    </div>
                </div>
                <div class="week-body">
                    <div class="week-employee-column" id="weekEmployeeColumn"></div>
                    <div class="week-scroll-wrapper" id="weekScrollWrapper">
                        <div class="week-calendar-rows" id="weekCalendarRows"></div>
                    </div>
                </div>
            </div>
        </div> -->
    <!-- Week View with Employee Rows -->
        <div class="week-view" id="weekView">
            <div class="week-view-container">
    <div class="week-scroll-wrapper" id="weekScrollWrapper">
 
        <!-- STICKY HEADER INSIDE SCROLL -->
        <div class="week-header-row sticky-header">
            <div class="week-employee-header">Employee</div>
            <div class="week-days-container">
                <div class="week-days-header" id="weekDaysHeader"></div>
            </div>
        </div>
 
        <!-- SCROLLING BODY -->
        <div class="week-body">
            <div class="week-employee-column" id="weekEmployeeColumn"></div>
            <div class="week-calendar-rows" id="weekCalendarRows"></div>
        </div>
 
    </div>
</div>
 
        </div>    
    
    </div>
    </div>

    <script>

let mouseDownX = 0;
let mouseDownY = 0;
const CLICK_TOLERANCE = 5;
            // const DEFAULT_DAY_START_HOUR = 6;

        const EMPTY_GRID_HEIGHT = 120;

        const MIN_RESIZE_MINUTES = 15;
        const PIXELS_PER_HOUR = 100;
        const DEFAULT_DAY_START_HOUR = 6;
                scrollLeft = 6 * PIXELS_PER_HOUR;

        const PIXELS_PER_15_MIN = PIXELS_PER_HOUR / 4;
        const MIN_ROW_HEIGHT = 28;  

        const CALENDAR_BODY_SELECTOR = '.calendar-body-scrollable';


        const EVENT_HEIGHT = 30;
        const EVENT_GAP = 4;
        const ROW_PADDING = 6;

        let currentDate = new Date();
        let todayDate = new Date();
        let draggedElement = null;
        let draggedEventId = null;
        let draggedEventData = null;
        let currentView = 'day';

        let resizeEvent = null;
        let resizeDirection = null;
        let resizeStartX = 0;
        let originalStart = 0;
        let originalEnd = 0;

        let loginUser = null;
        let userService = null;
        let services = [];

        function showLoader() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('hidden');
}

function hideLoader() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.add('hidden');
}


       async function getZohoData() {
            let initparam = await ZOHO.CREATOR.UTIL.getInitParams();
            loginUser = initparam.loginUser;
           var get_service = {
                app_name: "thg-sandbox",
                report_name: "Sites_Access_Details_Report",
                criteria: "(Staff_Email.contains(\"" + loginUser + "\"))"
            };
            

            let service_resp = await ZOHO.CREATOR.DATA.getRecords(get_service);
            

           if (service_resp.code === 3000) {
                service_resp.data.forEach(function (rec) {
                    
                    services.push(rec.ID); 
                });
            }
          await getBookings();
           
        }
        async function getBookingsForWeek(){
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            let zoho_start_date = formatDateDDMMYYYY( weekStart );
            let zoho_end_date = formatDateDDMMYYYY( weekEnd );
            console.log(zoho_start_date,zoho_end_date);
            
            employees.length = 0;  
            employees.push('');
            console.log(services);
            const serviceList = `[${services.join(",")}]`;
            const criteria_2 = `Site_Name.ID == ${serviceList} && Date_field1 >= '${zoho_start_date}' && Date_field1 <= '${zoho_end_date}'`;
            console.log(criteria_2);
            
            var booking = {
                app_name: "thg-sandbox",
                report_name: "Bookings_Backend",
                criteria: criteria_2
            };
           
            booking_resp = await ZOHO.CREATOR.DATA.getRecords(booking);
            
            eventDatabase = {};
                booking_resp.data.forEach(function (rec) {
                    let date_booking = [];
                    if( rec.Care_Providers.length === 0 ){
                        let cur_book = {};
                        cur_book.id = Number(rec.ID);
                        cur_book.zoho_id = BigInt(rec.ID);
                        cur_book.title = rec.Care_Service_User.zc_display_value;
                        cur_book.date = rec.Date_field1;
                        const [, stime] = rec.From_Date_Time.split(" "); 
                        const [shours, sminutes] = stime.split(":").map(Number);
                        cur_book.startMinutes = shours * 60 + sminutes;
                        
                        const [, etime] = rec.To_Date_Time.split(" "); 
                        const [ehours, eminutes] = etime.split(":").map(Number);
                        cur_book.endMinutes = ehours * 60 + eminutes;
                        cur_book.employee = '';
                        if( rec.Status === "Missed" ){
                            cur_book.status = "Missed";
                        }
                        else if( rec.Status === "Completed" ){
                            cur_book.status = "Completed";
                        }
                        else{
                            cur_book.status = "Not_Started";
                        }
                        date_booking.push(cur_book); 
                    }
                    
                    rec.Care_Providers.forEach(function (emp) {
                       let cur_book = {};
                       cur_book.id = Number(rec.ID);
                       cur_book.zoho_id = BigInt(rec.ID);
                       cur_book.date = rec.Date_field1;
                       cur_book.title = rec.Care_Service_User.zc_display_value;
                        const [, stime] = rec.From_Date_Time.split(" "); 
                        const [shours, sminutes] = stime.split(":").map(Number);
                        cur_book.startMinutes = shours * 60 + sminutes;
                        
                        const [, etime] = rec.To_Date_Time.split(" "); 
                        const [ehours, eminutes] = etime.split(":").map(Number);
                        cur_book.endMinutes = ehours * 60 + eminutes;
                        cur_book.employee = emp.zc_display_value;
                        if( rec.Status === "Missed" ){
                            cur_book.status = "Missed";
                        }
                        else if( rec.Status === "Completed" ){
                            cur_book.status = "Completed";
                        }
                        else{
                            cur_book.status = "Not_Started";
                        }
                        date_booking.push(cur_book);
                        if( !employees.includes( emp.zc_display_value ) ){
                            employees.push(emp.zc_display_value);
                        }
                    });
                    
                    const key = toYYYYMMDD( rec.Date_field1 );            
                    if (!eventDatabase[key]) {
                        eventDatabase[key] = [];
                    }
                    eventDatabase[key].push(...date_booking);  
                });
            }
        function toYYYYMMDD(ddmmyyyy) {
            const [dd, mm, yyyy] = ddmmyyyy.split('-');
            return `${yyyy}-${mm}-${dd}`;
        }
        (function enableHeaderGrabScroll() {
    const header = document.querySelector('.hour-header-container');
    const scroller = document.getElementById('calendarScrollWrapper');

    if (!header || !scroller) return;

    let isDown = false;
    let startX;
    let startScrollLeft;

    header.addEventListener('mousedown', (e) => {
        isDown = true;
        header.classList.add('grabbing');
        startX = e.pageX;
        startScrollLeft = scroller.scrollLeft;
    });

    document.addEventListener('mouseup', () => {
        if (!isDown) return;
        isDown = false;
        header.classList.remove('grabbing');
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDown) return;

        e.preventDefault();
        const deltaX = e.pageX - startX;
        scroller.scrollLeft = startScrollLeft - deltaX;
    });
})();


        async function getBookings() { 
            employees.length = 0;  
            employees.push('');
            const serviceList = `[${services.join(",")}]`;
            let cur_date = formatDateDDMMYYYY( currentDate );
            const criteria_1 = `Site_Name.ID == ${serviceList} && Date_field1 == '${cur_date}'`;
            var booking = {
                app_name: "thg-sandbox",
                report_name: "Bookings_Backend",
                criteria: criteria_1
            };
            try {
                booking_resp = await ZOHO.CREATOR.DATA.getRecords(booking);
            } catch (err) {
                console.error("Creator error:", err);
                return; 
            }
            try{
            if( booking_resp.status === 400 ){
               
            }
            else if( booking_resp.code === 3000 ) {
                let date_booking = [];
                booking_resp.data.forEach(function (rec) {
                    if( rec.Care_Providers.length === 0 ){
                        let cur_book = {};
                        cur_book.id = Number(rec.ID);
                        cur_book.title = rec.Care_Service_User.zc_display_value;
                        cur_book.date = rec.Date_field1;
                        const [, stime] = rec.From_Date_Time.split(" "); 
                        const [shours, sminutes] = stime.split(":").map(Number);
                        cur_book.startMinutes = shours * 60 + sminutes;
                        
                        const [, etime] = rec.To_Date_Time.split(" "); 
                        const [ehours, eminutes] = etime.split(":").map(Number);
                        cur_book.endMinutes = ehours * 60 + eminutes;
                        cur_book.employee = '';
                        if( rec.Status === "Missed" ){
                            cur_book.status = "Missed";
                        }
                        else if( rec.Status === "Completed" ){
                            cur_book.status = "Completed";
                        }
                        else{
                            cur_book.status = "Not_Started";
                        }
                        date_booking.push(cur_book); 
                    }
                    
                    rec.Care_Providers.forEach(function (emp) {
                       let cur_book = {};
                       cur_book.id = Number(rec.ID);
                       cur_book.date = rec.Date_field1;
                       cur_book.title = rec.Care_Service_User.zc_display_value;
                        const [, stime] = rec.From_Date_Time.split(" "); 
                        const [shours, sminutes] = stime.split(":").map(Number);
                        cur_book.startMinutes = shours * 60 + sminutes;
                        
                        const [, etime] = rec.To_Date_Time.split(" "); 
                        const [ehours, eminutes] = etime.split(":").map(Number);
                        cur_book.endMinutes = ehours * 60 + eminutes;
                        cur_book.employee = emp.zc_display_value;
                        if( rec.Status === "Missed" ){
                            cur_book.status = "Missed";
                        }
                        else if( rec.Status === "Completed" ){
                            cur_book.status = "Completed";
                        }
                        else{
                            cur_book.status = "Not_Started";
                        }
                        date_booking.push(cur_book);
                        if( !employees.includes( emp.zc_display_value ) ){
                            employees.push(emp.zc_display_value);
                        }
                    });
                });
                const key = formatDateYYYYMMDD(currentDate);

if (!eventDatabase[key]) {
    eventDatabase[key] = [];
}
 eventDatabase[key] = [];
eventDatabase[key].push(...date_booking);            
            } else {
                console.log("No bookings found or error in fetching bookings.");
            }}
            catch(err){
                console.log(err);
            }
        }

        function formatDateYYYYMMDD(date) {    
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function formatDateDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, "0");
            const month = String(date.getMonth() + 1).padStart(2, "0"); // months are 0-based
            const year = date.getFullYear();

            return `${day}-${month}-${year}`;
        }


        function calculateFillHeight() {
    // Select the container based on which view is currently active
    const selector = (currentView === 'day') ? '.calendar-body-scrollable' : '.week-view-container';
    const container = document.querySelector(selector);
    
    if (!container) return MIN_ROW_HEIGHT;
    
    // Header heights (Day header vs Week header)
    const headerHeight = (currentView === 'day') ? 45 : 55; 
    const availableHeight = container.clientHeight - headerHeight;
    
    const count = employees.length > 0 ? employees.length : 1;
    const fillHeight = availableHeight / count;
    
    return Math.max(MIN_ROW_HEIGHT, fillHeight);
}

        function startResize(e, evt, direction) {
            resizeEvent = evt;
            resizeDirection = direction;
            resizeStartX = e.clientX;
            originalStart = evt.startMinutes;
            originalEnd = evt.endMinutes;

            const eventEl = e.target.closest('.event');
            eventEl.classList.add('resizing');
            eventEl.draggable = false;

            document.body.style.cursor = 'ew-resize';
            document.body.style.userSelect = 'none';

            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('mouseup', stopResize);
        }

        function onResizeMove(e) {
            if (!resizeEvent) return;

            const deltaX = e.clientX - resizeStartX;
            const minutesDelta = Math.round(deltaX / PIXELS_PER_15_MIN) * 15;

            if (resizeDirection === 'right') {
                const newEnd = originalEnd + minutesDelta;
                if (newEnd - resizeEvent.startMinutes >= MIN_RESIZE_MINUTES) {
                    resizeEvent.endMinutes = newEnd;
                }
            } else {
                const newStart = originalStart + minutesDelta;
                if (resizeEvent.endMinutes - newStart >= MIN_RESIZE_MINUTES) {
                    resizeEvent.startMinutes = newStart;
                }
            }

            if (currentView === 'day') {
                renderDayView();
            } else {
                renderWeekView();
            }
        }

        function stopResize() {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';

            document.querySelectorAll('.event.resizing').forEach(el => {
                el.classList.remove('resizing');
                el.draggable = true;
            });

            document.removeEventListener('mousemove', onResizeMove);
            document.removeEventListener('mouseup', stopResize);

            resizeEvent = null;
            resizeDirection = null;
        }
       
        let appliedFilters = [];
        
        const filterTags = {
            eType: [],
            persons: [],
            from: [],
            to: [],
            type: [],
            service: [],
            staff: [],
            activityType: [],
            location: [],
            activityNotes: [],
            healthAppointment: []
        };
        
        const filterValues = {
            employee: 'contains'
        };
        
        const fieldDisplayNames = {
            employee: 'Employee'
        };
        
        const MAX_TAGS = 6;
        
        // const employees = ['John Smith', 'Sarah Johnson', 'Mike Wilson', 'Emily Davis', 'David Brown', 'Arun', 'Kamalam', 'Surya', 'Mugil', 'Nirmal', 'Sofia', 'Shiva'];
        const employees=[];
        const initialEventDatabase = {
            '2026-01-07': [
                { id: 1, title: 'Team Meeting', startMinutes: 540, endMinutes: 630, employee: 'Sophia Roome' },
                { id: 2, title: 'Project Review', startMinutes: 600, endMinutes: 720, employee: 'Sophia Roome' },
                { id: 3, title: 'Lunch Break', startMinutes: 720, endMinutes: 780, employee: 'Sophie Hallas' },
                { id: 4, title: 'Client Call', startMinutes: 840, endMinutes: 900, employee: 'Sophie Hallas' },
                { id: 5, title: 'Code Review', startMinutes: 870, endMinutes: 960, employee: '' },
                { id: 6, title: 'Documentation', startMinutes: 930, endMinutes: 1020, employee: '' },
                { id: 7, title: 'Documentation', startMinutes: 120, endMinutes: 530, employee: '' },
                { id: 8, title: 'Documentation', startMinutes: 120, endMinutes: 530, employee: '' },
                { id: 9, title: 'Documentation', startMinutes: 120, endMinutes: 530, employee: '' },
            ],
            '2025-12-29': [
                { id: 7, title: 'HARI OM SPARE PARTS', startMinutes: 825, endMinutes: 900, employee: 'Sarah Johnson' }
            ],
            '2026-01-01': [
                { id: 8, title: 'JALAN AUTO AGENCY', startMinutes: 960, endMinutes: 1020, employee: 'Mike Wilson' }
            ]
        };


        ///
        
        let eventDatabase = JSON.parse(JSON.stringify(initialEventDatabase));

        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        //chnage

        function getCurrentDateKey() {
            return getDateKey(currentDate);
        }

        function getCurrentEvents() {
            return eventDatabase[getCurrentDateKey()] || [];
        }

        function getEventsForDate(date) {
            return eventDatabase[getDateKey(date)] || [];
        }
        
        function getEventsForEmployee(employee, dateKey) {
            const allEvents = eventDatabase[dateKey] || [];
            return allEvents.filter(evt => evt.employee === employee);
        }

        async function switchView(view) {
            currentView = view;
            const dayViewBtn = document.getElementById('dayViewBtn');
            const weekViewBtn = document.getElementById('weekViewBtn');
            const dayView = document.getElementById('dayView');
            const weekView = document.getElementById('weekView');
            
            if (view === 'day') {
                await getBookings();
                dayViewBtn.classList.add('active');
                weekViewBtn.classList.remove('active');
                dayView.classList.add('active');
                weekView.classList.remove('active');
                renderDayView();
            } else {
                await getBookingsForWeek();
                weekViewBtn.classList.add('active');
                dayViewBtn.classList.remove('active');
                weekView.classList.add('active');
                dayView.classList.remove('active');
                renderWeekView();
            }
            updateDateTitle();
            
            const miniCal = document.getElementById('miniCalendar');
            if (miniCal.classList.contains('active')) {
                renderMiniCalendar();
            }
        }

         async function navigatePeriod(delta) {
            if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + delta);
                await getBookings();
                renderDayView();
                startAt6();
            } else {
                currentDate.setDate(currentDate.getDate() + (delta * 7));
                renderWeekView();
            }
            updateDateTitle();
        }

        function goToday() {
            currentDate = new Date();
            todayDate = new Date();
            if (currentView === 'day') {
                renderDayView();
            } else {
                renderWeekView();
            }
            updateDateTitle();
        }

        function updateDateTitle() {
            if (currentView === 'day') {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('dateTitle').textContent = currentDate.toLocaleDateString('en-US', options);
            } else {
                const weekStart = new Date(currentDate);
                weekStart.setDate(currentDate.getDate() - currentDate.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const startStr = weekStart.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                const endStr = weekEnd.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                document.getElementById('dateTitle').textContent = `${startStr} – ${endStr}`;
            }
        }

        // DAY VIEW RENDERING
        async function renderDayView() {
            // await getBookings();
            renderHourHeaders();
            renderEmployeeRows();
            console.log("Call");
            syncScroll();
            startAt6();
        }
        function startAt6(){
            const scrollWrapper = document.getElementById('calendarScrollWrapper');
            const startScrollLeft = DEFAULT_DAY_START_HOUR * PIXELS_PER_HOUR;
 
            requestAnimationFrame(() => {
                scrollWrapper.scrollLeft = startScrollLeft;
            });
        }

        function renderHourHeaders() {
            const header = document.getElementById('hourHeader');
            header.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const label = document.createElement('div');
                label.className = 'hour-label';
                const hour = i % 12 || 12;
                const period = i < 12 ? 'am' : 'pm';
                label.textContent = `${hour}${period}`;
                header.appendChild(label);
            }
        }
        
        function renderEmployeeColumn(rowHeightsMap = {}) {
    const column = document.getElementById('employeeColumn');
    column.innerHTML = '';

    // Fallback if no employees
    const displayList = employees.length > 0 ? employees : ['—'];

    displayList.forEach(employee => {
        const row = document.createElement('div');
        row.className = 'employee-row';
        row.textContent = employee === '—' ? "" : employee; // Keep text empty if no employee
        const height = rowHeightsMap[employee] || (employees.length === 0 ? 500 : MIN_ROW_HEIGHT);
        row.style.height = height + 'px';
        column.appendChild(row);
    });
}
        
       let scrollSynced = false;

function syncScroll() {
    console.log("Called");
    
    if (scrollSynced) return; 

    const scrollWrapper = document.getElementById('calendarScrollWrapper');
    const hourHeaderContainer = document.querySelector('.hour-header-container');

    if (!scrollWrapper || !hourHeaderContainer) return;

    scrollWrapper.addEventListener('scroll', () => {
        hourHeaderContainer.scrollLeft = scrollWrapper.scrollLeft;
    });

    scrollSynced = true;
}
        
        function renderEmployeeRows() {
    const rowsContainer = document.getElementById('calendarRows');
    rowsContainer.innerHTML = '';

    const dateKey = getCurrentDateKey();
    const rowHeightsMap = {};
    
    // Calculate how much height each row needs to fill the screen
    const fillHeight = calculateFillHeight();

    const displayList = employees.length >= 0 ? employees : ['—'];   
             
    displayList.forEach(employee => {
        const rawEvents = employee === '—' ? [] : getEventsForEmployee(employee, dateKey);
        const events = detectOverlaps([...rawEvents]);

        const maxConcurrent = events.length ? Math.max(...events.map(e => e.maxConcurrent)) : 1;
        const dynamicHeight = (maxConcurrent * (EVENT_HEIGHT + EVENT_GAP)) + (ROW_PADDING * 2);
        
        // Logic: Take the larger of (Height needed for events) OR (Height needed to fill screen)
        const finalRowHeight = Math.max(fillHeight, dynamicHeight);
        rowHeightsMap[employee] = finalRowHeight;

        const employeeRow = document.createElement('div');
        employeeRow.className = 'employee-calendar-row';
        employeeRow.dataset.employee = employee;
        employeeRow.style.height = finalRowHeight + 'px';

        const grid = document.createElement('div');
        grid.className = 'calendar-grid';

        for (let h = 0; h < 24; h++) {
            const hourCol = document.createElement('div');
            hourCol.className = 'hour-column';
            const innerGrid = document.createElement('div');
            innerGrid.className = 'hour-column-inner';
            for (let i = 0; i < 4; i++) {
                const line = document.createElement('div');
                line.className = 'quarter-line';
                innerGrid.appendChild(line);
            }
            hourCol.appendChild(innerGrid);

            for (let q = 0; q < 4; q++) {
                const slot = document.createElement('div');
                slot.className = 'quarter-slot';
                slot.dataset.hour = h;
                slot.dataset.quarter = q;
                slot.dataset.employee = employee;
                if (employee !== '—') {
                    slot.addEventListener('dragover', handleDayDragOver);
                    slot.addEventListener('drop', handleDayDrop);
                    slot.addEventListener('dragleave', handleDragLeave);
                }
                hourCol.appendChild(slot);
            }
            grid.appendChild(hourCol);
        }

        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'events-container';
        eventsContainer.dataset.employee = employee;
        renderEventsForEmployee(eventsContainer, events);

        grid.appendChild(eventsContainer);
        employeeRow.appendChild(grid);
        rowsContainer.appendChild(employeeRow);
    });

    renderEmployeeColumn(rowHeightsMap);
}

        function renderEventsForEmployee(container, events) {
            const hourWidth = 100;

            events.forEach(evt => {
                const startHour = Math.floor(evt.startMinutes / 60);
                const startMinute = evt.startMinutes % 60;
                const duration = evt.endMinutes - evt.startMinutes;

                const el = document.createElement('div');
                el.className = `event status-${evt.status}`;
                el.draggable = true;

                el.dataset.eventId = evt.id;
                el.dataset.viewType = 'day';
                el.dataset.employee = evt.employee;

                const left = (startHour * hourWidth) + ((startMinute / 60) * hourWidth);
                const width = (duration / 60) * hourWidth;
                const top = ROW_PADDING + (evt.stackLevel * (EVENT_HEIGHT + EVENT_GAP));

                el.style.left = left + 'px';
                el.style.width = width + 'px';
                el.style.top = top + 'px';
                el.style.height = EVENT_HEIGHT + 'px';

                const title = document.createElement('div');
                title.className = 'event-title';
                title.textContent = evt.title;

                // const time = document.createElement('div');
                // time.className = 'event-time';
                // time.textContent = formatTimeRange(evt.startMinutes, evt.endMinutes);

                const leftHandle = document.createElement('div');
                leftHandle.className = 'resize-handle left';
                leftHandle.addEventListener('mousedown', e => {
                    e.preventDefault();   
                    e.stopPropagation();
                    startResize(e, evt, 'left');
                });

                const rightHandle = document.createElement('div');
                rightHandle.className = 'resize-handle right';
                rightHandle.addEventListener('mousedown', e => {
                    e.preventDefault();    
                    e.stopPropagation();
                    startResize(e, evt, 'right');
                });

                el.appendChild(leftHandle);
                el.appendChild(rightHandle);
                el.appendChild(title);

                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);

                el.addEventListener('mousedown', (e) => {
    mouseDownX = e.clientX;
    mouseDownY = e.clientY;
});

el.addEventListener('mouseup', (e) => {
    // Ignore resize handles
    if (e.target.closest('.resize-handle')) return;

    // Ignore edit icon
    if (e.target.closest('.event-edit')) return;

    const dx = Math.abs(e.clientX - mouseDownX);
    const dy = Math.abs(e.clientY - mouseDownY);

    // If mouse moved → it was a drag, not a click
    if (dx > CLICK_TOLERANCE || dy > CLICK_TOLERANCE) return;
      window.open(
  `https://creatorapp.zoho.eu/homegroup/thg-sandbox/#Form:Bookings?recLinkID=${evt.zoho_id}&viewLinkName=Bookings_Backend`,
  '_blank',
  'noopener'
);

});
                container.appendChild(el);
            });
        }

        function detectOverlaps(events) {
    if (!events || events.length === 0) return [];

    // 1. Sort by start time
    const sorted = [...events].sort((a, b) => a.startMinutes - b.startMinutes);

    const columns = []; 

    sorted.forEach(evt => {
        
        for (let i = 0; i < columns.length; i++) {
            if (columns[i] && columns[i].endMinutes <= evt.startMinutes) {
                columns[i] = null;
            }
        }
        let colIndex = columns.findIndex(c => c === null);

        if (colIndex === -1) {
            colIndex = columns.length;
            columns.push(evt);
        } else {
            columns[colIndex] = evt;
        }

        evt.stackLevel = colIndex;
        evt._tempColumns = columns.length;
        evt.endMinutes = evt.endMinutes; 
    });
    sorted.forEach(evt => {
        evt.maxConcurrent = evt._tempColumns;
        delete evt._tempColumns;
    });

    return sorted;
}
               
        async function renderWeekView() {
            // await getBookingsForWeek();
            renderWeekDaysHeader();
            renderWeekEmployeeRows();
            syncWeekScroll();
        }

        function renderWeekDaysHeader() {
    const header = document.getElementById('weekDaysHeader');
    header.innerHTML = '';
    
    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
    
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    for (let i = 0; i < 7; i++) {
        const dayDate = new Date(weekStart);
        dayDate.setDate(weekStart.getDate() + i);
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        
        // Highlight today
        if (dayDate.toDateString() === todayDate.toDateString()) {
            dayHeader.classList.add('today');
        }
        
        // Match the text format in your screenshot: "TUE, 6 JAN"
        const dName = dayNames[i].toUpperCase();
        const dNum = dayDate.getDate();
        const mName = monthNames[dayDate.getMonth()].toUpperCase();
        
        dayHeader.innerHTML = `
            <div class="week-day-name">${dName}, ${dNum} ${mName}</div>
        `;
        header.appendChild(dayHeader);
    }
}

        function syncWeekScroll() {
            const scrollWrapper = document.getElementById('weekScrollWrapper');
            const daysContainer = document.querySelector('.week-days-container');
            
            scrollWrapper.addEventListener('scroll', function() {
                daysContainer.scrollLeft = this.scrollLeft;
            });
        }

function renderWeekEmployeeRows() {
    const rowsContainer = document.getElementById('weekCalendarRows');
    rowsContainer.innerHTML = '';

    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
    const rowHeightsMap = {};
    
    // 1. Calculate the height needed to fill the screen
    const fillHeight = calculateFillHeight();

    const displayList = employees.length >= 0 ? employees : ['—'];
    displayList.forEach(employee => {
        let maxEventsInDay = 1;

        // 2. Check if events require MORE height than the fill height
        if (employee !== '—') {
            for (let day = 0; day < 7; day++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + day);
                const events = getEventsForEmployee(employee, getDateKey(dayDate));
                if (events.length > 0) maxEventsInDay = Math.max(maxEventsInDay, events.length);
            }
        }

        const eventNeededHeight = (maxEventsInDay * (EVENT_HEIGHT + EVENT_GAP)) + (ROW_PADDING * 2);
        
        // 3. Set height to whichever is larger: Fill Height or Event Height
        const finalRowHeight = Math.max(fillHeight, eventNeededHeight);
        rowHeightsMap[employee] = finalRowHeight;

        const employeeRow = document.createElement('div');
        employeeRow.className = 'week-employee-calendar-row';
        employeeRow.style.height = finalRowHeight + 'px';

        for (let day = 0; day < 7; day++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + day);
            const dateKey = getDateKey(dayDate);

            const dayColumn = document.createElement('div');
            dayColumn.className = 'week-day-column';
                dayColumn.style.flex = "1 1 0"; // Force equal width

            
            if (employee !== '—') {
                dayColumn.dataset.day = day;
                dayColumn.dataset.dateKey = dateKey;
                dayColumn.dataset.employee = employee;
                dayColumn.addEventListener('dragover', handleWeekDragOver);
                dayColumn.addEventListener('drop', handleWeekDrop);
                dayColumn.addEventListener('dragleave', handleDragLeave);
            }

            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'week-events-container';
            const events = employee === '—' ? [] : getEventsForEmployee(employee, dateKey);
            console.log(employee,dateKey);
            renderWeekEventsForEmployee(eventsContainer, events, dateKey);

            dayColumn.appendChild(eventsContainer);
            employeeRow.appendChild(dayColumn);
        }
        rowsContainer.appendChild(employeeRow);
    });

    // 4. Update the side employee labels to match the new heights
    renderWeekEmployeeColumn(rowHeightsMap);
}

window.addEventListener('resize', () => {
    if (currentView === 'day') renderDayView();
    else renderWeekView();
});

        function renderWeekEmployeeColumn(rowHeightsMap = {}) {
    const column = document.getElementById('weekEmployeeColumn');
    column.innerHTML = '';

    const displayList = employees.length > 0 ? employees : ['—'];

    displayList.forEach(employee => {
        const row = document.createElement('div');
        row.className = 'week-employee-row';
        row.textContent = employee === '—' ? "" : employee;
        const height = rowHeightsMap[employee] || (employees.length === 0 ? 500 : MIN_ROW_HEIGHT);
        row.style.height = height + 'px';
        column.appendChild(row);
    });
}

        function renderWeekEventsForEmployee(container, events, dateKey) {
            events.forEach((evt, index) => {
                const el = document.createElement('div');
                el.className = `event status-${evt.status}`;
                el.draggable = true;

                el.dataset.eventId = evt.id;
                el.dataset.viewType = 'week';
                el.dataset.eventDate = dateKey;
                el.dataset.employee = evt.employee;

                // Stack events from top to bottom instead of time-based positioning
                const topPosition = ROW_PADDING + (index * (EVENT_HEIGHT + EVENT_GAP));
                
                el.style.top = `${topPosition}px`;
                el.style.height = `${EVENT_HEIGHT}px`;
                el.style.left = '2px';
                el.style.right = '2px';
                el.style.width = 'auto';

                const title = document.createElement('div');
                title.className = 'event-title';
                title.textContent = evt.title;

                const time = document.createElement('div');
                time.className = 'event-time';
                time.textContent = formatTimeRange(evt.startMinutes, evt.endMinutes);

                el.appendChild(title);
                el.appendChild(time);

                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);

                el.addEventListener('mousedown', (e) => {
    mouseDownX = e.clientX;
    mouseDownY = e.clientY;
});

el.addEventListener('mouseup', (e) => {
    // Ignore resize handles (future-safe)
    if (e.target.closest('.resize-handle')) return;

    // Ignore edit icon
    if (e.target.closest('.event-edit')) return;

    const dx = Math.abs(e.clientX - mouseDownX);
    const dy = Math.abs(e.clientY - mouseDownY);

    if (dx > CLICK_TOLERANCE || dy > CLICK_TOLERANCE) return;

     window.open(
  `https://creatorapp.zoho.eu/homegroup/thg-sandbox/#Form:Bookings?recLinkID=${evt.id}&viewLinkName=Bookings_Backend`,
  '_blank',
  'noopener'
);

});
                container.appendChild(el);
            });
        }

        function formatTimeRange(startMinutes, endMinutes) {
            const start = minutesToTime(startMinutes);
            const end = minutesToTime(endMinutes);
            const startHour = start.hour % 12 || 12;
            const startPeriod = start.hour < 12 ? 'AM' : 'PM';
            const endHour = end.hour % 12 || 12;
            const endPeriod = end.hour < 12 ? 'AM' : 'PM';
            return `${startHour}:${start.minute.toString().padStart(2, '0')} ${startPeriod} - ${endHour}:${end.minute.toString().padStart(2, '0')} ${endPeriod}`;
        }

        function minutesToTime(minutes) {
            return { hour: Math.floor(minutes / 60), minute: minutes % 60 };
        }

        // DRAG AND DROP HANDLERS
        function handleDragStart(e) {
            draggedElement = e.currentTarget;
            draggedEventId = parseInt(e.currentTarget.dataset.eventId);
            console.log(draggedEventId);
            
            const viewType = e.currentTarget.dataset.viewType;
            let dateKey = viewType === 'week' ? e.currentTarget.dataset.eventDate : getCurrentDateKey();
            
            const events = eventDatabase[dateKey] || [];
            console.log(events);
            
            draggedEventData = events.find(evt => evt.id === draggedEventId);
            if (draggedEventData) {
                draggedEventData.originalDateKey = dateKey;
            }
            
            e.currentTarget.classList.add('dragging');
            document.body.classList.add('dragging-active');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.body.classList.remove('dragging-active');
            document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
            draggedElement = null;
            draggedEventId = null;
            draggedEventData = null;
        }

        function handleDayDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const slot = e.currentTarget;
            if (!slot.classList.contains('drop-highlight')) {
                document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
                slot.classList.add('drop-highlight');
            }
        }

        function handleWeekDragOver(e) {
            e.preventDefault();
            
            if (!draggedEventData) {
                e.dataTransfer.dropEffect = 'none';
                return;
            }
            
            const slot = e.currentTarget;
            const newDateKey = slot.dataset.dateKey;
            const newEmployee = slot.dataset.employee;
            const originalDateKey = draggedEventData.originalDateKey;
            const originalEmployee = draggedEventData.employee;
            
            // Prevent drop effect if same column
            if (newDateKey === originalDateKey && newEmployee === originalEmployee) {
                e.dataTransfer.dropEffect = 'none';
                document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
                return;
            }
            
            e.dataTransfer.dropEffect = 'move';
            if (!slot.classList.contains('drop-highlight')) {
                document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
                slot.classList.add('drop-highlight');
            }
        }

        function handleDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drop-highlight');
            }
        }

        function handleDayDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const slot = e.currentTarget;
            slot.classList.remove('drop-highlight');
            console.log(draggedElement, draggedEventId, draggedEventData);
            if (!draggedElement || !draggedEventId || !draggedEventData) return;
            
            const newHour = parseInt(slot.dataset.hour);
            const newQuarter = parseInt(slot.dataset.quarter);
            const newEmployee = slot.dataset.employee;
            const newStartMinutes = newHour * 60 + newQuarter * 15;
            const duration = draggedEventData.endMinutes - draggedEventData.startMinutes;
            
            const originalDateKey = draggedEventData.originalDateKey;
            const currentDateKey = getCurrentDateKey();
            
            if (eventDatabase[originalDateKey]) {
                const index = eventDatabase[originalDateKey].findIndex(ev => ev.id === draggedEventId);
                if (index !== -1) eventDatabase[originalDateKey].splice(index, 1);
            }
            
            if (!eventDatabase[currentDateKey]) eventDatabase[currentDateKey] = [];
            eventDatabase[currentDateKey].push({
                ...draggedEventData,
                startMinutes: newStartMinutes,
                endMinutes: newStartMinutes + duration,
                employee: newEmployee
            });
            console.log("all called");
            
            renderDayView();
        }

        function handleWeekDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const slot = e.currentTarget;
            slot.classList.remove('drop-highlight');
            
            
            if (!draggedElement || !draggedEventId || !draggedEventData) return;
            
            const newDateKey = slot.dataset.dateKey;
            const newEmployee = slot.dataset.employee;
            const originalDateKey = draggedEventData.originalDateKey;
            const originalEmployee = draggedEventData.employee;
            
            // Prevent drop if it's the same column (same day AND same employee)
            if (newDateKey === originalDateKey && newEmployee === originalEmployee) {
                return;
            }
            
            const duration = draggedEventData.endMinutes - draggedEventData.startMinutes;
            
            if (eventDatabase[originalDateKey]) {
                const index = eventDatabase[originalDateKey].findIndex(ev => ev.id === draggedEventId);
                if (index !== -1) eventDatabase[originalDateKey].splice(index, 1);
            }
            
            if (!eventDatabase[newDateKey]) eventDatabase[newDateKey] = [];
            eventDatabase[newDateKey].push({
                ...draggedEventData,
                employee: newEmployee
            });
            
            renderWeekView();
        }

        // New Function for From/To Date Filter selection
function selectDateFilterOption(filterName, value, element) {
    const hiddenInput = document.getElementById(`${filterName}-filter`);
    hiddenInput.value = value;
    
    // Update Display Text
    document.getElementById(`${filterName}-filter-text`).textContent = element.textContent;
    
    // Manage UI Visibility based on selection
    const dateGroup = document.getElementById(`${filterName}-date-group`);
    const nGroup = document.getElementById(`${filterName}-n-group`);
    
    // Reset displays
    dateGroup.style.display = 'none';
    nGroup.style.display = 'none';

    // Show date picker for specific date comparisons
    if (value === 'is' || value === 'isNot' || value === 'gtDate' || value === 'ltDate') {
        dateGroup.style.display = 'block';
    } 
    // Show number input for dynamic "n"
    else if (value.includes('NDays') || value.includes('NMonths') || value.includes('NYears')) {
        nGroup.style.display = 'block';
    }

    // Close dropdown
    toggleFilterDropdown(filterName);
}

// Logic to gather data during performSearch()
function getFilterDisplayValue(filterName) {
    const type = document.getElementById(`${filterName}-filter`).value;
    
    if (type === 'gtDate' || type === 'ltDate' || type === 'is' || type === 'isNot') {
        const val = document.getElementById(`${filterName}-date-val`).value;
        return val ? [val] : [];
    }
    
    if (type.includes('NDays') || type.includes('NMonths') || type.includes('NYears')) {
        const val = document.getElementById(`${filterName}-n-val`).value;
        return val ? [val] : [];
    }
    
    // For relative dates (Today, This Month, etc), no additional input is needed
    return ["Selected"]; 
}

// Update the existing performSearch function to handle the new date types
const originalPerformSearch = performSearch;
performSearch = function() {
    const fromChecked = document.querySelector('input[name="from"]').checked;
    const toChecked = document.querySelector('input[name="to"]').checked;
    
    if (fromChecked) {
        const filterType = document.getElementById('from-filter').value;
        filterTags['from'] = getFilterDisplayValue('from');
    }
    
    if (toChecked) {
        const filterType = document.getElementById('to-filter').value;
        filterTags['to'] = getFilterDisplayValue('to');
    }
    
    originalPerformSearch();
};

// Update label formatting to handle date-specific text
const originalFormatFilterText = formatFilterText;
formatFilterText = function(filter) {
    if (filter.field === 'from' || filter.field === 'to') {
        const typeMap = {
            gtDate: 'is after',
            ltDate: 'is before',
            gtNDays: `is > ${filter.searchValues[0]} days from today`,
            ltNDays: `is < ${filter.searchValues[0]} days from today`,
            today: 'is Today',
            thisWeek: 'is This Week',
            last7: 'is within Last 7 Days'
            // ... you can add more friendly mappings here
        };
        const label = typeMap[filter.filterType] || filter.filterType;
        const fieldName = filter.field.charAt(0).toUpperCase() + filter.field.slice(1);
        
        if (['isEmpty', 'isNotEmpty', 'today', 'yesterday', 'tomorrow', 'thisWeek', 'lastWeek', 'nextWeek', 'thisMonth', 'lastMonth', 'nextMonth', 'thisYear', 'lastYear', 'nextYear', 'last7', 'last30', 'last60', 'last90'].includes(filter.filterType)) {
             return `${fieldName} ${label}`;
        }
        return `${fieldName} ${label} "${filter.searchValues[0]}"`;
    }
    return originalFormatFilterText(filter);
};
        // SEARCH FUNCTIONALITY
        function toggleSearch() {
            const panel = document.getElementById('searchPanel');
            const overlay = document.getElementById('searchOverlay');
            panel.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function toggleFilterInputs(filterName) {
            const checkbox = document.querySelector(`input[name="${filterName}"]`);
            const inputs = document.getElementById(`${filterName}-inputs`);
            if (checkbox.checked) {
                inputs.classList.add('active');
            } else {
                inputs.classList.remove('active');
            }
        }

        function toggleFilterDropdown(filterName) {
            const display = document.getElementById(`${filterName}-filter-display`);
            const options = document.getElementById(`${filterName}-filter-options`);
            document.querySelectorAll('.filter-options').forEach(opt => {
                if (opt.id !== `${filterName}-filter-options`) opt.classList.remove('active');
            });
            document.querySelectorAll('.filter-select').forEach(sel => {
                if (sel.id !== `${filterName}-filter-display`) sel.classList.remove('active');
            });
            display.classList.toggle('active');
            options.classList.toggle('active');
        }

        function selectFilterOption(filterName, value, element) {
            document.getElementById(`${filterName}-filter`).value = value;
            filterValues[filterName] = value;
            document.getElementById(`${filterName}-filter-text`).textContent = element.textContent;
            const options = document.getElementById(`${filterName}-filter-options`);
            options.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            
            const tagsGroup = document.getElementById(`${filterName}-tags-group`);
            if (tagsGroup) {
                if (value === 'isEmpty' || value === 'isNotEmpty') {
                    tagsGroup.style.display = 'none';
                } else {
                    tagsGroup.style.display = 'block';
                }
            }
            
            toggleFilterDropdown(filterName);
        }

        function focusTagInput(filterName) {
            document.getElementById(`${filterName}-tags-input`).focus();
        }

        function handleTagInput(event, filterName) {
            const input = event.target;
            const value = input.value.trim();
            
            if (event.key === 'Enter' && value) {
                event.preventDefault();
                if (filterTags[filterName].length >= MAX_TAGS) return;
                addTag(filterName, value);
                input.value = '';
            }
            if (event.key === 'Backspace' && !value && filterTags[filterName].length > 0) {
                event.preventDefault();
                removeTag(filterName, filterTags[filterName].length - 1);
            }
        }

        function addTag(filterName, text) {
            if (!text || filterTags[filterName].includes(text)) return;
            if (filterTags[filterName].length >= MAX_TAGS) return;
            filterTags[filterName].push(text);
            renderTags(filterName);
        }

        function removeTag(filterName, index) {
            filterTags[filterName].splice(index, 1);
            renderTags(filterName);
        }

        function renderTags(filterName) {
            const container = document.getElementById(`${filterName}-tags-container`);
            const input = document.getElementById(`${filterName}-tags-input`);
            if (!container || !input) return;
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());
            filterTags[filterName].forEach((text, index) => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                const textSpan = document.createElement('span');
                textSpan.textContent = text;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'tag-remove';
                removeBtn.textContent = '×';
                removeBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeTag(filterName, index);
                };
                tag.appendChild(textSpan);
                tag.appendChild(removeBtn);
                container.insertBefore(tag, input);
            });
        }

        function performSearch() {
            const checkboxes = document.querySelectorAll('.search-filter input[type="checkbox"]:checked');
            const filters = [];
            
            checkboxes.forEach(checkbox => {
                const filterName = checkbox.name;
                const filterType = document.getElementById(`${filterName}-filter`).value;
                const tags = filterTags[filterName];
                if(tags.length === 0 && (filterType !== 'isEmpty' && filterType !== 'isNotEmpty')) {
                    checkbox.checked = false;             
                    document.getElementById(`${filterName}-inputs`)?.classList.remove('active');   
                    return;
                }
                
                filters.push({
                    field: filterName,
                    filterType: filterType,
                    searchValues: tags
                });
            });
            
            appliedFilters = filters;
            renderAppliedFilters();
            toggleSearch();
        }
        
        function formatFilterText(filter) {
            const fieldName = fieldDisplayNames[filter.field] || filter.field;
            const filterType = filter.filterType;
            
            if (filterType === 'isEmpty' || filterType === 'isNotEmpty') {
                return `${fieldName} ${filterType === 'isEmpty' ? 'is empty' : 'is not empty'}`;
            }
            
            if (filter.searchValues.length === 0) {
                return `${fieldName} ${filterType}`;
            } else if (filter.searchValues.length === 1) {
                return `${fieldName} ${filterType} "${filter.searchValues[0]}"`;
            } else {
                const valuesList = filter.searchValues.map(v => `"${v}"`).join('" or "');
                return `${fieldName} ${filterType} either "${valuesList}"`;
            }
        }
        
        function renderAppliedFilters() {
            const section = document.getElementById('searchFiltersSection');
            const container = document.getElementById('searchFiltersContainer');
            
            const existingPills = container.querySelectorAll('.search-filter-pill');
            existingPills.forEach(pill => pill.remove());
            
            if (appliedFilters.length === 0) {
                section.classList.remove('active');
                return;
            }
            
            section.classList.add('active');
            
            appliedFilters.forEach((filter, index) => {
                const pill = document.createElement('div');
                pill.className = 'search-filter-pill';
                
                const text = document.createElement('span');
                text.className = 'filter-pill-text';
                text.textContent = formatFilterText(filter);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'filter-pill-remove';
                removeBtn.innerHTML = '×';
                removeBtn.onclick = function() {
                    removeAppliedFilter(index);
                };
                
                pill.appendChild(text);
                pill.appendChild(removeBtn);
                container.appendChild(pill);
            });
        }
        
        function removeAppliedFilter(index) {
            const filterToRemove = appliedFilters[index];
            const filterName = filterToRemove.field;
            
            const checkbox = document.querySelector(`input[name="${filterName}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            const inputs = document.getElementById(`${filterName}-inputs`);
            if (inputs) {
                inputs.classList.remove('active');
            }
            
            const hiddenInput = document.getElementById(`${filterName}-filter`);
            if (hiddenInput) {
                hiddenInput.value = 'contains';
            }
            filterValues[filterName] = 'contains';
            
            const displayText = document.getElementById(`${filterName}-filter-text`);
            if (displayText) {
                displayText.textContent = 'Contains';
            }
            
            const options = document.getElementById(`${filterName}-filter-options`);
            if (options) {
                options.querySelectorAll('.filter-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.textContent === 'Contains') {
                        opt.classList.add('selected');
                    }
                });
            }
            
            const tagsGroup = document.getElementById(`${filterName}-tags-group`);
            if (tagsGroup) {
                tagsGroup.style.display = 'block';
            }
            
            clearTags(filterName);
            appliedFilters.splice(index, 1);
            renderAppliedFilters();
        }
        
        function clearTags(filterName) {
            filterTags[filterName] = [];
            renderTags(filterName);
        }

        // MINI CALENDAR
        function toggleMiniCalendar() {
            const miniCal = document.getElementById('miniCalendar');
            const wasActive = miniCal.classList.contains('active');
            miniCal.classList.toggle('active');
            
            if (!wasActive && miniCal.classList.contains('active')) {
                renderMiniCalendar();
            }
        }

        async function renderMiniCalendar() {
            const grid = document.getElementById('miniGrid');
            const monthYear = document.getElementById('miniMonthYear');
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            monthYear.textContent = `${new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' }).toUpperCase()}`;
            
            const existingDays = grid.querySelectorAll('.mini-day');
            existingDays.forEach(day => day.remove());
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();
            let currentWeekDates = [];
            if (currentView === 'week') {
                const weekStart = new Date(currentDate);
                weekStart.setDate(currentDate.getDate() - currentDate.getDay());
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    currentWeekDates.push(date.getTime());
                }
            }
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'mini-day other-month';
                day.textContent = prevMonthDays - i;
                
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevYear = month === 0 ? year - 1 : year;
                const dayDate = new Date(prevYear, prevMonth, prevMonthDays - i);
                
                day.dataset.day = prevMonthDays - i;
                day.dataset.month = prevMonth;
                day.dataset.year = prevYear;
                day.dataset.timestamp = dayDate.getTime();
                
                setupDayEvents(day, dayDate, currentWeekDates);
                grid.appendChild(day);
            }
            
            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.className = 'mini-day';
                day.textContent = i;
                day.dataset.day = i;
                day.dataset.month = month;
                day.dataset.year = year;
                
                const dayDate = new Date(year, month, i);
                day.dataset.timestamp = dayDate.getTime();
                
                if (currentView === 'week' && currentWeekDates.includes(dayDate.getTime())) {
                    day.classList.add('week-highlighted');
                }
                
                if (i === todayDate.getDate() && 
                    month === todayDate.getMonth() && 
                    year === todayDate.getFullYear()) {
                    day.classList.add('today');
                }
                
                if (i === currentDate.getDate() && 
                    month === currentDate.getMonth() && 
                    year === currentDate.getFullYear()) {
                    day.classList.add('selected');
                }
                
                setupDayEvents(day, dayDate, currentWeekDates);
                grid.appendChild(day);
            }
            
            const remainingSlots = 42 - (firstDay + daysInMonth);
            for (let i = 1; i <= remainingSlots; i++) {
                const day = document.createElement('div');
                day.className = 'mini-day other-month';
                day.textContent = i;
                
                const nextMonth = month === 11 ? 0 : month + 1;
                const nextYear = month === 11 ? year + 1 : year;
                const dayDate = new Date(nextYear, nextMonth, i);
                
                day.dataset.day = i;
                day.dataset.month = nextMonth;
                day.dataset.year = nextYear;
                day.dataset.timestamp = dayDate.getTime();
                
                setupDayEvents(day, dayDate, currentWeekDates);
                grid.appendChild(day);
            }
        }
        
        function setupDayEvents(dayElement, dayDate, currentWeekDates) {
            dayElement.addEventListener('click', function() {
                selectDate(parseInt(this.dataset.day), parseInt(this.dataset.month), parseInt(this.dataset.year));
            });
            
            if (currentView === 'week') {
                dayElement.addEventListener('mouseenter', function() {
                    highlightWeekOnHover(dayDate);
                });
                
                dayElement.addEventListener('mouseleave', function() {
                    clearWeekHover();
                });
            }
        }
        
        function highlightWeekOnHover(date) {
            if (currentView !== 'week') return;
            
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                weekDates.push(d.getTime());
            }
            
            const allDays = document.querySelectorAll('.mini-day');
            allDays.forEach(day => {
                const timestamp = parseInt(day.dataset.timestamp);
                if (weekDates.includes(timestamp)) {
                    day.classList.add('week-hover');
                }
            });
        }
        // test
        function clearWeekHover() {
            const allDays = document.querySelectorAll('.mini-day');
            allDays.forEach(day => {
                day.classList.remove('week-hover');
            });
        }

        async function selectDate(day, month, year) {
            currentDate = new Date(year, month, day);
            await getBookings();
            if (currentView === 'week') {
                updateDateTitle();
                renderWeekView();
            } else {
                updateDateTitle();
                renderDayView();
            }
            
            renderMiniCalendar();
            toggleMiniCalendar();
        }

        function changeMiniMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderMiniCalendar();
        }

        document.addEventListener('click', (e) => {
            const miniCal = document.getElementById('miniCalendar');
            const calIcon = document.querySelectorAll('.calendar-icon')[1];
            if (miniCal && calIcon && miniCal.classList.contains('active') && 
                !miniCal.contains(e.target) && 
                !calIcon.contains(e.target)) {
                miniCal.classList.remove('active');
            }
        });

        // INITIALIZATION
        async function init() {
             showLoader();
            await getZohoData();
            await switchView('day');
            await renderMiniCalendar();
            startAt6();
            hideLoader();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>