<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net"></script>
    <link rel="stylesheet" href="styles.css" />
    <title>Day & Week Calendar View - With Employees</title>
    <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f7fa;
        }
        .filter-option-header {
    background: #f3f4f6;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 700;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-top: 1px solid #e5e7eb;
}
.filter-date-input, .filter-n-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    margin-top: 5px;
}
.filter-n-input {
    width: 80px;
}
        /* Container that holds the header and the scrollable area */
.calendar-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    /* overflow: hidden; Keeps the rounded corners clean */
    display: flex;
    flex-direction: column;
}

/* Add this class to the div containing your rows */
.calendar-body-scrollable {
    flex: 1;
    overflow-y: auto;   /* ✅ vertical scroll lives here */
    overflow-x: hidden;
    position: relative;
}


/* Make the header sticky so it stays visible while scrolling down */
.calendar-header-grid, .week-days-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
}
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
        }
        .view-toggle {
            display: flex;
            gap: 0;
            background: #f3f4f6;
            border-radius: 6px;
            /* overflow: hidden; */
        }
        .view-toggle button {
            padding: 8px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .view-toggle button.active {
            background: #682987;
            color: white;
        }
        .date-title {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
        }
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .nav-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: #f9fafb; }
        .calendar-icon {
            padding: 8px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .mini-calendar {
            position: absolute;
            right: 30px;
            top: 70px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 200;
            display: none;
            width: 320px;
        }

        .mini-calendar.active {
            display: block;
        }

        .mini-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }

        .mini-nav {
            display: flex;
            gap: 10px;
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .mini-day-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            padding: 8px 5px;
            text-transform: uppercase;
        }

        .mini-day {
            padding: 10px;
            font-size: 13px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .mini-day:hover {
            background: #f3f4f6;
        }

        .mini-day.other-month {
            color: #d1d5db;
           
        }

        .mini-day.today {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }

        .mini-day.selected {
            background: #4f46e5;
            color: white;
            font-weight: 600;
        }
        
        .mini-day.week-highlighted {
            background: #e0e7ff;
            color: #4338ca;
        }
        
        .mini-day.week-highlighted.today {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        
        .mini-day.week-highlighted.selected {
            background: #4f46e5;
            color: white;
            font-weight: 600;
        }
        
        .mini-day.week-hover {
            background: #f3f4f6 !important;
        }
        
        /* Search Filters Display Section */
        .search-filters-section {
            padding: 10px 30px;
            background: #fafafa;
            border-bottom: 1px solid #e5e7eb;
            display: none;
            position: sticky;
            top: 72px; /* Adjust based on your header height */
            z-index: 90;
        }

        .search-filters-section.active {
            display: block;
        }

        .search-filters-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-filter-pill {
            display: inline-flex;
            align-items: center;
            background: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            color: #1f2937;
            gap: 8px;
            transition: background 0.2s;
        }

        .search-filter-pill:hover {
            background: #d1d5db;
        }

        .filter-pill-text {
            line-height: 1.4;
        }

        .filter-pill-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .filter-pill-remove:hover {
            background: #9ca3af;
            color: white;
        }

        /* Search Panel Styles */
        .search-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 200;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .search-panel.active {
            right: 0;
        }

.sticky-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: #ffffff;
}

/* Prevent overlap shadow glitch */
.day-header-row {
    border-bottom: 2px solid #e5e7eb;
}
.day-header-row.sticky-header {
    position: sticky;
    top: 0;
    z-index: 88;
    background: #ffffff;
}



        .search-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .close-search {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-search:hover {
            color: #1f2937;
        }

        .search-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .search-filter {
            margin-bottom: 15px;
        }

        .search-filter label {
            display: flex;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
            color: #374151;
            font-size: 14px;
        }

        .search-filter input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #6b46c1;
        }

        .filter-inputs {
            display: none;
            margin-left: 30px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .filter-inputs.active {
            display: block;
        }

        .filter-input-group {
            margin-bottom: 12px;
        }

        .filter-input-group:last-child {
            margin-bottom: 0;
        }

        .filter-input-group label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
            font-weight: 500;
            padding: 0;
        }

        .filter-select-wrapper {
            position: relative;
            width: 100%;
        }

        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .filter-select:hover {
            border-color: #9ca3af;
        }

        .filter-select.active {
            border-color: #6b46c1;
            box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.2);
        }

        .filter-select-arrow {
            width: 12px;
            height: 12px;
            transition: transform 0.2s;
        }

        .filter-select.active .filter-select-arrow {
            transform: rotate(180deg);
        }

        .filter-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .filter-options.active {
            display: block;
        }

        .filter-option {
            padding: 8px 12px;
            font-size: 14px;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            cursor: pointer;
            transition: background-color 0.15s;
        }

        .filter-option:hover {
            background-color: #f6f6f6;
        }

        .filter-option.selected {
            background-color: #4285f4;
            color: white;
        }

        .filter-option.selected:hover {
            background-color: #3367d6;
        }

        .filter-options::-webkit-scrollbar {
            width: 8px;
        }

        .filter-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .filter-options::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .filter-options::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .tags-input-container {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 2px solid #6b46c1;
            border-radius: 4px;
            background: white;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: flex-start;
            cursor: text;
        }

        .tags-input-container:focus-within {
            outline: none;
            border-color: #6b46c1;
            box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.2);
        }

        .tags-input-container.hidden {
            display: none;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background: #e9d5ff;
            color: #6b21a8;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 13px;
            gap: 6px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: #6b21a8;
            cursor: pointer;
            padding: 0;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }

        .tag-remove:hover {
            color: #581c87;
        }

        .tags-input-container input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 120px;
            padding: 4px;
            font-size: 14px;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .tags-input-container input::placeholder {
            color: #9ca3af;
        }

        .search-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
        }

        .search-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .search-btn:hover {
            background: #4338ca;
        }

        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 199;
            display: none;
        }

        .calendar-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}

/* Update calendar container */
.calendar-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    height: calc(100vh - 40px); /* Leave some margin */
    max-height: calc(100vh - 40px);
    overflow: hidden;
}

/* Adjust scrollable body to account for sticky headers */
.calendar-body-scrollable {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
}

/* For day view */
.day-view-container {
    display: flex;
    flex-direction: column;
    height: calc(87vh - 72px); /* Adjust for sticky headers */
}

/* For week view */
.week-view-container {
    display: flex;
    flex-direction: column;
    height: calc(87vh - 72px); /* Adjust for sticky headers */
}
.week-header-row {
    position: sticky;
    top: 0; /* This will be relative to its scroll container */
    z-index: 88;
    background: #ffffff;
}

/* If week view is inside the scrollable area, adjust accordingly */
.week-scroll-wrapper .week-header-row {
    position: sticky;
    top: 0;
    z-index: 88;
    background: #ffffff;
}

        .search-overlay.active {
            display: block;
        }
        
        /* Day View Styles - Modified for Employee Rows with Single Scroll */
        .day-view { 
            display: none;
        flex: 1;
    min-height: 0; }
        .day-view.active { 
            display: flex;
    flex-direction: column; 
}
        
        .day-view-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 0; /* Important */
}
        
        .day-header-row {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            z-index: 30;
        }
        
        .employee-header {
            flex: 0 0 150px;
            min-width: 12.5%;
            padding: 12px 15px;
            text-align: center;
            font-size: 15px;
            color: #000;
            font-weight: bolder;
            border-right: 2px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .hour-header-container {
            flex: 1;
            overflow: hidden;
        }
        
        .hour-header {
            display: flex;
            min-width: 2400px;
        }
        
        .hour-label {
            flex: 0 0 100px;
            min-width: 100px;
            padding: 12px 8px;
            text-align: center;
            font-size: 15px;
            color: #000;
            font-weight: bolder;
            border-right: 1px solid #e5e7eb;
        }
        
        .day-body {
            display: flex;
            flex: 1;
            /* overflow: hidden; */
        }
        
        .employee-column {
            flex: 0 0 150px;
            min-width: 12.5%;
            border-right: 2px solid #e5e7eb;
            background: #f9fafb;
            /* overflow: hidden; */
        }
        
        .employee-row {
    display: flex;
    align-items: start;
    justify-content: start;
    border-bottom: 1px solid #e5e7eb;
    padding: 1px;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    text-align: center;
    /* Height will be set dynamically by JavaScript */
}
        
        .calendar-scroll-wrapper { 
            flex: 1;
            overflow: auto;
            overflow-y: hidden;
            scrollbar-width: none;        /* Firefox */
    -ms-overflow-style: none;

        }
        .calendar-scroll-wrapper::-webkit-scrollbar {
    height: 0;                    /* Chrome/Safari */
}
        .hour-header-container {
    cursor: grab;
}

.hour-header-container.grabbing {
    cursor: grabbing;
    user-select: none;
}        
        .calendar-rows {
            min-width: 2400px;
             min-height: 100%; 
        }
        
        .employee-calendar-row {
            position: relative;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calendar-grid {
            display: flex;
            position: relative;
            height: 100%;
        }
        
        .hour-column {
            flex: 0 0 100px;
            min-width: 100px;
            border-right: 1px solid #e5e7eb;
            position: relative;
            height: 100%;
            /* min-height: 100vh; */
             display: flex;
    flex-direction: column;
        }
        
        .hour-column-inner {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            pointer-events: none;
            height: 100%;
        }
        
        .quarter-line { 
            border-right: 1px dotted #d1d5db; 
        }
        
        .quarter-line:last-child { 
            border-right: none; 
        }
        
        .quarter-slot {
            position: absolute;
            top: 0; 
            bottom: 0;
            padding: 2px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            pointer-events: auto;
        }
        
        .quarter-slot[data-quarter="0"] { left: 0; width: 25%; }
        .quarter-slot[data-quarter="1"] { left: 25%; width: 25%; }
        .quarter-slot[data-quarter="2"] { left: 50%; width: 25%; }
        .quarter-slot[data-quarter="3"] { left: 75%; width: 25%; }
        
        .events-container {
            position: absolute;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Week View Styles - MODIFIED FOR EMPLOYEES */
        .week-view { display: none; }
        .week-view.active { display: block; }
        
        .week-view-container {
            display: flex;
            flex-direction: column;
            height: 87vh;
        }
        
        /* Week header with days */
        .week-header-row {
            position: sticky;
            top: 0;
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            z-index: 100;
        }
        .week-days-container {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .week-employee-header {
            flex: 0 0 150px;
            min-width: 12.5%;
            padding: 12px 15px;
            text-align: center;
            font-size: 15px;
            color: #000;
            font-weight: bolder;
            border-right: 2px solid #e5e7eb;
            background: #f9fafb;
        }

        
        .employee-header, .employee-column {
    flex: 0 0 150px;
    /* Remove min-width: 12.5% if you want a fixed 150px sidebar */
    /* Or keep it if you want the sidebar itself to be responsive */
    border-right: 2px solid #e5e7eb;
    background: #f9fafb;
}

  

        
        
        /* .week-days-container {
            flex: 1;
            overflow: hidden;
        } */
        
        .week-days-header {
            display: flex;
            width: 100%;
        }
        
        .week-day-header {
    flex: 1; /* This ensures all 7 columns share equal space and fill the container */
    min-width: 100px; /* Provides a minimum size for responsiveness */
    padding: 12px 8px;
    text-align: center;
    border-right: 1px solid #e5e7eb;
    background: #f9fafb;
}
        
        .week-day-header:last-child {
            border-right: none;
        }
        
        .week-day-header.today {
            background: #dbeafe;
        }
        
        .week-day-name {
            font-size: 12px;
            font-weight: bolder;
            color: black;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .week-day-date {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .week-day-header.today .week-day-date {
            color: #1e40af;
            font-weight: 700;
        }
        
        /* Week body */
        .week-body {
            display: flex;
            flex: 1;
            /* overflow: hidden; */
        }
        
        .week-employee-column {
            flex: 0 0 150px;
            /* min-width: 12.5%;
            border-right: 2px solid #e5e7eb; */
            background: #f9fafb;
            /* overflow: hidden; */
        }
        
        .week-employee-row {
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            text-align: center;
            overflow: hidden; /* Prevent overflow */
        }
.week-employee-row .employee-label {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    overflow: hidden;
}

.week-employee-row .employee-name {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    width: 100%;
    text-align: center;
}

.week-employee-row .employee-total-hours {
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
    white-space: nowrap;
}

        
        .week-scroll-wrapper {
                display: block;  
                overflow-y: auto;
                overflow-x: auto;
                flex: 1;
                position: relative;
        }
        
        .week-calendar-rows {
           flex:1;
        }

        .week-employee-calendar-row {
            position: relative;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
        }
        
        .week-day-column {
            flex:1;
min-width: 100px;
            border-right: 1px solid #e5e7eb;
            position: relative;
        }
        
        .week-day-column:last-child {
            border-right: none;
        }
        
        .week-day-column:hover {
            background: #f9fafb;
        }
        
        .week-hour-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 5;
        }
        
        .week-hour-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 0;
            border-top: 1px solid #e0e0e0;
        }
        
        .week-hour-line.major {
            border-top: 1px solid #d1d5db;
        }
        
        .week-events-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Resize handles */
        .event .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            z-index: 30;
            cursor: ew-resize;
        }

        .event .resize-handle.left {
            left: 0;
        }

        .event .resize-handle.right {
            right: 0;
        }

        /* While resizing, disable drag */
        .event.resizing {
            cursor: ew-resize;
            opacity: 0.7;
        }

        /* Event Styles - Modified for stacking */
        .event {
            position: absolute;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 4px;
            padding: 4px 6px;
            color: white;
            font-size: 10px;
            cursor: move;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            user-select: none;
            pointer-events: auto;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .event.dragging {
            opacity: 0.5;
        }
        
        /* Disable pointer events on all OTHER events when dragging (not the dragged one) */
        body.dragging-active .event:not(.dragging) {
            pointer-events: none;
        }
        
        .event:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 20;
        }
        .event-title {
            font-weight: 600;
            margin-bottom: 1px;
            white-space: nowrap;
            color: black;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            max-width: 100%;
        }
        .event-time {
            color: black;
            font-size: 9px;
            opacity: 0.9;
            line-height: 1.2;
        }
        .drop-highlight { background-color: rgba(99, 102, 241, 0.15) !important; }
        .week-employee-header, .week-employee-column {
    flex: 0 0 150px;
    /* Remove min-width: 12.5% if you want a fixed 150px sidebar */
    /* Or keep it if you want the sidebar itself to be responsive */
    border-right: 2px solid #e5e7eb;
    background: #f9fafb;
}

/* 1. Force the sidebar widths to be identical and use border-box */
.week-employee-header, .week-employee-column {
    flex: 0 0 150px !important;
    width: 150px !important;
    min-width: 150px !important;
    max-width: 150px !important;
    border-right: 2px solid #e5e7eb;
    box-sizing: border-box;
}

/* 2. Important: Add a "gutter" to the header to account for the scrollbar width */
.week-days-container {
    flex: 1;
    overflow-y: scroll; /* Force a scrollbar area */
    scrollbar-color: transparent transparent; /* Make it invisible */
}

/* For Chrome/Safari/Edge to hide that ghost scrollbar in the header */
.week-days-container::-webkit-scrollbar {
    width: 12px; /* Match this to your system scrollbar width if possible, or use a standard 12-16px */
    background: transparent;
}

/* 3. Ensure the columns use a shared flex logic */
.week-days-header, .week-employee-calendar-row {
    display: flex;
    width: 100%;
}

.week-day-header, .week-day-column {
    flex: 1 1 0; /* Ensure they all grow and shrink from 0 equally */
    min-width: 0; /* Allow columns to shrink below content size */
    box-sizing: border-box;
}

.event-edit {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    cursor: pointer;
    opacity: 0.85;
    z-index: 40;
}

.event-edit:hover {
    opacity: 1;
}
/* ===== GLOBAL LOADING OVERLAY ===== */
#loadingOverlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 9999999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Spinner */
.loader {
    width: 48px;
    height: 48px;
    border: 4px solid #e5e7eb;
    border-top-color: #4f46e5;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
}

.loading-text {
    margin-top: 12px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Hide helper */
#loadingOverlay.hidden {
    display: none;
}
.event.status-Not_Started {
    background: linear-gradient(
        135deg,
        #c7d2fe 0%,
        #a5b4fc 45%,
        #c7d2fe 100%
    );
    color: #1e3a8a;
}
.event.status-Missed {
    background: linear-gradient(135deg, #fca5a5, #f87171);
}
.event.status-Not_Completed {
    background: linear-gradient(135deg, #fde68a, #fcd34d);
    color: #78350f;
}
.event.status-Cancelled {
    background: linear-gradient(135deg, #d1d5db, #9ca3af);
    color: #374151;
}
.event.status-Started {
  background: linear-gradient(135deg, #38bdf8, #0284c7);
}
.event.status-Completed {
    background: linear-gradient(135deg, #bbf7d0, #86efac);
    color: #14532d;
}
.event.status-Overlapped {
    background: linear-gradient(135deg, #fed7aa, #fdba74);
    color: #7c2d12;
}

.employee-header-controls {
    display: flex;
    align-items: center;
    gap: 2px;
    position: relative;
    padding: 0;
}

.employee-header-controls input {
    flex: 1;
    min-width: 0; /* IMPORTANT: prevents overflow in flex containers */

    padding: 7px 10px;
    font-size: 12.5px;
    font-weight: 500;

    color: #111827;
    background: #ffffff;

    border: none;
    border-bottom: 2px solid #e5e7eb;
    border-radius: 0;

    outline: none;
    transition: 
        border-color 0.2s ease,
        background-color 0.2s ease;
}

.employee-header-controls input::placeholder {
    color: #9ca3af;
    font-weight: 400;
}

/* Focus state */
.employee-header-controls input:focus {
    border-bottom-color: #4f46e5; /* Indigo */
    background-color: #f9fafb;
}

/* Hover (subtle, not noisy) */
.employee-header-controls input:hover:not(:focus) {
    border-bottom-color: #c7d2fe;
}

.employee-add-btn {
    width: 28px;
    height: 28px;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
}

.employee-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    padding: 6px;
    z-index: 200;
    display: none;
}

.employee-dropdown.active {
    display: block;
}

.employee-dropdown input {
    width: 100%;
    padding: 6px;
    margin-bottom: 6px;
    font-size: 12px;
}

.employee-dropdown-list {
    max-height: 180px;
    overflow-y: auto;
}

.employee-dropdown-item {
    padding: 6px;
    font-size: 13px;
    cursor: pointer;
    border-radius: 4px;
}

.employee-dropdown-item:hover {
    background: #eef2ff;
}
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.modal-overlay.hidden {
  display: none;
}

/* CARD */
.modal-card {
  background: #fff;
  width: 620px;
  max-height: calc(100vh - 40px); /* KEY FIX */
  display: flex;
  flex-direction: column;
  border-radius: 8px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
}

/* HEADER */
.modal-header {
  padding: 14px 16px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 16px;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
}

/* BODY (SCROLL ONLY HERE) */
.modal-body {
  padding: 16px;
  overflow-y: auto;
}

/* FOOTER */
.modal-footer {
  padding: 12px 16px;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* FORM */
.form-group {
  margin-bottom: 12px;
}

.form-group label {
  font-size: 12px;
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
}

.form-group label span {
  color: #dc2626;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 7px 8px;
  font-size: 13px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.form-group input:disabled,
.form-group textarea:disabled {
  background: #f3f4f6;
  color: #6b7280;
}
/* ===== CUSTOM DROPDOWN (MODAL) ===== */
.custom-dropdown {
  position: relative;
  width: 100%;
}

.custom-dropdown-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 7px 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  background: #fff;
}

.custom-dropdown-options {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  z-index: 2000;
  display: none;
  max-height: 100px;
  overflow-y: auto;
}

.custom-dropdown.active .custom-dropdown-options {
  display: block;
}

.custom-dropdown-option {
  padding: 8px 10px;
  font-size: 13px;
  cursor: pointer;
}

.custom-dropdown-option:hover {
  background: #eef2ff;
}
.modal-input {
  width: 100%;
  padding: 7px 10px;
  font-size: 13px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: #fff;
}

.modal-input[disabled] {
  background: #f9fafb;
  color: #6b7280;
  cursor: not-allowed;
}

/* TWO COLUMN ROW */
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

/* BUTTONS */
.btn-primary {
  background: #4f46e5;
  color: white;
  border: none;
  padding: 7px 14px;
  border-radius: 4px;
  cursor: pointer;
}

.btn-secondary {
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  padding: 7px 14px;
  border-radius: 4px;
  cursor: pointer;
}
#toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 99999;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    min-width: 280px;
    max-width: 360px;
    padding: 12px 14px;

    background: #111827;
    color: #ffffff;

    font-size: 13px;
    font-weight: 500;

    border-radius: 6px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);

    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;

    animation: slideIn 0.25s ease-out;
}

.toast.error {
    background: #b91c1c;
}

.toast.success {
    background: #15803d;
}

.toast .close-btn {
    cursor: pointer;
    font-size: 16px;
    opacity: 0.8;
}

.toast .close-btn:hover {
    opacity: 1;
}

@keyframes slideIn {
    from {
        transform: translateX(20px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
/* ===== FORM ROW: LABEL | CONTROL ===== */
.modal-form-row {
  display: grid;
  grid-template-columns: 140px 1fr;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.modal-form-row label {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
  text-align: start;
  margin: 0;
}

.modal-form-row label span {
  color: #dc2626;
}

/* Inputs inside row */
.modal-form-row input,
.modal-form-row select,
.modal-form-row textarea {
  width: 100%;
  padding: 7px 8px;
  font-size: 13px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}
.modal-card,
.modal-card * {
  font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
.modal-card .fa,
.modal-card .fas,
.modal-card .fa-solid,
.modal-card .far,
.modal-card .fab {
  font-family: "Font Awesome 6 Free" !important;
  font-weight: 900; /* REQUIRED for solid icons */
}
.modal-card *:not(.fa):not(.fas):not(.fa-solid):not(.far):not(.fab) {
  font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
.employee-label {
    display: flex;
    flex-direction: column;
    align-items: start;
    justify-content: space-between;
    gap: 4px;
    width: 100%;
    padding: 6px 8px;
}
.employee-name-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;  /* Changed from space-between to flex-start */
    gap: 6px;
    width: 100%;
    min-width: 0;
}
.employee-hours-info {
    display: flex;
    align-items: center;
    justify-content: flex-start;  /* LEFT ALIGN */
    gap: 4px;
    font-size: 11px;
    color: #374151;
    line-height: 1.3;
    margin-top: 2px;
    width: 100%;
}

.employee-hours-row {
    display: flex;
    justify-content: flex-start;
    gap: 4px;
    align-items: center;
}

.hours-separator {
    color: #9ca3af;
    font-weight: 600;
}

.hours-value {
    position: relative;
    cursor: help;
    font-weight: 500;
}

.hours-value:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 0;
    background: #1f2937;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 6px;
}

.hours-value:hover::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 12px;
    border: 5px solid transparent;
    border-top-color: #1f2937;
    z-index: 1000;
    margin-bottom: 1px;
}
.employee-name {
    font-size: 13px;
    font-weight: 600;
    color: #682987;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-align: left;
    flex: 1; /* Take available space */
    min-width: 0; /* Critical for text truncation */
}
.employee-count {
    min-width: 22px;
    height: 22px;
    border-radius: 5px;
    background: #682987;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2px;
    flex-shrink: 0;
}
.employee-name-row i {
    flex-shrink: 0;
    margin-left: 4px;
}
.employee-label {
    display: flex;
    flex-direction: column;
    align-items: flex-start;  /* Changed from center to flex-start */
    justify-content: flex-start;
    gap: 4px;
    width: 100%;
    padding: 6px 8px;
}
.employee-name {
    flex: 1;
    font-size: 13px;
    font-weight: 600;
    color: #682987;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.employee-count {
    min-width: 22px;
    height: 22px;
    border-radius: 999px;
    background: #682987;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ICON */
.employee-status-icon {
    font-size: 14px;
    display: flex;
    align-items: center;
}

/* optional colors */
.employee-status-icon.car { color: #2563eb; }      /* blue */
.employee-status-icon.error { color: #dc2626; }    /* red */

/* ===============================
   WEEK VIEW – SECOND FIXED ROW
   =============================== */

/* Header wrapper already sticky – DO NOT REMOVE */
.week-header-row {
    position: sticky;
    top: 0;
    z-index: 120;
    background: #ffffff;
}

/* Holds date row + summary row */
.week-days-container {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ===== DATE ROW (already exists) ===== */
.week-days-header {
    display: flex;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

/* ===== NEW SUMMARY ROW ===== */
.week-days-summary {
    display: flex;
    background: #f3f4f6;
    border-bottom: 2px solid #e5e7eb;
}

/* IMPORTANT: SAME WIDTH RULE */
.week-day-header,
.week-day-summary-cell,
.week-day-column {
    flex: 1 1 0;
    min-width: 0;
    box-sizing: border-box;
}

/* Summary cell look */
.week-day-summary-cell {
    padding: 6px 8px;
    text-align: center;
    font-size: 11px;
    border-right: 1px solid #e5e7eb;
}

.week-day-summary-cell:last-child {
    border-right: none;
}

/* Text lines */
.week-summary-line {
    font-size: 11px;
    line-height: 1.2;
    font-weight: 600;
}

.week-summary-line.unfilled {
    color: #dc2626; /* red */
}

.week-summary-line.mismatch {
    color: #7c2d12; /* dark amber */
}
.quick-filter-popover {
    position: absolute;
    top: 60px;
    right: 30px;
    width: 260px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    padding: 12px;
    z-index: 900;
    display: none;
}

.quick-filter-popover.active {
    display: block;
}

.quick-filter-block {
    margin-bottom: 14px;
}

.quick-filter-label {
    font-size: 11px;
    font-weight: 700;
    color: #6b7280;
    text-transform: uppercase;
    margin-bottom: 6px;
}

/* DROPDOWN */
.quick-dropdown {
    position: relative;
}

.quick-dropdown-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    background: #fff;
}

.quick-dropdown-options {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    max-height: 200px;
    overflow-y: auto;
    display: none;
    z-index: 600;
}

.quick-dropdown.active .quick-dropdown-options {
    display: block;
}

.quick-dropdown-option {
    padding: 8px 10px;
    font-size: 13px;
    cursor: pointer;
}

.quick-dropdown-option:hover {
    background: #eef2ff;
}
.quick-dropdown-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    font-size: 13px;
    cursor: pointer;
}

.quick-dropdown-option.selected {
    background: #eef2ff;
    font-weight: 600;
}

.quick-dropdown-option i {
    font-size: 12px;
    color: #4f46e5;
}

/* ================= EVENT TOOLTIP ================= */

.event-tooltip {
    position: fixed;
    width: 260px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.18);
    padding: 10px 12px;
    font-size: 12px;
    z-index: 99999;
    pointer-events: none;
}

.event-tooltip.hidden {
    display: none;
}
.hidden {
    display: none !important;
}
.tt-row.hidden {
    display: none;
}
.tt-row {
    display: grid;
    grid-template-columns: 95px 1fr;
    gap: 6px;
    margin-bottom: 6px;
}

.tt-row:last-child {
    margin-bottom: 0;
}

.tt-label {
    font-weight: 600;
    color: #6b7280;
}

.tt-value {
    font-weight: 500;
    color: #111827;
    word-break: break-word;
}

.tt-warn {
    color: #b45309;
}
/* ===== MAIN CONTAINER ===== */
.calendar-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    height: 100vh; /* Full viewport height */
    overflow: hidden; /* Prevent container scroll */
}

/* ===== STICKY HEADER ===== */
.calendar-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
    border-bottom: 1px solid #e5e7eb;
    flex-shrink: 0; /* Don't shrink */
}

/* ===== STICKY SEARCH FILTERS (SECOND ROW) ===== */
.search-filters-section {
    padding: 10px 30px;
    background: #fafafa;
    border-bottom: 1px solid #e5e7eb;
    display: none;
    position: sticky;
    top: 0; /* Will stack below header naturally */
    z-index: 90;
    flex-shrink: 0; /* Don't shrink */
}

.search-filters-section.active {
    display: block;
}

/* ===== DAY VIEW ===== */
.day-view {
    display: none;
    flex: 1;
    overflow: hidden; /* No scroll here */
}

.day-view.active {
    display: flex;
    flex-direction: column;
}

.day-view-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

/* ===== STICKY DAY HEADER ROW ===== */
.day-header-row {
    display: flex;
    border-bottom: 2px solid #e5e7eb;
    background: white;
    position: sticky;
    top: 0;
    z-index: 50;
    flex-shrink: 0;
}

/* ===== SCROLLABLE BODY (SINGLE SCROLL) ===== */
.calendar-body-scrollable {
    flex: 1;
    overflow-y: auto !important; /* ✅ MUST have vertical scroll */
    overflow-x: hidden;
    position: relative;
    min-height: 0; /* Important for flex */
}


/* ===== DAY BODY ===== */
.day-body {
    display: flex;
    min-height: 100%; /* Allow it to grow */
}

.employee-column {
    flex: 0 0 150px;
    border-right: 2px solid #e5e7eb;
    background: #f9fafb;
    position: sticky;
    left: 0;
    z-index: 40;
    min-height: 100%; /* Match the scrollable area */
}

/* ===== HORIZONTAL SCROLL WRAPPER ===== */
.calendar-scroll-wrapper {
    flex: 1;
    overflow-x: auto; /* Horizontal scroll for hours */
    overflow-y: hidden; /* NO vertical scroll here */
    position: relative;
    min-height: 100%;
}
/* ===== HOUR HEADER STICKY ===== */
.hour-header-container {
    position: sticky;
    top: 0; /* Stick to top of scroll container */
    z-index: 45;
    background: white;
    border-bottom: 2px solid #e5e7eb;
}

.hour-header {
    display: flex;
    min-width: 2400px;
}

/* ===== WEEK VIEW ===== */
.week-view {
    display: none;
    flex: 1;
    overflow: hidden;
}

.week-view.active {
    display: flex;
    flex-direction: column;
}

.week-view-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

/* ===== WEEK SCROLL WRAPPER (SINGLE SCROLL) ===== */
.week-scroll-wrapper {
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* ✅ ONLY vertical scroll */
    overflow-x: auto; /* Horizontal for week days */
    flex: 1;
    position: relative;
}

/* ===== WEEK STICKY HEADER ===== */
.week-header-row {
    position: sticky;
    top: 0;
    z-index: 120;
    background: #ffffff;
    display: flex;
    border-bottom: 2px solid #e5e7eb;
    flex-shrink: 0;
}

.week-days-container {
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Remove scrollbar from header */
}

/* ===== WEEK BODY ===== */
.week-body {
    display: flex;
    flex: 1;
}

.week-employee-column {
    flex: 0 0 150px;
    border-right: 2px solid #e5e7eb;
    background: #f9fafb;
    position: sticky;
    left: 0;
    z-index: 40;
}

.week-calendar-rows {
    flex: 1;
    display: flex;
    flex-direction: column;
}
/* Employee working hours indicator */
.employee-working-hours {
    position: absolute;
    top: 0;
    bottom: 0;
    border: 0px;
    pointer-events: none;
    z-index: 5;
}
.employee-working-hours::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background: #22c55e;
}
.event-staff-badge {
    position: absolute;
    top: 0px;
    right: 0px;
    min-width: 18px;
    height: 15px;
    background: rgba(255, 255, 255, 0.95);
    color: #374151;
    font-size: 9px;
    font-weight: 700;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    z-index: 50;
    pointer-events: none;
}

.event-staff-badge i {
    font-size: 9px;
}
/* Sticky bottom horizontal scrollbar */
.day-bottom-scroll {
    position: sticky;
    bottom: 0;
    height: 14px;                 /* scrollbar height */
    overflow-x: auto;
    overflow-y: hidden;
    background: #fff;
    border-top: 1px solid #e5e7eb;
    z-index: 60;
}

/* This width MUST match your hour grid width */
.day-bottom-scroll-inner {
    width: 2400px;                /* SAME as .hour-header / .calendar-rows */
    height: 1px;
}

.event.selected {
    outline: 2px solid #111827;
    outline-offset: -2px;
}
.multi-drag-ghost .ghost {
    opacity: 0.7;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}
.event-modal-tabs {
    display: flex;
    gap: 6px;
    border-bottom: 1px solid #e5e7eb;
}

.tab-btn {
    padding: 8px 14px;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 600;
    color: #6b7280;
    border-bottom: 2px solid transparent;
}

.tab-btn.active {
    color: #111827;
    border-bottom-color: #4f46e5;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

.insight-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px dashed #e5e7eb;
}
.event-modal-tabs-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #e5e7eb;
  padding: 0 12px;
}

.event-modal-tabs {
  display: flex;
  gap: 6px;
}

.close-btn {
  font-size: 20px;
  line-height: 1;
  background: none;
  border: none;
  cursor: pointer;
}
/* ===== MULTI SELECT ===== */
.multi-select {
  position: relative;
  width: 100%;
}

.multi-select-input {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 6px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  cursor: text;
}

.multi-select-input:focus-within {
  border-color: #4f46e5;
  box-shadow: 0 0 0 2px rgba(79,70,229,0.2);
}

.multi-select-input input {
  border: none;
  outline: none;
  min-width: 120px;
  flex: 1;
  font-size: 13px;
}

.multi-pill {
  display: flex;
  align-items: center;
  background: #e0e7ff;
  color: #1e3a8a;
  border-radius: 999px;
  padding: 4px 8px;
  font-size: 12px;
  font-weight: 600;
  gap: 6px;
}

.multi-pill button {
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
}

/* DROPDOWN */
.multi-select-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  display: none;
  z-index: 3000;
}

.multi-select-dropdown.active {
  display: block;
}

.multi-option {
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}

.multi-option:hover {
  background: #eef2ff;
}
/* ===== INSIGHTS TABLE ===== */
.insights-table-container {
  overflow-x: auto;
  margin-top: 10px;
}

.insights-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.insights-table thead {
  background: #f3f4f6;
  border-bottom: 2px solid #e5e7eb;
}

.insights-table th {
  padding: 10px 12px;
  text-align: left;
  font-weight: 600;
  color: #374151;
  font-size: 12px;
  border-bottom: 1px solid #d1d5db;
}

.insights-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #e5e7eb;
  color: #111827;
}

.insights-table tbody tr:hover {
  background: #f9fafb;
}

.insights-table tbody tr:last-child td {
  border-bottom: none;
}

/* Text alignment for specific columns */
.insights-table td:nth-child(2) {
  text-align: center;
}

.insights-table th:nth-child(2) {
  text-align: center;
}
.modal-footer {
  padding: 12px 16px;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#visitTabButtons {
  display: flex;
  gap: 10px;
}
    </style>
</head>
<body>
    <div id="timeChangeConfirmModal" class="modal-overlay hidden">
  <div class="time-confirm-modal">
    <div class="time-confirm-header">
      <h3>Confirm Time Change</h3>
      <button class="time-confirm-close" onclick="cancelTimeChange()">×</button>
    </div>
    
    <div class="time-confirm-body">
      <p class="confirm-message">Are you sure you want to change the time?</p>
      
      <div class="time-comparison">
        <div class="time-row">
          <span class="time-label">From:</span>
          <span class="time-value old-time" id="confirmOldTime">09:00 - 10:00</span>
        </div>
        <div class="time-arrow">→</div>
        <div class="time-row">
          <span class="time-label">To:</span>
          <span class="time-value new-time" id="confirmNewTime">10:00 - 11:00</span>
        </div>
      </div>
      
      <div class="event-info">
        <div class="info-item">
          <span class="info-label">Event:</span>
          <span class="info-value" id="confirmEventTitle">Team Meeting</span>
        </div>
        <div class="info-item">
          <span class="info-label">Staff:</span>
          <span class="info-value" id="confirmEventStaff">John Doe</span>
        </div>
      </div>
    </div>
    
    <div class="time-confirm-footer">
      <button class="btn-cancel" onclick="cancelTimeChange()">Cancel</button>
      <button class="btn-confirm" onclick="confirmTimeChange()">Confirm</button>
    </div>
  </div>
</div>
    <div id="toast-container"></div>
    <div id="loadingOverlay">
    <div class="loader"></div>
    <div class="loading-text">Loading calendar…</div>
</div>
    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay" onclick="toggleSearch()"></div>

    <!-- Search Panel -->
    <div class="search-panel" id="searchPanel">
        <div class="search-header">
            <h2>Search</h2>
            <button class="close-search" onclick="toggleSearch()">×</button>
        </div>
        
        <div class="search-body">
    <!-- 1. Persons Filter (Restored) -->
    <div class="search-filter">
        <label>
            <input type="checkbox" name="persons" onchange="toggleFilterInputs('persons')">
            Persons
        </label>
        <div class="filter-inputs" id="persons-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="persons-filter-display" onclick="toggleFilterDropdown('persons')">
                        <span id="persons-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="persons-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('persons', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('persons', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="persons-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="persons-tags-group">
                <div class="tags-input-container" id="persons-tags-container" onclick="focusTagInput('persons')">
                    <input type="text" id="persons-tags-input" placeholder="" onkeydown="handleTagInput(event, 'persons')">
                </div>
            </div>
        </div>
    </div>
    <div class="search-filter">
        <label><input type="checkbox" name="staff" onchange="toggleFilterInputs('staff')"> Staff</label>
        <div class="filter-inputs" id="staff-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="staff-filter-display" onclick="toggleFilterDropdown('staff')">
                        <span id="staff-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="staff-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('staff', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('staff', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="staff-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="staff-tags-group">
                <div class="tags-input-container" id="staff-tags-container" onclick="focusTagInput('staff')">
                    <input type="text" id="staff-tags-input" onkeydown="handleTagInput(event, 'staff')">
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Advanced From Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="from" onchange="toggleFilterInputs('from')"> From</label>
        <div class="filter-inputs" id="from-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="from-filter-display" onclick="toggleFilterDropdown('from')">
                        <span id="from-filter-text">Is</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="from-filter-options">
                        <div class="filter-option-header">Basic</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'isNotEmpty', this)">Is Not Empty</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'before', this)">Before</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'after', this)">After</div>
                    </div>
                    <input type="hidden" id="from-filter" value="is">
                </div>
            </div>
            <div class="filter-input-group date-input-container" id="from-date-group" style="display:none;"><input type="time" id="from-date-val" class="filter-date-input"></div>
            <div class="filter-input-group n-input-container" id="from-n-group" style="display:none;"><label>Enter "n" value:</label><input type="number" id="from-n-val" class="filter-n-input" value="1" min="1"></div>
        </div>
    </div>

    <!-- 3. Advanced To Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="to" onchange="toggleFilterInputs('to')"> To</label>
        <div class="filter-inputs" id="to-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="to-filter-display" onclick="toggleFilterDropdown('to')">
                        <span id="to-filter-text">Is</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="to-filter-options">
                        <div class="filter-option-header">Basic</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectDateFilterOption('to', 'isNotEmpty', this)">Is Not Empty</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'before', this)">Before</div>
                        <div class="filter-option" onclick="selectDateFilterOption('from', 'after', this)">After</div>
                    </div>
                    <input type="hidden" id="to-filter" value="is">
                </div>
            </div>
            <div class="filter-input-group date-input-container" id="to-date-group" style="display:none;"><input type="time" id="to-date-val" class="filter-date-input"></div>
            <div class="filter-input-group n-input-container" id="to-n-group" style="display:none;"><label>Enter "n" value:</label><input type="number" id="to-n-val" class="filter-n-input" value="1" min="1"></div>
        </div>
    </div>

    <!-- 5. Service Filter -->
    <div class="search-filter">
        <label><input type="checkbox" name="service" onchange="toggleFilterInputs('service')"> Service</label>
        <div class="filter-inputs" id="service-inputs">
            <div class="filter-input-group">
                <div class="filter-select-wrapper">
                    <div class="filter-select" id="service-filter-display" onclick="toggleFilterDropdown('service')">
                        <span id="service-filter-text">Contains</span>
                        <svg class="filter-select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="#6b7280" d="M6 9L1 4h10z"/></svg>
                    </div>
                    <div class="filter-options" id="service-filter-options">
                        <div class="filter-option" onclick="selectFilterOption('service', 'contains', this)">Contains</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'is', this)">Is</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'isNot', this)">Is Not</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'isEmpty', this)">Is Empty</div>
                        <div class="filter-option" onclick="selectFilterOption('service', 'isNotEmpty', this)">Is Not Empty</div>
                    </div>
                    <input type="hidden" id="service-filter" value="contains">
                </div>
            </div>
            <div class="filter-input-group" id="service-tags-group">
                <div class="tags-input-container" id="service-tags-container" onclick="focusTagInput('service')">
                    <input type="text" id="service-tags-input" onkeydown="handleTagInput(event, 'service')">
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Staff Filter -->
    
</div>
        
        <div class="search-footer">
            <button class="search-btn" onclick="performSearch()">Search</button>
        </div>
    </div>

    <div class="calendar-container">
        
        <div class="calendar-header">
             <div style="display: flex; align-items: center; gap: 10px;">
        <div class="view-switcher">
            <button class="view-switcher-btn" onclick="toggleViewSwitcher(event)">
                <i class="fa fa-th-list"></i>
                <span id="currentViewType">Staff</span>
                <i class="fa fa-chevron-down" style="font-size: 10px;"></i>
            </button>
            <div class="view-switcher-dropdown" id="viewSwitcherDropdown">
               
            </div>
        </div>
        
        <!-- Week/Day Toggle -->
        <div class="view-toggle">
            <button id="weekViewBtn" onclick="switchView('week')">Week</button>
            <button id="dayViewBtn" class="active" onclick="switchView('day')">Day</button>
        </div>
    </div>
            <!-- Search Filters Display Section -->
        

            <div class="date-title" id="dateTitle"></div>
            <div class="header-controls">
                <button class="nav-btn" onclick="navigatePeriod(-1)"><i class="fa fa-angle-left"></i></button>
                <button class="nav-btn" onclick="navigatePeriod(1)"><i class="fa fa-angle-right"></i></button>
                <button class="nav-btn" onclick="goToday()">Today</button>
                <div class="info-btn-wrapper">
                    <button class="info-btn" onclick="toggleInfoDropdown(event)">
                        <i class="fa fa-info-circle"></i>
                    </button>
                    <div class="info-tooltip">Capacity</div>
                    
                    <div class="info-dropdown" id="infoDropdown">
                        <div class="info-dropdown-header">Capacity</div>
                        
                        <div class="info-stat-row">
                            <span class="info-stat-label">Required Hours:</span>
                            <span class="info-stat-value" id="statRequiredHours">0.0h</span>
                        </div>
                        
                        <div class="info-stat-row">
                            <span class="info-stat-label">Carers Working:</span>
                            <span class="info-stat-value highlight" id="statCarersWorking">0</span>
                        </div>
                        
                        <div class="info-stat-row">
                            <span class="info-stat-label">Carers Working Hours:</span>
                            <span class="info-stat-value" id="statCarersHours">0.0h</span>
                        </div>
                    </div>
                </div>  
                <button class="calendar-icon" onclick="toggleSearch()"><i class="fa fa-search fa-lg"></i></button>
                <button class="calendar-icon" onclick="goToday()"><i class="fa-solid fa-arrow-rotate-right"></i></i></button>
                <button class="calendar-icon" onclick="toggleQuickFilter(event)">
    <i class="fa fa-filter fa-lg"></i>
</button>

<div class="quick-filter-popover" id="quickFilterPopover">

    <!-- EMPLOYEE -->
    <div class="quick-filter-block">
        <div class="quick-filter-label">Staff</div>

        <div class="quick-dropdown" data-field="employee">
            <div class="quick-dropdown-display" onclick="toggleQuickDropdown(this)">
                <span>Select Staff</span>
                <i class="fa fa-chevron-down"></i>
            </div>
            <div class="quick-dropdown-options"></div>
        </div>
    </div>
     <div class="quick-filter-block">
        <div class="quick-filter-label">Person</div>

        <div class="quick-dropdown" data-field="persons">
            <div class="quick-dropdown-display" onclick="toggleQuickDropdown(this)">
                <span>Select Person</span>
                <i class="fa fa-chevron-down"></i>
            </div>
            <div class="quick-dropdown-options"></div>
        </div>
    </div>
    <!-- STAFF -->
    <div class="quick-filter-block">
        <div class="quick-filter-label">Services</div>

        <div class="quick-dropdown" data-field="service">
            <div class="quick-dropdown-display" onclick="toggleQuickDropdown(this)">
                <span>Select Service</span>
                <i class="fa fa-chevron-down"></i>
            </div>
            <div class="quick-dropdown-options"></div>
        </div>
    </div>

</div>
                <button class="calendar-icon" onclick="toggleMiniCalendar()"><i class="fa fa-calendar fa-lg"></i></button>
            </div>
        </div>
<div class="search-filters-section" id="searchFiltersSection">
    <div class="search-filters-container" id="searchFiltersContainer">
    </div>
</div>
        
        <div class="mini-calendar" id="miniCalendar">
            <div class="mini-header">
                <span id="miniMonthYear">JANUARY 2026</span>
                <div class="mini-nav">
                    <button class="nav-btn" onclick="changeMiniMonth(-1)">‹</button>
                    <button class="nav-btn" onclick="changeMiniMonth(1)">›</button>
                </div>
            </div>
            <div class="mini-grid" id="miniGrid">
                <div class="mini-day-label">Su</div>
                <div class="mini-day-label">Mo</div>
                <div class="mini-day-label">Tu</div>
                <div class="mini-day-label">We</div>
                <div class="mini-day-label">Th</div>
                <div class="mini-day-label">Fr</div>
                <div class="mini-day-label">Sa</div>
            </div>
        </div>

        <!-- Day View with Employee Rows -->
        <div class="day-view active" id="dayView">
            <div class="day-view-container">
                        <div class="calendar-body-scrollable">

                <div class="day-header-row sticky-header">
                    <div class="employee-header employee-header-controls">
    <input 
        type="text" 
        id="employeeSearchInput" 
        placeholder="Search staff"
        oninput="filterEmployees(this.value)"
    />
</div>
                    <div class="hour-header-container">
                        <div class="hour-header" id="hourHeader"></div>
                    </div>
                </div>
                <div class="day-body">
                    <div class="employee-column" id="employeeColumn"></div>
                    <div class="calendar-scroll-wrapper" id="calendarScrollWrapper">
                        <div class="calendar-rows" id="calendarRows"></div>
                    </div>
                </div>
            </div>
            <div class="day-bottom-scroll">
            <div class="day-bottom-scroll-inner"></div>
        </div>
          </div>
        </div>

        <!-- Week View with Employee Rows -->
        <!-- <div class="week-view" id="weekView">
            <div class="week-view-container">
                <div class="week-header-row">
                    <div class="week-employee-header">Employee</div>
                    <div class="week-days-container">
                        <div class="week-days-header" id="weekDaysHeader"></div>
                    </div>
                </div>
                <div class="week-body">
                    <div class="week-employee-column" id="weekEmployeeColumn"></div>
                    <div class="week-scroll-wrapper" id="weekScrollWrapper">
                        <div class="week-calendar-rows" id="weekCalendarRows"></div>
                    </div>
                </div>
            </div>
        </div> -->
    <!-- Week View with Employee Rows -->
        <div class="week-view" id="weekView">
            <div class="week-view-container">
    <div class="week-scroll-wrapper" id="weekScrollWrapper">
 
        <!-- STICKY HEADER INSIDE SCROLL -->
        <div class="week-header-row sticky-header">
            <div class="week-employee-header">Staff</div>
            <div class="week-days-container">
                <div class="week-days-header" id="weekDaysHeader"></div>
                <div class="week-days-summary" id="weekDaysSummary"></div>
            </div>
        </div>
 
        <!-- SCROLLING BODY -->
        <div class="week-body">
            <div class="week-employee-column" id="weekEmployeeColumn"></div>
            <div class="week-calendar-rows" id="weekCalendarRows"></div>
        </div>
 
    </div>
</div>
 
        </div>    
    
    </div>
    </div>


<div id="eventModal" class="modal-overlay hidden">
  <div class="modal-card">

    <!-- Header -->
    <!-- Header + Tabs -->
<div class="event-modal-tabs-header">

  <div class="event-modal-tabs">
    <button class="tab-btn active" data-tab="visit">Visit</button>
    <button class="tab-btn" data-tab="travel">Travel</button>
    <button class="tab-btn" data-tab="insights">Insights</button>
  </div>

  <button class="close-btn" onclick="closeEventModal()">×</button>

</div>


    <!-- Scrollable Body -->
    <div class="modal-body">

      <!-- ================= VISIT TAB ================= -->
      <div class="tab-panel active" id="tab-visit">

        <div class="modal-form-row">
          <label>Service</label>
          <input id="mService" class="modal-input" type="text" disabled>
        </div>

        <div class="modal-form-row">
          <label>Person</label>
          <input id="mPerson" class="modal-input" type="text" disabled>
        </div>

        <div class="modal-form-row">
          <label>Visit Title</label>
          <input class="modal-input" type="text" id="mTitle">
        </div>

        <div class="modal-form-row">
          <label>Date <span>*</span></label>
          <input class="modal-input" type="date" id="mDate">
        </div>

        <div class="modal-form-row">
          <label>From <span>*</span></label>
          <input class="modal-input" type="time" id="mFrom">
        </div>

        <div class="modal-form-row">
          <label>Duration</label>
          <input class="modal-input" type="text" id="mDuration" disabled>
        </div>

        <div class="modal-form-row">
          <label>To <span>*</span></label>
          <input class="modal-input" type="time" id="mTo">
        </div>

        <!-- STATUS -->
        <div class="modal-form-row">
          <label>Status <span>*</span></label>

          <div class="custom-dropdown" data-field="status">
            <div class="custom-dropdown-display" onclick="toggleCustomDropdown(this)">
              <span id="mStatusText">Not Started</span>
              <i class="fa fa-chevron-down"></i>
            </div>

            <div class="custom-dropdown-options">
              <div class="custom-dropdown-option" onclick="selectCustomOption(this,'Not Started')">Not Started</div>
              <div class="custom-dropdown-option" onclick="selectCustomOption(this,'Completed')">Completed</div>
              <div class="custom-dropdown-option" onclick="selectCustomOption(this,'Not Completed')">Not Completed</div>
              <div class="custom-dropdown-option" onclick="selectCustomOption(this,'Missed')">Missed</div>
              <div class="custom-dropdown-option" onclick="selectCustomOption(this,'Started')">Started</div>
              <div class="custom-dropdown-option" onclick="selectCustomOption(this,'Inactive')">Inactive</div>
              <div class="custom-dropdown-option" onclick="selectCustomOption(this,'Cancelled')">Cancelled</div>
            </div>
          </div>

          <input type="hidden" id="mStatus" value="Not Started">
        </div>

        <!-- STAFF -->
        <div class="modal-form-row">
  <label>Staff <span>*</span></label>

  <div class="multi-select" id="staffMultiSelect">
    <div class="multi-select-input" id="staffMultiInput">
      <!-- pills injected here -->
      <input
        type="text"
        id="staffSearchInput"
        placeholder="Select staff"
        autocomplete="off"
      />
    </div>

    <div class="multi-select-dropdown" id="staffDropdown"></div>
  </div>
</div>


        <div class="modal-form-row">
          <label>Manager Notes</label>
          <textarea class="modal-input" rows="3" id="mNotes"></textarea>
        </div>

      </div>

      <!-- ================= TRAVEL TAB ================= -->
      <div class="tab-panel" id="tab-travel">

  <div id="travelDetailsContainer">
    
    <!-- Loading state -->
    <div id="travelLoading" class="travel-loading">
      <i class="fa fa-spinner fa-spin"></i> Loading travel details...
    </div>

    <!-- No data state -->
    <div id="travelNoData" class="travel-no-data" style="display: none;">
      <i class="fa fa-info-circle"></i> No travel information available for this appointment.
    </div>

    <!-- Travel details content -->
    <div id="travelContent" style="display: none;">
      
      <!-- Before Travel Section -->
      <div class="travel-section" id="beforeTravelSection" style="display: none;">
        <h4 class="travel-section-title">
          <i class="fa fa-arrow-right"></i> Travel To Appointment
        </h4>
        
        <div class="travel-info-grid">
          <div class="travel-info-item">
            <span class="travel-label">From:</span>
            <span class="travel-value" id="travelBeforeName">—</span>
          </div>
          
          <div class="travel-info-item">
            <span class="travel-label">Distance:</span>
            <span class="travel-value" id="travelBeforeDist">—</span>
          </div>
          
          <div class="travel-info-item">
            <span class="travel-label">Duration:</span>
            <span class="travel-value" id="travelBeforeDur">—</span>
          </div>
          <div class="travel-info-item">
            <span class="travel-label">Available:</span>
            <span class="travel-value" id="travelAvail">—</span>
          </div>
        </div>
      </div>

      <!-- After Travel Section -->
      <div class="travel-section" id="afterTravelSection" style="display: none;">
        <h4 class="travel-section-title">
          <i class="fa fa-arrow-left"></i> Travel From Appointment
        </h4>
        
        <div class="travel-info-grid">
          <div class="travel-info-item">
            <span class="travel-label">To:</span>
            <span class="travel-value" id="travelAfterName">—</span>
          </div>
          
          <div class="travel-info-item">
            <span class="travel-label">Distance:</span>
            <span class="travel-value" id="travelAfterDist">—</span>
          </div>
          
          <div class="travel-info-item">
            <span class="travel-label">Duration:</span>
            <span class="travel-value" id="travelAfterDur">—</span>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>


      <!-- ================= INSIGHTS TAB ================= -->
      <div class="tab-panel" id="tab-insights">

        <div class="insights-table-container">
    <table class="insights-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>No of Visits</th>
          <th>Available/Overlap</th>
          <th>Skills</th>
          <th>Locality</th>
          <th>Exclude</th>
        </tr>
      </thead>
      <tbody id="insightsTableBody">
        <!-- Rows will be populated dynamically -->
      </tbody>
    </table>
  </div>

      </div>

    </div>

    <!-- Footer -->
    <div class="modal-footer">
        <div id="visitTabButtons" style="display: flex; gap: 10px;">
      <button class="btn-secondary" onclick="closeEventModal()">Cancel</button>
      <button class="btn-primary" onclick="saveEvent()">Save</button>
      </div>
    </div>

  </div>
</div>

<div id="eventTooltip" class="event-tooltip hidden">
    <div class="tt-row">
        <span class="tt-label">Service User</span>
        <span class="tt-value" id="ttServiceUser"></span>
    </div>
    <div class="tt-row">
        <span class="tt-label">Staff</span>
        <span class="tt-value" id="ttStaff"></span>
    </div>
    <div class="tt-row">
        <span class="tt-label">Time</span>
        <span class="tt-value" id="ttTime"></span>
    </div>
    <div class="tt-row hidden" id="ttMismatchRow">
        <span class="tt-label">Status</span>
        <span class="tt-value tt-warn" id="ttMismatch"></span>
    </div>
    <div class="tt-row hidden" id="ttTravelRow">
        <span class="tt-label">Next Travel</span>
        <span class="tt-value" id="ttTravel"></span>
    </div>
    <div class="tt-row hidden" id="ttFemaleOnly">
        <span class="tt-label">Female Only</span>
        <span class="tt-value" id="ttFemal"></span>
    </div>
    <div class="tt-row hidden" id="ttTimeCritical">
        <span class="tt-label">Time Critical</span>
        <span class="tt-value" id="ttTimeCrict"></span>
    </div>
</div>
<div class="status-legend">
            <div class="status-legend-item">
                <div class="status-legend-box not-started"></div>
                <span class="status-legend-label">Not Started</span>
            </div>
            <div class="status-legend-item">
                <div class="status-legend-box started"></div>
                <span class="status-legend-label">Started</span>
            </div>
            <div class="status-legend-item">
                <div class="status-legend-box completed"></div>
                <span class="status-legend-label">Completed</span>
            </div>
            <div class="status-legend-item">
                <div class="status-legend-box not-completed"></div>
                <span class="status-legend-label">Not Completed</span>
            </div>
            <div class="status-legend-item">
                <div class="status-legend-box missed"></div>
                <span class="status-legend-label">Missed</span>
            </div>
            <div class="status-legend-item">
                <div class="status-legend-box cancelled"></div>
                <span class="status-legend-label">Cancelled</span>
            </div>
            <div class="status-legend-item">
                <div class="status-legend-box overlapped"></div>
                <span class="status-legend-label">Overlapped</span>
            </div>
        </div>
    <script>
        let inital_load = false;
        const selectedEventIds = new Set();
        let currentViewType = 'employee'; 
let runGroups = []; 
let runGroupDetails = {}; 
let persons = [];
let personDetails = {};
        function toggleEventSelection(eventEl) {
    const eventKey = eventEl.dataset.eventKey; 

    if (selectedEventIds.has(eventKey)) {
        selectedEventIds.delete(eventKey);
        eventEl.classList.remove('selected');
    } else {
        selectedEventIds.add(eventKey);
        eventEl.classList.add('selected');
    }
}

function clearEventSelection() {
    selectedEventIds.forEach(eventKey => {
        document
            .querySelector(`.event[data-event-key="${eventKey}"]`)
            ?.classList.remove('selected');
    });
    selectedEventIds.clear();
}

const mainScroll = document.getElementById('calendarScrollWrapper');
const bottomScroll = document.querySelector('.day-bottom-scroll');

let isSyncing = false;

mainScroll.addEventListener('scroll', () => {
    if (isSyncing) return;
    isSyncing = true;
    bottomScroll.scrollLeft = mainScroll.scrollLeft;
    isSyncing = false;
});

bottomScroll.addEventListener('scroll', () => {
    if (isSyncing) return;
    isSyncing = true;
    mainScroll.scrollLeft = bottomScroll.scrollLeft;
    isSyncing = false;
});

        let activeEvent = null;

function openEventModal(evt) {
  
  const status = evt.event_status ? evt.event_status.replace('_', ' ') : 'Not Started';

  const statusInput = document.getElementById('mStatus');
  const statusText  = document.getElementById('mStatusText');
  console.log(statusInput,statusText);
  
  document.getElementById('mPerson').value =
    evt.title  || '';
 const [dd, MM, yyyy] = evt.date.split('-');
    document.getElementById('mDate').value = `${yyyy}-${MM}-${dd}`;
    document.getElementById('mFrom').value = minutesToHHMM(evt.startMinutes || 0);
    document.getElementById('mTo').value = minutesToHHMM(evt.endMinutes || 0);
    const durationMins = (evt.endMinutes || 0) - (evt.startMinutes || 0);
    document.getElementById('mDuration').value = minutesToHHMM(durationMins || 0   );
    document.getElementById('mNotes').value = evt.Manager_Notes || '';
    document.getElementById('mService').value = evt.service || '';
    const isTimeCritical = evt.Time_Critical_Visit === "Yes";
    const fromInput = document.getElementById('mFrom');
    const toInput = document.getElementById('mTo');
    fromInput.disabled = isTimeCritical;
    toInput.disabled = isTimeCritical;

  if (statusInput && statusText) {
    statusInput.value = status;
    statusText.textContent = status;
  }
  activeEvent = evt;
 
   const groupRows = getEventGroupRows(evt);

  const staffList = groupRows
    .map(e => e.employee)
    .filter(Boolean);

  initStaffMultiSelect(staffList);
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.tab-btn[data-tab="visit"]').classList.add('active');
  
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-visit').classList.add('active');

  // Show Visit tab buttons
  document.getElementById('visitTabButtons').style.display = 'flex';

  document.getElementById('eventModal').classList.remove('hidden');
  
  // ✅ Add event listeners for tab switching (remove old ones first)
  setupTabSwitching();

  // OTHER FIELDS (example)
  const titleEl = document.getElementById('mTitle');
  if (titleEl) titleEl.value = evt.title || '';


  document.getElementById('eventModal').classList.remove('hidden');
  document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;

    document.querySelectorAll('.tab-btn')
      .forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.tab-panel')
      .forEach(p => p.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
  });
});

  
}


/* CLOSE */
function closeEventModal() {
  document.getElementById('eventModal').classList.add('hidden');
  activeEvent = null;
}

/* SAVE (UI level only) */
async function saveEvent() {    
  const from = document.getElementById('mFrom').value;
  const to = document.getElementById('mTo').value;
  const [shours, sminutes] = from.split(":").map(Number);
  var temp_start = shours * 60 + sminutes;
  const [ehours, eminutes] = to.split(":").map(Number);
  var temp_end = ehours * 60 + eminutes;
  if( temp_end < temp_start ){
    showToast("To Time can't greater than from time");
    return;
  }
  if ( !document.getElementById("mDate").value || !from || !to  || ! document.getElementById('mStatus').value )   {
     showToast("Date,From,To,Status and Staff are Mandatory", "error");
    return;
  }
   if (!activeEvent) return;
   activeEvent.startMinutes = timeToMinutes(document.getElementById('mFrom').value);
   activeEvent.endMinutes = timeToMinutes(document.getElementById('mTo').value);
//    activeEvent.employee = document.getElementById('mStaff').value;
   let cur_sts = document.getElementById('mStatus').value.replace(' ', '_');
   activeEvent.status = cur_sts;
   activeEvent.event_status = cur_sts.replace(' ', '_');
   activeEvent.Manager_Notes = document.getElementById('mNotes').value;
//    activeEvent.staff = document.getElementById('mStaff').value; 
   activeEvent.startMinute = temp_start;
   activeEvent.endMinutes = temp_end;
   activeEvent.from = `${from}`;
   activeEvent.to = `${to}`;
   const [yyyy, mm, dd] = document.getElementById('mDate').value.split('-');
   activeEvent.date = `${dd}-${mm}-${yyyy}`;
    const dateKey = toYYYYMMDD(activeEvent.date);
  const rows = getEventGroupRows(activeEvent);

 const unassignedRows = rows.filter(isUnassigned);
const assignedRows   = rows.filter(r => !isUnassigned(r));

const existingStaff = assignedRows.map(r => r.employee);

const toAdd    = selectedStaff.filter(s => !existingStaff.includes(s));
const toRemove = existingStaff.filter(s => !selectedStaff.includes(s));

assignedRows
  .filter(r => selectedStaff.includes(r.employee))
  .forEach(evt => {
    evt.from = `${from}`;
    evt.to = `${to}`;
    evt.startMinutes = temp_start;
    evt.endMinutes = temp_end;
    evt.status = cur_sts;
    evt.event_status = cur_sts.replace('_', ' ');
    evt.date = `${dd}-${mm}-${yyyy}`;
    evt.Manager_notes = document.getElementById('mNotes').value;
  });


if (toRemove.length) {
  eventDatabase[dateKey] = eventDatabase[dateKey].filter(evt =>
    !(
      isSameLogicalEvent(evt, activeEvent) &&
      toRemove.includes(evt.employee)
    )
  );
  ensurePlaceholderRow(activeEvent);
}

toAdd.forEach((staff, index) => {
  if (unassignedRows[index]) {
    console.log(activeEvent.event_status);
    
    unassignedRows[index].employee = staff;
    unassignedRows[index].from = `${from}`;
    unassignedRows[index].to = `${to}`;
    unassignedRows[index].startMinutes = temp_start;
    unassignedRows[index].endMinutes = temp_end;
    unassignedRows[index].status = cur_sts;
    unassignedRows[index].event_status = cur_sts.replace('_', ' ');
    unassignedRows[index].date = `${dd}-${mm}-${yyyy}`;
    unassignedRows[index].Manager_notes = document.getElementById('mNotes').value;
    if( staff ){
               employee_id =  employeeDetails.find(emp => emp.name === staff).id;
            }
            else{
                employee_id = null;
            }
            unassignedRows[index].employee_id = employee_id;
  } else {
    const base = assignedRows[0] || rows[0] || activeEvent;
    const newEvt = cloneEventForEmployee(base, staff);
    eventDatabase[dateKey].push(newEvt);
  }
});
  showLoader();
  await updateEventZoho(activeEvent);
  if (currentView === 'day') {
    if (currentViewType === 'employee') {
      await renderDayView();
    } else {
      await renderRunView();
    }
  } else {
    await renderWeekView();
  }
  closeEventModal();
  hideLoader();
}

/* HELPERS */
function minutesToTime(mins) {
  const h = String(Math.floor(mins / 60)).padStart(2, '0');
  const m = String(mins % 60).padStart(2, '0');
  return `${h}:${m}`;
}

function timeToMinutes(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function populateStaffDropdown(selected) {
  const container = document.getElementById('mStaffOptions');
  container.innerHTML = '';

  employees.forEach(emp => {
    const div = document.createElement('div');
    div.className = 'custom-dropdown-option';
    div.textContent = emp;
    div.onclick = () => {
      document.getElementById('mStaffText').textContent = emp;
      document.getElementById('mStaff').value = emp;
      container.closest('.custom-dropdown').classList.remove('active');
    };
    container.appendChild(div);
  });

  if (selected) {
    document.getElementById('mStaffText').textContent = selected;
    document.getElementById('mStaff').value = selected;
  }
}

function showToast(message, type = 'error', duration = 3000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    toast.innerHTML = `
        <span>${message}</span>
        <span class="close-btn">×</span>
    `;

    toast.querySelector('.close-btn').onclick = () => {
        toast.remove();
    };

    container.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, duration);
}

function toggleCustomDropdown(el) {
  const dropdown = el.closest('.custom-dropdown');

  document.querySelectorAll('.custom-dropdown.active')
    .forEach(d => d !== dropdown && d.classList.remove('active'));

  dropdown.classList.toggle('active');
}

function selectCustomOption(optionEl, value) {
  const dropdown = optionEl.closest('.custom-dropdown');
  const field = dropdown.dataset.field;

  dropdown.querySelector('span').textContent = value;
  document.getElementById(`m${capitalize(field)}`).value = value;

  dropdown.classList.remove('active');
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

document.addEventListener('click', e => {
  document.querySelectorAll('.custom-dropdown.active').forEach(dd => {
    if (!dd.contains(e.target)) dd.classList.remove('active');
  });
});


let mouseDownX = 0;
let mouseDownY = 0;
const CLICK_TOLERANCE = 5;
            // const DEFAULT_DAY_START_HOUR = 6;

        const EMPTY_GRID_HEIGHT = 120;

        const MIN_RESIZE_MINUTES = 15;
        const PIXELS_PER_HOUR = 100;
        const DEFAULT_DAY_START_HOUR = 6;
                scrollLeft = 6 * PIXELS_PER_HOUR;

        const PIXELS_PER_15_MIN = PIXELS_PER_HOUR / 4;
        // 28 to 70
        const MIN_ROW_HEIGHT = 70;  

        const CALENDAR_BODY_SELECTOR = '.calendar-body-scrollable';


        const EVENT_HEIGHT = 30;
        const EVENT_GAP = 4;
        const ROW_PADDING = 6;

        let currentDate = new Date();

        let todayDate = new Date();
        let draggedElement = null;
        let draggedEventId = null;
        let draggedEventData = null;
        let currentView = 'day';

        let resizeEvent = null;
        let resizeDirection = null;
        let resizeStartX = 0;
        let originalStart = 0;
        let originalEnd = 0;

        let loginUser = null;
        let app_name = null;
        let userService = null;
        let services = [];
        let services_details = [];

        function showLoader() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('hidden');
}

function hideLoader() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.add('hidden');
}

    
       async function getZohoData() {
    try {
        let initparam = await ZOHO.CREATOR.UTIL.getInitParams();

        app_name = initparam.appLinkName;
        loginUser = initparam.loginUser;

        let get_service = {
            app_name: app_name,
            report_name: "Sites_Access_Details_Report",
            criteria: `(Staff_Email.contains("${loginUser}"))`
        };

        let service_resp = await ZOHO.CREATOR.DATA.getRecords(get_service);

        if (service_resp.code === 3000 && Array.isArray(service_resp.data)) {
            service_resp.data.forEach(rec => {
                services.push(rec.ID);
                services_details.push({
  [String(rec.Centre_Name).trim()]: rec.ID
});

            });
        } else {
            console.error("Zoho response error:", service_resp);
        }
        console.log(services_details);
        // await getTodayAllEmployees();
        await getBookings();

    } catch (err) {
        console.log("getZohoData failed:", err);
    }
}

       async function getTodayAllEmployees() {
        console.log("Today Called");
        employees.length = 0;
        employees.push('');
        
        const serviceList = `[${services.join(",")}]`;
        let employees_config;
        let employees_config1;
        if( currentView == "day" ){
            employees_config = {
            app_name,
            report_name: "Daily_Shift_Report",
            criteria: "(Date_From == '" + formatDateDDMMYYYY(currentDate) + "')"
        };

        employees_config1 = {
            app_name,
            report_name: "Bookings_Backend",
            criteria: `Site_Name.ID == ${serviceList} && Care_Providers != null && Date_field1 == '${formatDateDDMMYYYY(currentDate)}'`
        }
        }
        else{
            // const criteria_2 = `Site_Name.ID == ${serviceList} && Date_field1 >= '${zoho_start_date}' && Date_field1 <= '${zoho_end_date}'`;

            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            let zoho_start_date = formatDateDDMMYYYY( weekStart );
            let zoho_end_date = formatDateDDMMYYYY( weekEnd );

             employees_config = {
            app_name,
            report_name: "Daily_Shift_Report",
            criteria: `Date_From >= '${zoho_start_date}' &&  Date_From <= ${zoho_end_date} `
        };

        employees_config1 = {
            app_name,
            report_name: "Bookings_Backend",
            criteria: `Site_Name.ID == ${serviceList} && Care_Providers != null && Date_field1 >= '${zoho_start_date}' && Date_field1 <= '${zoho_end_date}' `
        }
        }
    try {
        // const employees_config = {
        //     app_name,
        //     report_name: "Daily_Shift_Report",
        //     criteria: "(Date_From == '" + formatDateDDMMYYYY(currentDate) + "')"
        // };

        // const employees_config1 = {
        //     app_name,
        //     report_name: "Bookings_Backend",
        //     criteria: `Site_Name.ID == ${serviceList} && Care_Providers != null && Date_field1 == '${formatDateDDMMYYYY(currentDate)}'`
        // }
        const employee_res = await ZOHO.CREATOR.DATA.getRecords(employees_config);
        
        if (employee_res.code === 3000 && employee_res.data?.length) {

            for (const rec of employee_res.data) {
                const name = rec.Staff?.zc_display_value;
                const staffId = rec.Staff?.ID;

                if (!name || !staffId || employees.includes(name)) continue;

                const skills_config = {
                    app_name,
                    report_name: "Staffs_Details_Backend",
                    id: `${staffId}`
                };
                
                const skills_res = await ZOHO.CREATOR.DATA.getRecordById(skills_config);
                let skills = [];
                if (skills_res.code === 3000) {
    skills = (skills_res?.data?.Skills_Experience_Capacity || [])
        .map(s => s?.Skills_Name)
        .filter(Boolean);
}
                
                employees.push(name);
                employeeDetails.push({
                    name,
                    id: staffId,
                    skills
                });
            }
        }    
        const employee_res1 = await ZOHO.CREATOR.DATA.getRecords(employees_config1);
        
       if (employee_res1.code === 3000 && employee_res1.data?.length) {

    for (const rec of employee_res1.data) {

        const staffList = Array.isArray(rec.Care_Providers)
            ? rec.Care_Providers
            : rec.Care_Providers
                ? [rec.Care_Providers]
                : [];
        
        for (const staff of staffList) {
            
            const name = staff?.zc_display_value;
            const id = staff?.ID;
            
            if (!name || !id) continue;
            
            
            if (employees.includes(name)) continue;
            const skills_config = {
                app_name,
                report_name: "Staffs_Details_Backend",
                id: `${id}`
            };

            const skills_res = await ZOHO.CREATOR.DATA.getRecordById(skills_config);

           if (skills_res.code === 3000) {
    skills = (skills_res?.data?.Skills_Experience_Capacity || [])
        .map(s => s?.Skills_Name)
        .filter(Boolean);
}
            employees.push(name);

            employeeDetails.push({
                name,
                id,
                skills
            });
        }
    }
}

        employees.sort();
        await getEmployeeShifts(currentDate);
    } catch (err) {
        if (err?.responseText) {
            const res = JSON.parse(err.responseText);
            if (res.code === 9280) {
                console.warn("No employees for selected date");
                return;
            }
        }
        console.error("getTodayAllEmployees failed:", err);
    }
}

        async function getBookingsForWeek(){
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            let zoho_start_date = formatDateDDMMYYYY( weekStart );
            let zoho_end_date = formatDateDDMMYYYY( weekEnd );
            const serviceList = `[${services.join(",")}]`;
            const criteria_2 = `Site_Name.ID == ${serviceList} && Date_field1 >= '${zoho_start_date}' && Date_field1 <= '${zoho_end_date}'`;
            console.log(criteria_2);
            
            var booking = {
                app_name: app_name,
                report_name: "Bookings_Backend",
                criteria: criteria_2
            };
           try{
            booking_resp = await ZOHO.CREATOR.DATA.getRecords(booking);
            
            eventDatabase = {};
                booking_resp.data.forEach(function (rec) {
                    let date_booking = [];
                    if( rec.Care_Providers.length === 0 ){
                        let cur_book = createBookingObject(rec, null);
                        date_booking.push(cur_book);
                    }
                    
                    rec.Care_Providers.forEach(function (emp) {
                       let cur_book = createBookingObject(rec, emp);
                        date_booking.push(cur_book);
                    });
                    
                    const key = toYYYYMMDD( rec.Date_field1 );            
                    if (!eventDatabase[key]) {
                        eventDatabase[key] = [];
                    }
                    eventDatabase[key].push(...date_booking);  
                });
            }
            catch(e){
                console.log(e);
                
            }
        }

        function toYYYYMMDD(ddmmyyyy) {
            const [dd, mm, yyyy] = ddmmyyyy.split('-');
            return `${yyyy}-${mm}-${dd}`;
        }
        (function enableHeaderGrabScroll() {
    const header = document.querySelector('.hour-header-container');
    const scroller = document.getElementById('calendarScrollWrapper');

    if (!header || !scroller) return;

    let isDown = false;
    let startX;
    let startScrollLeft;

    header.addEventListener('mousedown', (e) => {
        isDown = true;
        header.classList.add('grabbing');
        startX = e.pageX;
        startScrollLeft = scroller.scrollLeft;
    });

    document.addEventListener('mouseup', () => {
        if (!isDown) return;
        isDown = false;
        header.classList.remove('grabbing');
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDown) return;

        e.preventDefault();
        const deltaX = e.pageX - startX;
        scroller.scrollLeft = startScrollLeft - deltaX;
    });
})();

function getEmployeeIconByCondition(employee, events) {
    

    const hasCarCondition = events.some(e => e.service_type === 'Home Visit');
    const hasErrorCondition = events.some(e => e.status === 'Missed');

    return {
            icon: 'fa-circle-xmark',
            cls: 'error',
            title: 'Error condition'
        };
    if (hasErrorCondition) {
        return {
            icon: 'fa-circle-xmark',
            cls: 'error',
            title: 'Error condition'
        };
    }

    if (hasCarCondition) {
        
    }

    return null; // no icon
}

        async function getBookings() { 
            runGroups = [];
            persons = [];
            runGroups.push('');
            const serviceList = `[${services.join(",")}]`;
            let cur_date = formatDateDDMMYYYY( currentDate );
            const criteria_1 = `Site_Name.ID == ${serviceList} && Date_field1 == '${cur_date}'`;
            var booking = {
                app_name: app_name,
                report_name: "Bookings_Backend",
                criteria: criteria_1
            };
            try {
                booking_resp = await ZOHO.CREATOR.DATA.getRecords(booking);
            } catch (err) {
                console.log("Creator error:", err);
                return; 
            }
            try{
            if( booking_resp.status === 400 ){
               
            }
            else if( booking_resp.code === 3000 ) {
                let date_booking = [];
                booking_resp.data.forEach(function (rec) {
                    if( rec.Care_Providers.length === 0 ){
                        let cur_book = createBookingObject(rec, null);
                        date_booking.push(cur_book);
                    }
                    
                    rec.Care_Providers.forEach(function (emp) {
                      let cur_book = createBookingObject(rec, emp);
                      date_booking.push(cur_book);
                    });
                });
                const key = formatDateYYYYMMDD(currentDate);

if (!eventDatabase[key]) {
    eventDatabase[key] = [];
}
 eventDatabase[key] = [];
eventDatabase[key].push(...date_booking);    
console.log(persons);
            } else {
                console.log("No bookings found or error in fetching bookings.");
            }}
            catch(err){
                console.log(err);
            }
        }

        function formatDateYYYYMMDD(date) {    
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function formatDateDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, "0");
            const month = String(date.getMonth() + 1).padStart(2, "0"); // months are 0-based
            const year = date.getFullYear();

            return `${day}-${month}-${year}`;
        }
function isFilterApplied(field, value) {
    return appliedFilters.some(
        f => f.field === field && f.searchValues[0] === value
    );
}

function removeFilterByFieldValue(field, value) {
    const index = appliedFilters.findIndex(
        f => f.field === field && f.searchValues[0] === value
    );
    if (index !== -1) {
        appliedFilters.splice(index, 1);
        renderAppliedFilters();
    }
}


        function calculateFillHeight() {
    // Select the container based on which view is currently active
    const selector = (currentView === 'day') ? '.calendar-body-scrollable' : '.week-view-container';
    const container = document.querySelector(selector);
    
    if (!container) return MIN_ROW_HEIGHT;
    
    // Header heights (Day header vs Week header)
    const headerHeight = (currentView === 'day') ? 45 : 55; 
    const availableHeight = container.clientHeight - headerHeight;
    
    const count = employees.length > 0 ? employees.length : 1;
    const fillHeight = availableHeight / count;
    
    return Math.max(MIN_ROW_HEIGHT, fillHeight);
}
function getTotalWeekHours(employee) {
    if (!employee || employee === '' || employee === '—') {
        return "0.0";
    }

    let totalMinutes = 0;

    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());

    for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        const key = getDateKey(d);

        const events = getEventsForEmployee(employee, key);
        
        events.forEach(evt => {
            const duration = evt.endMinutes - evt.startMinutes;
            if (duration > 0) {
                totalMinutes += duration;
            }
        });
    }

    // Return formatted hours
    const hours = totalMinutes / 60;
    return hours > 0 ? hours.toFixed(1) : "0.0";
}

function renderWeekSummaryRow() {
    const summary = document.getElementById('weekDaysSummary');
    summary.innerHTML = '';

    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());

    for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        const key = getDateKey(d);

        const events = eventDatabase[key] || [];

        const unfilled = events.filter(e => !e.employee).length;
        const mismatches = events.filter(e => e.overlap === true).length;

        const cell = document.createElement('div');
        cell.className = 'week-day-summary-cell';
        cell.innerHTML = `
            <div class="week-summary-line">${unfilled} unfilled</div>
            <div class="week-summary-line">${mismatches} mismatches</div>
        `;

        summary.appendChild(cell);
    }
}

let resizeDebounceTimer = null;
let resizeDirtyEvent = null;
        function startResize(e, evt, direction) {
            if (evt.Time_Critical_Visit === "Yes") {
        showToast("Time Critical Visit - Time cannot be changed", "error");
        return;
    }
            resizeEvent = evt;
            resizeDirection = direction;
            resizeStartX = e.clientX;
            originalStart = evt.startMinutes;
            originalEnd = evt.endMinutes;

            const eventEl = e.target.closest('.event');
            eventEl.classList.add('resizing');
            eventEl.draggable = false;

            document.body.style.cursor = 'ew-resize';
            document.body.style.userSelect = 'none';

            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('mouseup', stopResize );
            
        }
        function minutesToHHMM(minutes) {
            if (typeof minutes !== 'number' || minutes < 0) return '00:00';

            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;

            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }
        function formatDateStringWithMinutes(dateStr, minutes) {
    if (typeof dateStr !== 'string' || typeof minutes !== 'number') return '';

    const [dd, MM, yyyy] = dateStr.split('-').map(Number);
    if (!dd || !MM || !yyyy) return '';

    const hrs = Math.floor(minutes / 60);
    const mins = minutes % 60;

    const date = new Date(yyyy, MM - 1, dd, hrs, mins, 0, 0);
    if (isNaN(date)) return '';

    return (
        String(dd).padStart(2, '0') + '-' +
        String(MM).padStart(2, '0') + '-' +
        yyyy + ' ' +
        String(hrs).padStart(2, '0') + ':' +
        String(mins).padStart(2, '0')
    );
}


        async function updateEventZoho(evt){
            
            
            const key = toYYYYMMDD( evt.date );            
            if (!eventDatabase[key]) {
                eventDatabase[key] = [];
            }
            const final_emp = getEmployeeIdsForEvent(evt);
            
            
            
            
            let sts = evt.event_status.replace("_"," "); 
            
            
            let duration = evt.endMinutes - evt.startMinutes; 
            var update_config = {
                app_name: app_name,    
                report_name: "Bookings_Backend",
                id: evt.zoho_id,
                payload: {
                    "data": {
                        "Care_Providers": final_emp,
                        "Start_time": `${minutesToHHMM(evt.startMinutes)}`,
                        "End_time": `${minutesToHHMM(evt.endMinutes)}`,
                        "Duration" : `${minutesToHHMM(duration)}`,
                        "From_Date_Time": formatDateStringWithMinutes(evt.date, evt.startMinutes),
                        "To_Date_Time": formatDateStringWithMinutes(evt.date, evt.endMinutes),
                        "Status": sts,
                        "Manager_notes": evt.Manager_Notes,
                        "Date_field1" : evt.date
                    }
                }
            }
            console.log(JSON.stringify(update_config));
            try{
            res = await ZOHO.CREATOR.DATA.updateRecordById(update_config);
            console.log( JSON.stringify(res));
            }
            catch(err){
                console.log(err);
            }
            // eventDatabase[key].push(evt);
        }

        function onResizeMove(e) {
            if (!resizeEvent) return;

            const deltaX = e.clientX - resizeStartX;
            let minutesDelta;

if (resizeDirection === 'right') {
    minutesDelta = Math.floor(deltaX / PIXELS_PER_15_MIN) * 15;
} else {
    minutesDelta = Math.ceil(deltaX / PIXELS_PER_15_MIN) * 15;
}

            if (resizeDirection === 'right') {
                const newEnd = originalEnd + minutesDelta;
                if (newEnd - resizeEvent.startMinutes >= MIN_RESIZE_MINUTES) {
                    resizeEvent.endMinutes = newEnd;
                }
            } else {
                const newStart = originalStart + minutesDelta;
                if (resizeEvent.endMinutes - newStart >= MIN_RESIZE_MINUTES) {
                    resizeEvent.startMinutes = newStart;
                }
            }
            resizeDirtyEvent = resizeEvent;
            if (currentView === 'day') {
                re_renderDayView();
            } else {
                renderWeekView();
            }
        }
let pendingTimeChange = null;
let originalEventState = null;

       function stopResize() {
    document.body.style.cursor = '';
    document.body.style.userSelect = '';

    document.querySelectorAll('.event.resizing').forEach(el => {
        el.classList.remove('resizing');
        el.draggable = true;
    });

    document.removeEventListener('mousemove', onResizeMove);
    document.removeEventListener('mouseup', stopResize);

    // Store the changes for confirmation
    if (resizeDirtyEvent) {
        const oldStart = originalStart;
        const oldEnd = originalEnd;
        const newStart = resizeDirtyEvent.startMinutes;
        const newEnd = resizeDirtyEvent.endMinutes;
        
        // Check if time actually changed
        if (oldStart !== newStart || oldEnd !== newEnd) {
            pendingTimeChange = {
                event: resizeDirtyEvent,
                oldStart: oldStart,
                oldEnd: oldEnd,
                newStart: newStart,
                newEnd: newEnd,
                type: 'resize'
            };
            
            showTimeChangeConfirmation();
        }
    }

    resizeEvent = null;
    resizeDirection = null;
}
function showTimeChangeConfirmation() {
    
    const modal = document.getElementById('timeChangeConfirmModal');
    
    if (pendingTimeChange.type === 'resize') {
        const evt = pendingTimeChange.event;
        document.getElementById('confirmOldTime').textContent = 
            `${minutesToHHMM(pendingTimeChange.oldStart)} - ${minutesToHHMM(pendingTimeChange.oldEnd)}`;
        document.getElementById('confirmNewTime').textContent = 
            `${minutesToHHMM(pendingTimeChange.newStart)} - ${minutesToHHMM(pendingTimeChange.newEnd)}`;
        document.getElementById('confirmEventTitle').textContent = evt.title || 'Untitled';
        document.getElementById('confirmEventStaff').textContent = evt.employee || 'Unassigned';
    } else if (pendingTimeChange.type === 'drag') {
        const evt = pendingTimeChange.draggedEventData[0];
        const duration = evt.endMinutes - evt.startMinutes;
        const newEnd = pendingTimeChange.newAnchorStart + duration;
        
        document.getElementById('confirmOldTime').textContent = 
            `${minutesToHHMM(evt.startMinutes)} - ${minutesToHHMM(evt.endMinutes)}`;
        document.getElementById('confirmNewTime').textContent = 
            `${minutesToHHMM(pendingTimeChange.newAnchorStart)} - ${minutesToHHMM(newEnd)}`;
        document.getElementById('confirmEventTitle').textContent = evt.title || 'Untitled';
        
        if (pendingTimeChange.draggedEventData.length > 1) {
            document.getElementById('confirmEventStaff').textContent = 
                `${pendingTimeChange.draggedEventData.length} events`;
        } else {
            document.getElementById('confirmEventStaff').textContent = 
                `${evt.employee || 'Unassigned'} → ${pendingTimeChange.newEmployee || 'Unassigned'}`;
        }
    }
    
    modal.classList.remove('hidden');
}

// New function to confirm time change
async function confirmTimeChange() {
    console.log(employees);
    
    console.log(pendingTimeChange);
    
    const modal = document.getElementById('timeChangeConfirmModal');
    modal.classList.add('hidden');
    
    showLoader();
    
    if (pendingTimeChange.type === 'resize') {
        clearTimeout(resizeDebounceTimer);
        await updateEventZoho(pendingTimeChange.event);
        currentView === 'day' ? renderDayView() : renderWeekView();
    } else if (pendingTimeChange.type === 'drag') {
        const {
            draggedEventData,
            newHour,
            newQuarter,
            newEmployee,
            currentDateKey,
            anchorStart,
            newAnchorStart
        } = pendingTimeChange;
        
        await applyDragChanges(draggedEventData, newHour, newQuarter, newEmployee, currentDateKey, anchorStart, newAnchorStart);
    }
    
    pendingTimeChange = null;
    resizeDirtyEvent = null;
    hideLoader();
}

// New function to cancel time change
function cancelTimeChange() {
    const modal = document.getElementById('timeChangeConfirmModal');
    modal.classList.add('hidden');
    
    // Revert changes
    if (pendingTimeChange && pendingTimeChange.type === 'resize') {
        const evt = pendingTimeChange.event;
        evt.startMinutes = pendingTimeChange.oldStart;
        evt.endMinutes = pendingTimeChange.oldEnd;
    }
    
    pendingTimeChange = null;
    resizeDirtyEvent = null;
    
    // Re-render to show original state
    currentView === 'day' ? renderDayView() : renderWeekView();
}
       
        let appliedFilters = [];
        
        const filterTags = {
            eType: [],
            persons: [],
            from: [],
            to: [],
            type: [],
            service: [],
            staff: [],
            activityType: [],
            location: [],
            activityNotes: [],
            healthAppointment: []
        };
        
        const filterValues = {
            employee: 'contains'
        };
        
        const fieldDisplayNames = {
            employee: 'Employee'
        };
        
        const MAX_TAGS = 6;
        
        // const employees = ['John Smith', 'Sarah Johnson', 'Mike Wilson', 'Emily Davis', 'David Brown', 'Arun', 'Kamalam', 'Surya', 'Mugil', 'Nirmal', 'Sofia', 'Shiva'];
        const employees=[];
        employees.push('');
        const employeeDetails = [];
        const initialEventDatabase = {
            '2026-01-07': [
                { id: 1, title: 'Team Meeting', startMinutes: 540, endMinutes: 630, employee: 'Sophia Roome' },
                { id: 2, title: 'Project Review', startMinutes: 600, endMinutes: 720, employee: 'Sophia Roome' },
                { id: 3, title: 'Lunch Break', startMinutes: 720, endMinutes: 780, employee: 'Sophie Hallas' },
                { id: 4, title: 'Client Call', startMinutes: 840, endMinutes: 900, employee: 'Sophie Hallas' },
                { id: 5, title: 'Code Review', startMinutes: 870, endMinutes: 960, employee: '' },
                { id: 6, title: 'Documentation', startMinutes: 930, endMinutes: 1020, employee: '' },
                { id: 7, title: 'Documentation', startMinutes: 120, endMinutes: 530, employee: '' },
                { id: 8, title: 'Documentation', startMinutes: 120, endMinutes: 530, employee: '' },
                { id: 9, title: 'Documentation', startMinutes: 120, endMinutes: 530, employee: '' },
            ],
            '2025-12-29': [
                { id: 7, title: 'HARI OM SPARE PARTS', startMinutes: 825, endMinutes: 900, employee: 'Sarah Johnson' }
            ],
            '2026-01-01': [
                { id: 8, title: 'JALAN AUTO AGENCY', startMinutes: 960, endMinutes: 1020, employee: 'Mike Wilson' }
            ]
        };


        function toggleQuickFilter(e) {
    e.stopPropagation();
    const popover = document.getElementById('quickFilterPopover');
    popover.classList.toggle('active');
    populateQuickDropdowns();
}

document.addEventListener('click', () => {
    document.getElementById('quickFilterPopover')?.classList.remove('active');
});

function toggleQuickDropdown(el) {
    event.stopPropagation();
    const dropdown = el.closest('.quick-dropdown');

    document.querySelectorAll('.quick-dropdown.active')
        .forEach(d => d !== dropdown && d.classList.remove('active'));

    dropdown.classList.toggle('active');
}
document
  .getElementById('quickFilterPopover')
  .addEventListener('click', e => {
      e.stopPropagation();
  });
  document.addEventListener('click', () => {
    document
        .getElementById('quickFilterPopover')
        ?.classList.remove('active');

    document
        .querySelectorAll('.quick-dropdown.active')
        .forEach(d => d.classList.remove('active'));
});

function getOptionsByField(field) {
    switch (field) {
        case "employee":
            return employees.filter( i => i !== '' );
        case "service":      
            return services_details.flatMap(obj => Object.keys(obj));
        case "persons":
            return persons.filter(i => i !== '').sort();
        default:
            return [];
    }
}


function populateQuickDropdowns() {
    document.querySelectorAll('.quick-dropdown').forEach(dropdown => {
        console.log(dropdown);
        
        const field = dropdown.dataset.field;
        const optionsBox = dropdown.querySelector('.quick-dropdown-options');
        optionsBox.innerHTML = '';

        const values = getOptionsByField(field);

        values.forEach(value => {
            const opt = document.createElement('div');
            opt.className = 'quick-dropdown-option';

            const applied = isFilterApplied(field, value);

            opt.innerHTML = applied
                ? `<span>${value}</span><i class="fa fa-check"></i>`
                : `<span>${value}</span>`;

            if (applied) opt.classList.add('selected');

            opt.onclick = (e) => {
                e.stopPropagation();

                applied
                    ? removeFilterByFieldValue(field, value)
                    : applyQuickFilter(field, value);

                populateQuickDropdowns(); // re-render
            };

            optionsBox.appendChild(opt);
        });
    });
}


function applyQuickFilter(field, value) {
    if (isFilterApplied(field, value)) return;

    const existing = appliedFilters.find(f => f.field === field);

if (existing) {
    existing.filterType = 'is';          
    existing.searchValues = [...existing.searchValues,value];
} else {
    appliedFilters.push({
        field,
        filterType: 'is',
        searchValues: [value]
    });
}

    renderAppliedFilters();    
    document.getElementById('quickFilterPopover').classList.remove('active');
    if (currentView === 'week') {
                
                renderWeekView();
            } else {
                
                renderDayView();
            }
}
/* Create pill */
// function applyQuickFilter(field, value) {
//     const exists = appliedFilters.some(
//         f => f.field === field && f.searchValues[0] === value
//     );

//     if (exists) return; 

//     appliedFilters.push({
//         field,
//         filterType: 'is',
//         searchValues: [value]
//     });

//     renderAppliedFilters();
//     document.getElementById('quickFilterPopover').classList.remove('active');
// }
        
        let eventDatabase = JSON.parse(JSON.stringify(initialEventDatabase));

        function getDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        //chnage

        function getCurrentDateKey() {
            return getDateKey(currentDate);
        }

        function getCurrentEvents() {
            return eventDatabase[getCurrentDateKey()] || [];
        }

        function getEventsForDate(date) {
            return eventDatabase[getDateKey(date)] || [];
        }
        
        function isEmptyValue(val) {
            return (
                val === null ||
                val === undefined ||
                (typeof val === 'string' && val.trim() === '') ||
                (Array.isArray(val) && val.length === 0)
            );
        }
        function getEventsForEmployee(employee, dateKey) {
    const allEvents = eventDatabase[dateKey] || [];
    const hasStaffFilter = appliedFilters.some(f => f.field === 'staff' || f.field === 'employee' );
             
    return allEvents.filter(evt => {
        if (evt.employee !== employee) return false;

        return appliedFilters.every(f => {
            let search_key = null;
            if (f.field === "persons") {
                search_key = 'title';
            } else if (f.field === 'staff' || f.field === 'employee' ) {
                search_key = 'employee';
            } else {
                search_key = f.field;
            }
            const eventValue = evt[search_key];
            if (eventValue == null) return false;

            if( search_key == 'employee' && eventValue === '' ){
                return true;
            }
            if (f.filterType === 'contains') {
                console.log("contains");
                
                return f.searchValues.some(v =>
                    String(eventValue)
                        .toLowerCase()
                        .includes(String(v).toLowerCase())
                );

            } else if (f.filterType === 'is') {
    return f.searchValues.some(v =>
        String(eventValue).trim().toLowerCase() ===
        String(v).trim().toLowerCase()
    );
} else if (f.filterType === 'isNot') {
                return !f.searchValues.some(v =>
                    String(eventValue) === String(v)
                );

            } else if (f.filterType === 'isEmpty') {
                return isEmptyValue(eventValue);

            } else if (f.filterType === 'isNotEmpty') {
                return !isEmptyValue(eventValue);

            } else if (f.filterType === 'before') {
                const eventMin = timeToMinutes(eventValue);
                return f.searchValues.some(v => {
                    const filterMin = timeToMinutes(v);
                    return eventMin !== null &&
                           filterMin !== null &&
                           eventMin < filterMin;
                });

            } else if (f.filterType === 'after') {
                const eventMin = timeToMinutes(eventValue);
                return f.searchValues.some(v => {
                    const filterMin = timeToMinutes(v);
                    return eventMin !== null &&
                           filterMin !== null &&
                           eventMin > filterMin;
                });

            } else {
                console.warn('Unknown filterType:', f.filterType);
                return true;
            }
        });
    });
}



        async function switchView(view) {
    document.getElementById("employeeSearchInput").value = '';
    showLoader();
    currentView = view;
    
    // Reset to employee view when switching
    currentViewType = 'employee';
    document.getElementById('currentViewType').textContent = 'Employee';
    
    const dayViewBtn = document.getElementById('dayViewBtn');
    const weekViewBtn = document.getElementById('weekViewBtn');
    const dayView = document.getElementById('dayView');
    const weekView = document.getElementById('weekView');
    
    // Update view switcher options
    updateViewSwitcherOptions();
    
    if (view === 'day') {
        if (!inital_load) {
            await getTodayAllEmployees();
        }
        await getBookings();
        dayViewBtn.classList.add('active');
        weekViewBtn.classList.remove('active');
        dayView.classList.add('active');
        weekView.classList.remove('active');
        await renderDayView();
    } else {
        await getTodayAllEmployees();
        await getBookingsForWeek();
        weekViewBtn.classList.add('active');
        dayViewBtn.classList.remove('active');
        weekView.classList.add('active');
        dayView.classList.remove('active');
        await renderWeekView();
    }
    updateDateTitle();
    
    const miniCal = document.getElementById('miniCalendar');
    if (miniCal.classList.contains('active')) {
        renderMiniCalendar();
    }
    hideLoader();
}

         async function navigatePeriod(delta) {
    showLoader();
    
    try {
        if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() + delta);
        } else {
            currentDate.setDate(currentDate.getDate() + (delta * 7));
        }
        
        if (currentViewType === 'employee') {
            await getTodayAllEmployees();
            if (currentView === 'day') {
                await getBookings();
                await renderDayView();
                startAt6();
            } else {
                await getBookingsForWeek();
                await renderWeekView();
            }
        } else if (currentViewType === 'run') {
            if (currentView === 'day') {
                await getBookings();
                await renderRunView();
            } else {
                await getBookingsForWeek();
                await renderRunViewWeek();
            }
        } else if (currentViewType === 'person') {
            if (currentView === 'week') {
                await getBookingsForWeek();
                await renderWeekPersonView();
            }
        }
        
        updateDateTitle();
        
    } catch (error) {
        console.error('Error navigating period:', error);
    } finally {
        hideLoader();
    }
}

        async function goToday() {
    showLoader();
    currentDate = new Date();
    todayDate = new Date();
    
    try {
        await getTodayAllEmployees();
        await getBookings();
                await renderDayView();
        // if (currentViewType === 'employee') {
            
        //     if (currentView === 'day') {
                
        //     } else {
        //         await getBookingsForWeek();
        //         await renderWeekView();
        //     }
        // } else if (currentViewType === 'run') {
        //     if (currentView === 'day') {
        //         await getBookings();
        //         await renderRunView();
        //     } else {
        //         await getBookingsForWeek();
        //         await renderRunViewWeek();
        //     }
        // } else if (currentViewType === 'person') {
        //     if (currentView === 'week') {
        //         await getBookingsForWeek();
        //         await renderWeekPersonView();
        //     }
        // }
        
        updateDateTitle();
    } catch (error) {
        console.error('Error going to today:', error);
    } finally {
        hideLoader();
    }
}


        function updateDateTitle() {
            if (currentView === 'day') {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('dateTitle').textContent = currentDate.toLocaleDateString('en-US', options);
            } else {
                const weekStart = new Date(currentDate);
                weekStart.setDate(currentDate.getDate() - currentDate.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const startStr = weekStart.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                const endStr = weekEnd.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                document.getElementById('dateTitle').textContent = `${startStr} – ${endStr}`;
            }
        }
        function createBookingObject(rec, emp) {
            let cur_book = {};
    cur_book.id = Number(rec.ID);
    cur_book.zoho_id = rec.ID;
    cur_book.date = rec.Date_field1;
    cur_book.Manager_notes = rec.Manager_Notes;
    cur_book.title = rec.Care_Service_User.zc_display_value;
    cur_book.service = rec.Site_Name.zc_display_value;
    cur_book.from = rec.Start_time;
    cur_book.to = rec.End_time;
    cur_book.no_of_staff = rec.No_of_Staff;
    cur_book.Female_Only = rec["Visit.Female_Only"] ?? "";
    cur_book.Time_Critical_Visit = rec["Visit.Time_Critical_Visit"] ?? "";;
    const runName = rec.Care_Group?.Care_Group_Name ?? '';
const runID   = rec.Care_Group?.ID ?? '';
    const personName = rec.Care_Service_User.zc_display_value;
    const person_id = rec.Care_Service_User.ID;

    if( personName && !persons.includes(personName) ){
        persons.push(personName);
    }

cur_book.run_view = runName;
cur_book.run_view_id = runID;

if (runName && !runGroups.includes(runName)) {
    runGroups.push(runName);
    runGroupDetails[runName] = runID;
}

    const [, stime] = rec.From_Date_Time.split(" ");
    const [shours, sminutes] = stime.split(":").map(Number);
    cur_book.startMinutes = shours * 60 + sminutes;
    
    // Parse end time
    const [, etime] = rec.To_Date_Time.split(" ");
    const [ehours, eminutes] = etime.split(":").map(Number);
    cur_book.endMinutes = ehours * 60 + eminutes;
    
    // Employee details
    if (emp) {
        cur_book.employee = emp.zc_display_value;
        cur_book.employee_id = emp.ID;
    } else {
        cur_book.employee = '';
    }
    cur_book.overlap = false;
    cur_book.event_status = rec.Status;
    
    // Determine status
    if (rec.Overlapped_Booking == "true") {
        cur_book.status = "Overlapped";
        cur_book.overlap = true;
    } else if (rec.Status === "Missed") {
        cur_book.status = "Missed";
    } else if (rec.Status === "Not Completed") {
        cur_book.status = "Not_Completed";
    } else if (rec.Status === "Cancelled") {
        cur_book.status = "Cancelled";
    } else if (rec.Status === "Started") {
        cur_book.status = "Started";
    } else if (rec.Status === "Completed") {
        cur_book.status = "Completed";
    } else {
        cur_book.status = "Not_Started";
    }
    return cur_book;
}
        async function re_renderDayView(){
            renderHourHeaders();
            await renderEmployeeRows();
            syncScroll();
        }
        async function renderDayView() {    
            showLoader();
            await getTodayAllEmployees();
            renderHourHeaders();
            await renderEmployeeRows();
            syncScroll();
            hideLoader();
        }
        function startAt6(){
            const scrollWrapper = document.getElementById('calendarScrollWrapper');
            const startScrollLeft = DEFAULT_DAY_START_HOUR * PIXELS_PER_HOUR;;
            const hourHeaderContainer = document.querySelector('.hour-header-container');

            requestAnimationFrame(() => {
                hourHeaderContainer.scrollLeft = startScrollLeft;
                scrollWrapper.scrollLeft = startScrollLeft;
            });
        }

        function renderHourHeaders() {
            const header = document.getElementById('hourHeader');
            header.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const label = document.createElement('div');
                label.className = 'hour-label';
                const hour = i;
                const period = ':00';
                label.textContent = `${hour}${period}`;
                header.appendChild(label);
            }
        }
        
        function renderEmployeeColumn(rowHeightsMap = {}) {
    const column = document.getElementById('employeeColumn');
    column.innerHTML = '';

    const displayList = employees.length > 0 ? employees : ['—'];
    const employeeObj = appliedFilters.find(o => o.field === "staff" || o.field === "employee" );
    if(employeeObj){
        employeeValues = returnEmployees(employeeObj.searchValues);
        
        if (!employeeValues.includes('')) {
            employeeValues.unshift('');
        }
    }
    else{
        employeeValues = employees;
    }
    const dateKey = getCurrentDateKey();
    employeeValues.forEach(employee => {
        const row = document.createElement('div');
        row.className = 'employee-row';

        if (employee === '—') {
            row.innerHTML = '';
        } else {
            let total_mins = 0;
            const events = getEventsForEmployee(employee, dateKey);
            events.forEach(evt => {
                total_mins += (evt.endMinutes - evt.startMinutes);
            });
            const t_count = total_mins / 60;
const workingHours = total_mins / 60;
let displayHours = workingHours > 0 ? workingHours.toFixed(1) : '0.0';

// Get contracted hours from shift data
const shiftData = shiftsMap[employee];
let contractedHours = '0.0';
let contractedMinutes = 0;

if (shiftData) {
    contractedMinutes = shiftData.endMinutes - shiftData.startMinutes;
    contractedHours = (contractedMinutes / 60).toFixed(1);
}

// ✅ CALCULATE PERCENTAGE
let percentage = 0;
if (contractedMinutes > 0) {
    percentage = Math.round((total_mins / contractedMinutes) * 100);
}

// ✅ DISPLAY PERCENTAGE (not hours)
let displayPercentage = `${percentage}%`;
            let iconHTML = '';
            const hasDrivingSkill = employeeDetails.some(e =>
    e.name?.trim().toLowerCase() === employee?.trim().toLowerCase() &&
    Array.isArray(e.skills) &&
    e.skills.some(
        skill =>
            typeof skill === "string" &&
            skill.trim().toLowerCase() === "driver"
    )
);        
            if ( hasDrivingSkill) {
                iconHTML = `<i class="fa-solid fa-car"></i>`;
            } 
            row.innerHTML = `
    <div class="employee-label">
        <div class="employee-name-row">
            <span class="employee-name">${employee}</span>
            ${iconHTML}
            <span class="employee-count">${displayPercentage}</span>
        </div>
        <div class="employee-hours-info">
            <span class="hours-value" data-tooltip="Contracted Hours">${contractedHours}</span>
            <span class="hours-separator">|</span>
            <span class="hours-value" data-tooltip="Actual Hours">${displayHours}</span>
        </div>
    </div>
`;
        }

        const height =
            rowHeightsMap[employee] ||
            (employees.length === 0 ? 500 : MIN_ROW_HEIGHT);
        
        
        row.style.height = height + 'px';
        column.appendChild(row);
    });
}

function renderEmployeeColumnBasedOnFilter(rowHeightsMap = {},emp) {
    const column = document.getElementById('employeeColumn');
    column.innerHTML = '';

    const dateKey = getCurrentDateKey();
    emp.forEach(employee => {
        const row = document.createElement('div');
        row.className = 'employee-row';

        if (employee === '—') {
            row.innerHTML = '';
        } else {
            let total_mins = 0;
            const events = getEventsForEmployee(employee, dateKey);
            events.forEach(evt => {
                total_mins += (evt.endMinutes - evt.startMinutes);
            });
            const t_count = total_mins / 60;
const workingHours = total_mins / 60;
let displayHours = workingHours > 0 ? workingHours.toFixed(1) : '0.0';

// Get contracted hours from shift data
const shiftData = shiftsMap[employee];
let contractedHours = '0.0';
let contractedMinutes = 0;

if (shiftData) {
    contractedMinutes = shiftData.endMinutes - shiftData.startMinutes;
    contractedHours = (contractedMinutes / 60).toFixed(1);
}

// ✅ CALCULATE PERCENTAGE
let percentage = 0;
if (contractedMinutes > 0) {
    percentage = Math.round((total_mins / contractedMinutes) * 100);
}

// ✅ DISPLAY PERCENTAGE (not hours)
let displayPercentage = `${percentage}%`;
            let iconHTML = '';
            const hasDrivingSkill = employeeDetails.some(e =>
    e.name?.trim().toLowerCase() === employee?.trim().toLowerCase() &&
    Array.isArray(e.skills) &&
    e.skills.some(
        skill =>
            typeof skill === "string" &&
            skill.trim().toLowerCase() === "driver"
    )
);        
            if ( hasDrivingSkill) {
                iconHTML = `<i class="fa-solid fa-car"></i>`;
            } 

            row.innerHTML = `
    <div class="employee-label">
        <div class="employee-name-row">
            <span class="employee-name">${employee}</span>
            ${iconHTML}
            <span class="employee-count">${displayPercentage}</span>
        </div>
        <div class="employee-hours-info">
            <span class="hours-value" data-tooltip="Contracted Hours">${contractedHours}</span>
            <span class="hours-separator">|</span>
            <span class="hours-value" data-tooltip="Actual Hours">${displayHours}</span>
        </div>
    </div>
`;
        }

        const height =
            rowHeightsMap[employee] ||
            (employees.length === 0 ? 500 : MIN_ROW_HEIGHT);

        row.style.height = height + 'px';
        column.appendChild(row);
    });
}

        
       let scrollSynced = false;

function syncScroll() {
    if (scrollSynced) return; 

    const scrollWrapper = document.getElementById('calendarScrollWrapper');
    const hourHeaderContainer = document.querySelector('.hour-header-container');

    if (!scrollWrapper || !hourHeaderContainer) return;

    scrollWrapper.addEventListener('scroll', () => {
        hourHeaderContainer.scrollLeft = scrollWrapper.scrollLeft;
    });

    scrollSynced = true;
}
    function returnEmployees(values){
        return employees.filter(emp =>
        values.some(v =>
            emp.toLowerCase().includes(v.toLowerCase())
        )
    );
    }        

        async function renderEmployeeRows() {
    const rowsContainer = document.getElementById('calendarRows');
    rowsContainer.innerHTML = '';

    const dateKey = getCurrentDateKey();
    const rowHeightsMap = {};
    const shiftsData = shiftsMap;
    
    
    // Calculate how much height each row needs to fill the screen
    const fillHeight = calculateFillHeight();    
    const displayList = employees.length >= 0 ? employees : ['—'];   
    const employeeObj = appliedFilters.find(o => o.field === "staff" || o.field === "employee" );
    if(employeeObj){
        employeeValues = await returnEmployees(employeeObj.searchValues);
        if (!employeeValues.includes('')) {
            employeeValues.unshift('');
            console.log(employeeValues);
        }
    }
    else{
        employeeValues = employees;
    }
    employeeValues.forEach(employee => {
        const rawEvents = employee === '—' ? [] : getEventsForEmployee(employee, dateKey);
        const events = detectOverlaps([...rawEvents]);

        const maxConcurrent = events.length ? Math.max(...events.map(e => e.maxConcurrent)) : 1;
        const dynamicHeight = (maxConcurrent * (EVENT_HEIGHT + EVENT_GAP)) + (ROW_PADDING * 2);
        
        // Logic: Take the larger of (Height needed for events) OR (Height needed to fill screen)
        const finalRowHeight = Math.max(fillHeight, dynamicHeight);
        rowHeightsMap[employee] = finalRowHeight;

        const employeeRow = document.createElement('div');
        employeeRow.className = 'employee-calendar-row';
        employeeRow.dataset.employee = employee;
        employeeRow.style.height = finalRowHeight + 'px';

        const grid = document.createElement('div');
        grid.className = 'calendar-grid';

        for (let h = 0; h < 24; h++) {
            const hourCol = document.createElement('div');
            hourCol.className = 'hour-column';
            const innerGrid = document.createElement('div');
            innerGrid.className = 'hour-column-inner';
            for (let i = 0; i < 4; i++) {
                const line = document.createElement('div');
                line.className = 'quarter-line';
                innerGrid.appendChild(line);
            }
            hourCol.appendChild(innerGrid);

            for (let q = 0; q < 4; q++) {
                const slot = document.createElement('div');
                slot.className = 'quarter-slot';
                slot.dataset.hour = h;
                slot.dataset.quarter = q;
                slot.dataset.employee = employee;
                if (employee !== '—') {
                    slot.addEventListener('dragover', handleDayDragOver);
                    slot.addEventListener('drop', handleDayDrop);
                    slot.addEventListener('dragleave', handleDragLeave);
                }
                hourCol.appendChild(slot);
            }
            grid.appendChild(hourCol);
        }
        if (employee !== '—') {
            renderEmployeeWorkingHours(grid, employee, shiftsData);
        }
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'events-container';
        eventsContainer.dataset.employee = employee;
        renderEventsForEmployee(eventsContainer, events);

        grid.appendChild(eventsContainer);
        employeeRow.appendChild(grid);
        rowsContainer.appendChild(employeeRow);
    });

    renderEmployeeColumn(rowHeightsMap);
}

        function renderEventsForEmployee(container, events) {
            const hourWidth = 100;

            events.forEach(evt => {
                const startHour = Math.floor(evt.startMinutes / 60);
                const startMinute = evt.startMinutes % 60;
                const duration = evt.endMinutes - evt.startMinutes;

                const el = document.createElement('div');
                el.className = `event status-${evt.status}`;
                if (evt.Time_Critical_Visit === "Yes") {
                    el.classList.add('time-critical');
                }
                el.draggable = true;
                el.dataset.timeCritical = evt.Time_Critical_Visit || "No";
                el.dataset.female = evt.Female_Only || "No";
                const compositeKey = `${evt.zoho_id}-${evt.employee || 'unassigned'}-${evt.employee_id || 'none'}`;
                el.dataset.eventKey = compositeKey
                el.dataset.eventId = evt.id;
                el.dataset.viewType = 'day';
                el.dataset.employee = evt.employee;
                el.dataset.serviceUser = evt.title || '';
                el.dataset.staff = evt.employee || '—';
                el.dataset.start = minutesToTime(evt.startMinutes).hour.toString().padStart(2,'0') + ':' +
                                minutesToTime(evt.startMinutes).minute.toString().padStart(2,'0');
                el.dataset.end = minutesToTime(evt.endMinutes).hour.toString().padStart(2,'0') + ':' +
                                minutesToTime(evt.endMinutes).minute.toString().padStart(2,'0');

                /* OPTIONAL – only if available */
                el.dataset.mismatch = evt.status ? evt.status.replace("_"," ") : "";
                el.dataset.status =  evt.event_status;
                el.dataset.travel = evt.travel || '';


                const left = (startHour * hourWidth) + ((startMinute / 60) * hourWidth);
                const width = (duration / 60) * hourWidth;
                const top = ROW_PADDING + (evt.stackLevel * (EVENT_HEIGHT + EVENT_GAP));

                el.style.left = left + 'px';
                el.style.width = width + 'px';
                el.style.top = top + 'px';
                el.style.height = EVENT_HEIGHT + 'px';

                const title = document.createElement('div');
                title.className = 'event-title';
                title.textContent = evt.title;

                // const time = document.createElement('div');
                // time.className = 'event-time';
                // time.textContent = formatTimeRange(evt.startMinutes, evt.endMinutes);
                if (evt.no_of_staff && evt.no_of_staff > 1) {
                    const staffBadge = document.createElement('div');
                    staffBadge.className = 'event-staff-badge';
                    staffBadge.innerHTML = `<i class="fa fa-users"></i>${evt.no_of_staff}`;
                    staffBadge.title = `${evt.no_of_staff} staff required`;
                    el.appendChild(staffBadge);
                }
                if (evt.Time_Critical_Visit === "Yes") {
                    const lockIcon = document.createElement('div');
                    lockIcon.className = 'event-lock-icon';
                    lockIcon.innerHTML = '<i class="fa fa-lock"></i>';
                    lockIcon.title = 'Time Critical Visit - Time cannot be changed';
                    el.appendChild(lockIcon);
                }
                if( evt.status === "Completed" || evt.Time_Critical_Visit !== "Yes"  ){
                    el.appendChild(title);
                }
                else{
                const leftHandle = document.createElement('div');
                leftHandle.className = 'resize-handle left';
                leftHandle.addEventListener('mousedown', e => {
                    e.preventDefault();   
                    e.stopPropagation();
                    startResize(e, evt, 'left');
                });

                const rightHandle = document.createElement('div');
                rightHandle.className = 'resize-handle right';
                rightHandle.addEventListener('mousedown', e => {
                    e.preventDefault();    
                    e.stopPropagation();
                    startResize(e, evt, 'right');
                });

                el.appendChild(leftHandle);
                el.appendChild(rightHandle);
                el.appendChild(title);

                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);

                el.addEventListener('mousedown', (e) => {
    mouseDownX = e.clientX;
    mouseDownY = e.clientY;
    if ((e.ctrlKey || e.metaKey) && e.button === 0) {
        e.preventDefault();
        e.stopPropagation();   
        toggleEventSelection(el);
    }
});

el.addEventListener('mouseup', (e) => {
      if (e.ctrlKey || e.metaKey) return;
    // Ignore resize handles
    if (e.target.closest('.resize-handle')) return;

    // Ignore edit icon
    if (e.target.closest('.event-edit')) return;

    const dx = Math.abs(e.clientX - mouseDownX);
    const dy = Math.abs(e.clientY - mouseDownY);

    // If mouse moved → it was a drag, not a click
    if (dx > CLICK_TOLERANCE || dy > CLICK_TOLERANCE) return;
      openEventModal(evt);


});
            }
                container.appendChild(el);
            });
        }

        function detectOverlaps(events) {
    if (!events || events.length === 0) return [];

    // 1. Sort by start time
    const sorted = [...events].sort((a, b) => a.startMinutes - b.startMinutes);

    const columns = []; 

    sorted.forEach(evt => {
        
        for (let i = 0; i < columns.length; i++) {
            if (columns[i] && columns[i].endMinutes <= evt.startMinutes) {
                columns[i] = null;
            }
        }
        let colIndex = columns.findIndex(c => c === null);

        if (colIndex === -1) {
            colIndex = columns.length;
            columns.push(evt);
        } else {
            columns[colIndex] = evt;
        }

        evt.stackLevel = colIndex;
        evt._tempColumns = columns.length;
        evt.endMinutes = evt.endMinutes; 
    });
    sorted.forEach(evt => {
        evt.maxConcurrent = evt._tempColumns;
        delete evt._tempColumns;
    });

    return sorted;
}
               
        async function renderWeekView() {
            // await getBookingsForWeek();
            renderWeekDaysHeader();
            renderWeekSummaryRow();
            renderWeekEmployeeRows();
            syncWeekScroll();
        }

        function renderWeekDaysHeader() {
    const header = document.getElementById('weekDaysHeader');
    header.innerHTML = '';
    
    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
    
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    for (let i = 0; i < 7; i++) {
        const dayDate = new Date(weekStart);
        dayDate.setDate(weekStart.getDate() + i);
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        
        // Highlight today
        if (dayDate.toDateString() === todayDate.toDateString()) {
            dayHeader.classList.add('today');
        }
        
        // Match the text format in your screenshot: "TUE, 6 JAN"
        const dName = dayNames[i].toUpperCase();
        const dNum = dayDate.getDate();
        const mName = monthNames[dayDate.getMonth()].toUpperCase();
        
        dayHeader.innerHTML = `
            <div class="week-day-name">${dName}, ${dNum} ${mName}</div>
        `;
        header.appendChild(dayHeader);
    }
}

        function syncWeekScroll() {
            const scrollWrapper = document.getElementById('weekScrollWrapper');
            const daysContainer = document.querySelector('.week-days-container');
            
            scrollWrapper.addEventListener('scroll', function() {
                daysContainer.scrollLeft = this.scrollLeft;
            });
        }

function renderWeekEmployeeRows() {
    const rowsContainer = document.getElementById('weekCalendarRows');
    rowsContainer.innerHTML = '';

    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
    const rowHeightsMap = {};
    
    // 1. Calculate the height needed to fill the screen
    const fillHeight = calculateFillHeight();

    const displayList = employees.length >= 0 ? employees : ['—'];
    const employeeObj = appliedFilters.find(o => o.field === "staff" || o.field === "employee" );
    if(employeeObj){
        employeeValues = returnEmployees(employeeObj.searchValues);
        console.log(employeeValues);
        if (!employeeValues.includes('')) {
            employeeValues.unshift('');
        }
    }
    else{
        employeeValues = employees;
    }
    employeeValues.forEach(employee => {
        let maxEventsInDay = 1;

        // 2. Check if events require MORE height than the fill height
        if (employee !== '—') {
            for (let day = 0; day < 7; day++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + day);
                const events = getEventsForEmployee(employee, getDateKey(dayDate));
                if (events.length > 0) maxEventsInDay = Math.max(maxEventsInDay, events.length);
            }
        }

        const eventNeededHeight = (maxEventsInDay * (EVENT_HEIGHT + EVENT_GAP)) + (ROW_PADDING * 2);
        
        // 3. Set height to whichever is larger: Fill Height or Event Height
        const finalRowHeight = Math.max(fillHeight, eventNeededHeight);
        rowHeightsMap[employee] = finalRowHeight;

        const employeeRow = document.createElement('div');
        employeeRow.className = 'week-employee-calendar-row';
        employeeRow.style.height = finalRowHeight + 'px';

        for (let day = 0; day < 7; day++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + day);
            const dateKey = getDateKey(dayDate);

            const dayColumn = document.createElement('div');
            dayColumn.className = 'week-day-column';
                dayColumn.style.flex = "1 1 0"; // Force equal width

            
            if (employee !== '—') {
                dayColumn.dataset.day = day;
                dayColumn.dataset.dateKey = dateKey;
                dayColumn.dataset.employee = employee;
                dayColumn.addEventListener('dragover', handleWeekDragOver);
                dayColumn.addEventListener('drop', handleWeekDrop);
                dayColumn.addEventListener('dragleave', handleDragLeave);
            }

            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'week-events-container';
            const events = employee === '—' ? [] : getEventsForEmployee(employee, dateKey);
            renderWeekEventsForEmployee(eventsContainer, events, dateKey);

            dayColumn.appendChild(eventsContainer);
            employeeRow.appendChild(dayColumn);
        }
        rowsContainer.appendChild(employeeRow);
    });

    // 4. Update the side employee labels to match the new heights
    renderWeekEmployeeColumn(rowHeightsMap);
}
// window.addEventListener('resize', () => {
//     if (currentView === 'day') renderDayView();
//     else renderWeekView();
// });

        function renderWeekEmployeeColumn(rowHeightsMap = {}) {
    const column = document.getElementById('weekEmployeeColumn');
    column.innerHTML = '';

    const displayList = employees.length > 0 ? employees : ['—'];
    const employeeObj = appliedFilters.find(o => o.field === "staff" || o.field === "employee" );
    if(employeeObj){
        employeeValues = returnEmployees(employeeObj.searchValues);
        console.log(employeeValues);
        if (!employeeValues.includes('')) {
            employeeValues.unshift('');
        }
    }
    else{
        employeeValues = employees;
    }
    employeeValues.forEach(employee => {
        const row = document.createElement('div');
        row.className = 'week-employee-row';

        if (employee !== '—') {
            const hours = getTotalWeekHours(employee);

            row.innerHTML = `
                <div class="employee-label">
                    <div class="employee-name">${employee}</div>
                    <div class="employee-total-hours">${hours}</div>
                </div>
            `;
        }

        const height =
            rowHeightsMap[employee] ||
            (employees.length === 0 ? 500 : MIN_ROW_HEIGHT);

        row.style.height = height + 'px';
        column.appendChild(row);
    });
}

        function renderWeekEventsForEmployee(container, events, dateKey) {
            events.forEach((evt, index) => {
                const el = document.createElement('div');
                el.className = `event status-${evt.status}`;
                 if (evt.Time_Critical_Visit === "Yes") {
            el.classList.add('time-critical');
        }
                el.draggable = true;
                const compositeKey = `${evt.zoho_id}-${evt.employee || 'unassigned'}-${evt.employee_id || 'none'}`;
                el.dataset.eventKey = compositeKey
                el.dataset.eventId = evt.id;
                el.dataset.viewType = 'week';
                el.dataset.eventDate = dateKey;
                el.dataset.employee = evt.employee;
                el.dataset.serviceUser = evt.title || '';
                el.dataset.staff = evt.employee || '—';
                el.dataset.start = minutesToTime(evt.startMinutes).hour.toString().padStart(2,'0') + ':' +
                                minutesToTime(evt.startMinutes).minute.toString().padStart(2,'0');
                el.dataset.end = minutesToTime(evt.endMinutes).hour.toString().padStart(2,'0') + ':' +
                                minutesToTime(evt.endMinutes).minute.toString().padStart(2,'0');

                /* OPTIONAL – only if available */
                el.dataset.mismatch = evt.status === 'Missed' ? 'Visit missed' : '';
                el.dataset.status = evt.event_status;
                el.dataset.travel = evt.travel || '';
                el.dataset.timeCritical = evt.Time_Critical_Visit || "No";
                el.dataset.female = evt.Female_Only || "No";

                // Stack events from top to bottom instead of time-based positioning
                const topPosition = ROW_PADDING + (index * (EVENT_HEIGHT + EVENT_GAP));
                
                el.style.top = `${topPosition}px`;
                el.style.height = `${EVENT_HEIGHT}px`;
                el.style.left = '2px';
                el.style.right = '2px';
                el.style.width = 'auto';

                const title = document.createElement('div');
                title.className = 'event-title';
                title.textContent = evt.title;
                if (evt.Time_Critical_Visit === "Yes") {
            const lockIcon = document.createElement('div');
            lockIcon.className = 'event-lock-icon';
            lockIcon.innerHTML = '<i class="fa fa-lock"></i>';
            lockIcon.title = 'Time Critical Visit - Time cannot be changed';
            el.appendChild(lockIcon);
        }

                const time = document.createElement('div');
                time.className = 'event-time';
                time.textContent = formatTimeRange(evt.startMinutes, evt.endMinutes);

                el.appendChild(title);
                el.appendChild(time);

                el.addEventListener('dragstart', handleDragStartWeek);
                el.addEventListener('dragend', handleDragEndWeek);

                el.addEventListener('mousedown', (e) => {
    mouseDownX = e.clientX;
    mouseDownY = e.clientY;
});
function handleDragStartWeek(e) {
            draggedElement = e.currentTarget;
            draggedEventId = parseInt(e.currentTarget.dataset.eventId);
            
            
            const viewType = e.currentTarget.dataset.viewType;
            let dateKey = viewType === 'week' ? e.currentTarget.dataset.eventDate : getCurrentDateKey();
            
            const events = eventDatabase[dateKey] || [];
            console.log(events);
            
            draggedEventData = events.find(evt => evt.id === draggedEventId);
            if (draggedEventData) {
                draggedEventData.originalDateKey = dateKey;
            }
            
            e.currentTarget.classList.add('dragging');
            document.body.classList.add('dragging-active');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEndWeek(e) {
            e.currentTarget.classList.remove('dragging');
            document.body.classList.remove('dragging-active');
            document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
            draggedElement = null;
            draggedEventId = null;
            draggedEventData = null;
        }

el.addEventListener('mouseup', (e) => {
    // Ignore resize handles (future-safe)
    if (e.target.closest('.resize-handle')) return;

    // Ignore edit icon
    if (e.target.closest('.event-edit')) return;

    const dx = Math.abs(e.clientX - mouseDownX);
    const dy = Math.abs(e.clientY - mouseDownY);

    if (dx > CLICK_TOLERANCE || dy > CLICK_TOLERANCE) return;

    openEventModal(evt);


});
                container.appendChild(el);
            });
        }

        function formatTimeRange(startMinutes, endMinutes) {
            const start = minutesToTime(startMinutes);
            const end = minutesToTime(endMinutes);
            const startHour = start.hour % 12 || 12;
            const startPeriod = start.hour < 12 ? 'AM' : 'PM';
            const endHour = end.hour % 12 || 12;
            const endPeriod = end.hour < 12 ? 'AM' : 'PM';
            return `${startHour}:${start.minute.toString().padStart(2, '0')} ${startPeriod} - ${endHour}:${end.minute.toString().padStart(2, '0')} ${endPeriod}`;
        }

        function minutesToTime(minutes) {
            return { hour: Math.floor(minutes / 60), minute: minutes % 60 };
        }

        // DRAG AND DROP HANDLERS
        function handleDragStart(e) {



    const baseEl = e.currentTarget;
    const baseId = parseInt(baseEl.dataset.eventId);
    const baseEventKey = baseEl.dataset.eventKey;
    // If dragging unselected event → reset selection
    if (!selectedEventIds.has(baseEventKey)) { 
        clearEventSelection();
        selectedEventIds.add(baseEventKey); 
        baseEl.classList.add('selected');
    }

    draggedElement = baseEl;
    draggedEventId = baseId;

    const viewType = baseEl.dataset.viewType;
    const dateKey = viewType === 'week'
        ? baseEl.dataset.eventDate
        : getCurrentDateKey();

    const events = eventDatabase[dateKey] || [];

     
    
    draggedEventData = [...selectedEventIds].map(eventKey => {
        const evt = events.find(e => {
            const eKey = `${e.zoho_id}-${e.employee || 'unassigned'}-${e.employee_id || 'none'}`;
            return eKey === eventKey;
        });
        if (!evt) {
            console.error(`❌ Event not found for key: ${eventKey}`);
            console.log('Available events:', events);
            return null;
        }
        console.log('✅ Found event:', evt);
        return evt ? {
            ...evt,
            originalDateKey: dateKey,
            eventKey: eventKey
        } : null;
    }).filter(Boolean);
    
    console.log('Final draggedEventData:', draggedEventData);
    // ✅ Update dragging class using composite key
    selectedEventIds.forEach(eventKey => {
        const el = document.querySelector(`.event[data-event-key="${eventKey}"]`);
        if (el) {
            el.classList.add('dragging');
        }
    });

document.body.classList.add('dragging-active');
e.dataTransfer.effectAllowed = 'move';
console.log('Drag started with data:', draggedEventData);
}


        function handleDragEnd(e) {            
            e.currentTarget.classList.remove('dragging');
            document.body.classList.remove('dragging-active');
            document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
            draggedElement = null;
            draggedEventId = null;
            draggedEventData = null;
            document.querySelectorAll('.event.dragging').forEach(el => {
    el.classList.remove('dragging');
});

document.body.classList.remove('dragging-active');
        }

        function handleDayDragOver(e) {
            console.log("called");
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const slot = e.currentTarget;
            if (!slot.classList.contains('drop-highlight')) {
                document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
                slot.classList.add('drop-highlight');
            }
        }

        function handleWeekDragOver(e) {
            e.preventDefault();
            
            if (!draggedEventData) {
                e.dataTransfer.dropEffect = 'none';
                return;
            }
            
            const slot = e.currentTarget;
            const newDateKey = slot.dataset.dateKey;
            const newEmployee = slot.dataset.employee;
            const originalDateKey = draggedEventData.originalDateKey;
            const originalEmployee = draggedEventData.employee;
            
            // Prevent drop effect if same column
            if (newDateKey === originalDateKey && newEmployee === originalEmployee) {
                e.dataTransfer.dropEffect = 'none';
                document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
                return;
            }
            
            e.dataTransfer.dropEffect = 'move';
            if (!slot.classList.contains('drop-highlight')) {
                document.querySelectorAll('.drop-highlight').forEach(el => el.classList.remove('drop-highlight'));
                slot.classList.add('drop-highlight');
            }
        }

        function handleDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drop-highlight');
            }
        }

        function handleDayDrop(e) {
    e.preventDefault();
    e.stopPropagation();

    const slot = e.currentTarget;
    slot.classList.remove('drop-highlight');

    if (!Array.isArray(draggedEventData) || draggedEventData.length === 0) {
        return;
    }

    const newHour = parseInt(slot.dataset.hour, 10);
    const newQuarter = parseInt(slot.dataset.quarter, 10);
    const newEmployee = slot.dataset.employee;
    const currentDateKey = getCurrentDateKey();
    const hasTimeCritical = draggedEventData.some(evt => evt.Time_Critical_Visit === "Yes");
    
    if (hasTimeCritical) {
        // ✅ ALLOW EMPLOYEE CHANGE BUT NOT TIME CHANGE
        const anchorEvent = draggedEventData[0];
        const originalStartMinutes = anchorEvent.startMinutes;
        const newAnchorStart = newHour * 60 + newQuarter * 15;
        
        if (newAnchorStart !== originalStartMinutes) {
            showToast("Time Critical Visits cannot be moved to a different time", "error");
            clearEventSelection();
            return;
        }
    }
    
    const hasConflict = draggedEventData.some(evt =>
    newEmployee &&
    hasEmployeeConflict(
        evt.zoho_id,
        newEmployee,
        currentDateKey,
        evt.eventKey
    )
);

if (hasConflict) {
    showToast(`Employee ${newEmployee} is already assigned to this event`);
    clearEventSelection();
    return;
}
    const anchorEvent = draggedEventData[0];
    const anchorStart = anchorEvent.startMinutes;
    const newAnchorStart = newHour * 60 + newQuarter * 15;

    
    const timeChanged = draggedEventData.length === 1 && newAnchorStart !== anchorStart;
    

    if (timeChanged) {
        // Store pending change
        pendingTimeChange = {
            draggedEventData: draggedEventData,
            newHour: newHour,
            newQuarter: newQuarter,
            newEmployee: newEmployee,
            currentDateKey: currentDateKey,
            anchorStart: anchorStart,
            newAnchorStart: newAnchorStart,
            type: 'drag'
        };
        showTimeChangeConfirmation();
    } else {
        // No time change, proceed normally
        applyDragChanges(draggedEventData, newHour, newQuarter, newEmployee, currentDateKey, anchorStart, newAnchorStart);
    }
    
    clearEventSelection();
}
async function applyDragChanges(
    draggedEventData,
    newHour,
    newQuarter,
    newEmployee,
    currentDateKey,
    anchorStart,
    newAnchorStart
) {
    if (!eventDatabase[currentDateKey]) {
        eventDatabase[currentDateKey] = [];
    }

    const syncedZohoIds = new Set(); // 🔥 prevents duplicate calls

    draggedEventData.forEach(evt => {
        const offsetFromAnchor = evt.startMinutes - anchorStart;
        const duration = evt.endMinutes - evt.startMinutes;

        const finalStart = newAnchorStart + offsetFromAnchor;
        const finalEnd = finalStart + duration;
        const timeDelta = finalStart - evt.startMinutes;

        const originalDateKey = evt.originalDateKey;

        // 1️⃣ Collect group
        const groupEvents =
            eventDatabase[originalDateKey]?.filter(e => e.zoho_id === evt.zoho_id) || [];

        // 2️⃣ Remove all from original date
        eventDatabase[originalDateKey] =
            eventDatabase[originalDateKey]?.filter(e => e.zoho_id !== evt.zoho_id) || [];

        let zohoPayload = null;

        // 3️⃣ Reinsert rows
        groupEvents.forEach(e => {
            const isDraggedRow =
                `${e.zoho_id}-${e.employee || 'unassigned'}-${e.employee_id || 'none'}`
                === evt.eventKey;

            const updated = {
                ...e,
                startMinutes: e.startMinutes + timeDelta,
                endMinutes: e.endMinutes + timeDelta
            };

            if (isDraggedRow) {
                updated.employee = newEmployee;

                if (newEmployee) {
                    const empDetail = employeeDetails.find(emp => emp.name === newEmployee);
                    updated.employee_id = empDetail?.id || null;
                } else {
                    updated.employee_id = null;
                }

                // 🔥 Use dragged row for Zoho sync
                zohoPayload = updated;
            }

            eventDatabase[currentDateKey].push(updated);
        });

        // 4️⃣ Sync Zoho ONCE per zoho_id
        if (!syncedZohoIds.has(evt.zoho_id) && zohoPayload) {
            syncedZohoIds.add(evt.zoho_id);

            updateEventZoho({
                ...zohoPayload,
                from: minutesToHHMM(zohoPayload.startMinutes),
                to: minutesToHHMM(zohoPayload.endMinutes),
                employee: zohoPayload.employee
            });
        }
    });

    re_renderDayView();
}



        function handleWeekDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const slot = e.currentTarget;
            slot.classList.remove('drop-highlight');
            
            
            if (!draggedElement || !draggedEventId || !draggedEventData) return;
            
            const newDateKey = slot.dataset.dateKey;
            const newEmployee = slot.dataset.employee;
            const originalDateKey = draggedEventData.originalDateKey;
            const originalEmployee = draggedEventData.employee;

            const isTimeCritical = draggedEventData.Time_Critical_Visit === "Yes";
    
    if (isTimeCritical) {
        
        if (newDateKey !== originalDateKey) {
            showToast("Time Critical Visits cannot be moved to a different day", "error");
            return;
        }
    }
            console.log(originalDateKey,newDateKey);
            
            // Prevent drop if it's the same column (same day AND same employee)
            if (newDateKey === originalDateKey && newEmployee === originalEmployee) {
                return;
            }
            
            const duration = draggedEventData.endMinutes - draggedEventData.startMinutes;
            
            if (eventDatabase[originalDateKey]) {
                const index = eventDatabase[originalDateKey].findIndex(ev => ev.id === draggedEventId);
                if (index !== -1) eventDatabase[originalDateKey].splice(index, 1);
            }
            
            if (!eventDatabase[newDateKey]) eventDatabase[newDateKey] = [];
            eventDatabase[newDateKey].push({
                ...draggedEventData,
                employee: newEmployee,
                date: toYYYYMMDD(newDateKey)
            });
            updateEventZoho( {
                ...draggedEventData,
                employee: newEmployee,
                date: toYYYYMMDD(newDateKey)
            } )
            
            renderWeekView();
        }

        // New Function for From/To Date Filter selection
function selectDateFilterOption(filterName, value, element) {
    const hiddenInput = document.getElementById(`${filterName}-filter`);
    hiddenInput.value = value;
    
    // Update Display Text
    document.getElementById(`${filterName}-filter-text`).textContent = element.textContent;
    
    // Manage UI Visibility based on selection
    const dateGroup = document.getElementById(`${filterName}-date-group`);
    const nGroup = document.getElementById(`${filterName}-n-group`);
    
    // Reset displays
    dateGroup.style.display = 'none';
    nGroup.style.display = 'none';

    // Show date picker for specific date comparisons
    if (value === 'is' || value === 'isNot' || value === 'gtDate' || value === 'ltDate') {
        dateGroup.style.display = 'block';
    } 
    // Show number input for dynamic "n"
    else if (value.includes('NDays') || value.includes('NMonths') || value.includes('NYears')) {
        nGroup.style.display = 'block';
    }

    // Close dropdown
    toggleFilterDropdown(filterName);
}

// Logic to gather data during performSearch()
function getFilterDisplayValue(filterName) {
    const type = document.getElementById(`${filterName}-filter`).value;
    
    if (type === 'gtDate' || type === 'ltDate' || type === 'is' || type === 'isNot') {
        const val = document.getElementById(`${filterName}-date-val`).value;
        return val ? [val] : [];
    }
    
    if (type.includes('NDays') || type.includes('NMonths') || type.includes('NYears')) {
        const val = document.getElementById(`${filterName}-n-val`).value;
        return val ? [val] : [];
    }
    
    // For relative dates (Today, This Month, etc), no additional input is needed
    return ["Selected"]; 
}

// Update the existing performSearch function to handle the new date types
const originalPerformSearch = performSearch;
performSearch = function() {
    const fromChecked = document.querySelector('input[name="from"]').checked;
    const toChecked = document.querySelector('input[name="to"]').checked;
    
    if (fromChecked) {
        const filterType = document.getElementById('from-filter').value;
        filterTags['from'] = getFilterDisplayValue('from');
    }
    
    if (toChecked) {
        const filterType = document.getElementById('to-filter').value;
        filterTags['to'] = getFilterDisplayValue('to');
    }
    
    originalPerformSearch();
};

// Update label formatting to handle date-specific text
const originalFormatFilterText = formatFilterText;
formatFilterText = function(filter) {
    if (filter.field === 'from' || filter.field === 'to') {
        const typeMap = {
            gtDate: 'is after',
            ltDate: 'is before',
            gtNDays: `is > ${filter.searchValues[0]} days from today`,
            ltNDays: `is < ${filter.searchValues[0]} days from today`,
            today: 'is Today',
            thisWeek: 'is This Week',
            last7: 'is within Last 7 Days'
            // ... you can add more friendly mappings here
        };
        const label = typeMap[filter.filterType] || filter.filterType;
        const fieldName = filter.field.charAt(0).toUpperCase() + filter.field.slice(1);
        
        if (['isEmpty', 'isNotEmpty', 'today', 'yesterday', 'tomorrow', 'thisWeek', 'lastWeek', 'nextWeek', 'thisMonth', 'lastMonth', 'nextMonth', 'thisYear', 'lastYear', 'nextYear', 'last7', 'last30', 'last60', 'last90'].includes(filter.filterType)) {
             return `${fieldName} ${label}`;
        }
        return `${fieldName} ${label} "${filter.searchValues[0]}"`;
    }
    return originalFormatFilterText(filter);
};
        // SEARCH FUNCTIONALITY
        function toggleSearch() {
            console.log("Called");
            const panel = document.getElementById('searchPanel');
            const overlay = document.getElementById('searchOverlay');
            panel.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function toggleFilterInputs(filterName) {
            const checkbox = document.querySelector(`input[name="${filterName}"]`);
            const inputs = document.getElementById(`${filterName}-inputs`);
            if (checkbox.checked) {
                inputs.classList.add('active');
            } else {
                inputs.classList.remove('active');
            }
        }

        function toggleFilterDropdown(filterName) {
            const display = document.getElementById(`${filterName}-filter-display`);
            const options = document.getElementById(`${filterName}-filter-options`);
            document.querySelectorAll('.filter-options').forEach(opt => {
                if (opt.id !== `${filterName}-filter-options`) opt.classList.remove('active');
            });
            document.querySelectorAll('.filter-select').forEach(sel => {
                if (sel.id !== `${filterName}-filter-display`) sel.classList.remove('active');
            });
            display.classList.toggle('active');
            options.classList.toggle('active');
        }

        function selectFilterOption(filterName, value, element) {
            document.getElementById(`${filterName}-filter`).value = value;
            filterValues[filterName] = value;
            document.getElementById(`${filterName}-filter-text`).textContent = element.textContent;
            const options = document.getElementById(`${filterName}-filter-options`);
            options.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            
            const tagsGroup = document.getElementById(`${filterName}-tags-group`);
            if (tagsGroup) {
                if (value === 'isEmpty' || value === 'isNotEmpty') {
                    tagsGroup.style.display = 'none';
                } else {
                    tagsGroup.style.display = 'block';
                }
            }
            
            toggleFilterDropdown(filterName);
        }

        function focusTagInput(filterName) {
            document.getElementById(`${filterName}-tags-input`).focus();
        }

        function handleTagInput(event, filterName) {
            const input = event.target;
            const value = input.value.trim();
            
            if (event.key === 'Enter' && value) {
                event.preventDefault();
                if (filterTags[filterName].length >= MAX_TAGS) return;
                addTag(filterName, value);
                input.value = '';
            }
            if (event.key === 'Backspace' && !value && filterTags[filterName].length > 0) {
                event.preventDefault();
                removeTag(filterName, filterTags[filterName].length - 1);
            }
        }

        function addTag(filterName, text) {
            if (!text || filterTags[filterName].includes(text)) return;
            if (filterTags[filterName].length >= MAX_TAGS) return;
            filterTags[filterName].push(text);
            renderTags(filterName);
        }

        function removeTag(filterName, index) {
            filterTags[filterName].splice(index, 1);
            renderTags(filterName);
        }

        function renderTags(filterName) {
            const container = document.getElementById(`${filterName}-tags-container`);
            const input = document.getElementById(`${filterName}-tags-input`);
            if (!container || !input) return;
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());
            filterTags[filterName].forEach((text, index) => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                const textSpan = document.createElement('span');
                textSpan.textContent = text;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'tag-remove';
                removeBtn.textContent = '×';
                removeBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeTag(filterName, index);
                };
                tag.appendChild(textSpan);
                tag.appendChild(removeBtn);
                container.insertBefore(tag, input);
            });
        }

        function performSearch() {
            const checkboxes = document.querySelectorAll('.search-filter input[type="checkbox"]:checked');
            const filters = [];
            
            checkboxes.forEach(checkbox => {
                const filterName = checkbox.name;
                const filterType = document.getElementById(`${filterName}-filter`).value;
                const tags = filterTags[filterName];
                if(tags.length === 0 && (filterType !== 'isEmpty' && filterType !== 'isNotEmpty')) {
                    checkbox.checked = false;             
                    document.getElementById(`${filterName}-inputs`)?.classList.remove('active');   
                    return;
                }
                
                filters.push({
                    field: filterName,
                    filterType: filterType,
                    searchValues: tags
                });
            });
            
            appliedFilters = filters;
            renderAppliedFilters();
            toggleSearch();
            if (currentView === 'week') {
                updateDateTitle();
                renderWeekView();
            } else {
                updateDateTitle();
                renderDayView();
            }
        }
        
        function formatFilterText(filter) {
            const fieldName = fieldDisplayNames[filter.field] || filter.field;
            const filterType = filter.filterType;
            
            if (filterType === 'isEmpty' || filterType === 'isNotEmpty') {
                return `${fieldName} ${filterType === 'isEmpty' ? 'is empty' : 'is not empty'}`;
            }
            
            if (filter.searchValues.length === 0) {
                return `${fieldName} ${filterType}`;
            } else if (filter.searchValues.length === 1) {
                return `${fieldName} ${filterType} "${filter.searchValues[0]}"`;
            } else {
                const valuesList = filter.searchValues.map(v => `"${v}"`).join('" or "');
                return `${fieldName} ${filterType} either "${valuesList}"`;
            }
        }
        
        function renderAppliedFilters() {
            const section = document.getElementById('searchFiltersSection');
            const container = document.getElementById('searchFiltersContainer');
            
            const existingPills = container.querySelectorAll('.search-filter-pill');
            existingPills.forEach(pill => pill.remove());
            
            if (appliedFilters.length === 0) {
                section.classList.remove('active');
                return;
            }
            
            section.classList.add('active');
            
            appliedFilters.forEach((filter, index) => {
                const pill = document.createElement('div');
                pill.className = 'search-filter-pill';
                
                const text = document.createElement('span');
                text.className = 'filter-pill-text';
                text.textContent = formatFilterText(filter);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'filter-pill-remove';
                removeBtn.innerHTML = '×';
                removeBtn.onclick = function() {
                    removeAppliedFilter(index);
                };
                
                pill.appendChild(text);
                pill.appendChild(removeBtn);
                container.appendChild(pill);
            });
        }
        
        function removeAppliedFilter(index) {
            const filterToRemove = appliedFilters[index];
            const filterName = filterToRemove.field;
            
            const checkbox = document.querySelector(`input[name="${filterName}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            const inputs = document.getElementById(`${filterName}-inputs`);
            if (inputs) {
                inputs.classList.remove('active');
            }
            
            const hiddenInput = document.getElementById(`${filterName}-filter`);
            if (hiddenInput) {
                hiddenInput.value = 'contains';
            }
            filterValues[filterName] = 'contains';
            
            const displayText = document.getElementById(`${filterName}-filter-text`);
            if (displayText) {
                displayText.textContent = 'Contains';
            }
            
            const options = document.getElementById(`${filterName}-filter-options`);
            if (options) {
                options.querySelectorAll('.filter-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.textContent === 'Contains') {
                        opt.classList.add('selected');
                    }
                });
            }
            
            const tagsGroup = document.getElementById(`${filterName}-tags-group`);
            if (tagsGroup) {
                tagsGroup.style.display = 'block';
            }
            const filter = appliedFilters[index];
            appliedFilters.splice(index, 1);
            
            clearTags(filterName);
            appliedFilters.splice(index, 1);
            renderAppliedFilters();
            populateQuickDropdowns();
            if (currentView === 'week') {
                updateDateTitle();
                renderWeekView();
            } else {
                updateDateTitle();
                renderDayView();
            }
        }
        
        function clearTags(filterName) {
            filterTags[filterName] = [];
            renderTags(filterName);
        }

        // MINI CALENDAR
        function toggleMiniCalendar() {
            event.stopPropagation();
            const miniCal = document.getElementById('miniCalendar');
            console.log(miniCal);
            const wasActive = miniCal.classList.contains('active');
            miniCal.classList.toggle('active');
            console.log(miniCal);
            if (!wasActive && miniCal.classList.contains('active')) {
                renderMiniCalendar();
            }
        }

        async function renderMiniCalendar() {
            console.log("Caledar Rendered");
            const grid = document.getElementById('miniGrid');
            const monthYear = document.getElementById('miniMonthYear');
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            monthYear.textContent = `${new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' }).toUpperCase()}`;
            
            const existingDays = grid.querySelectorAll('.mini-day');
            existingDays.forEach(day => day.remove());
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();
            let currentWeekDates = [];
            if (currentView === 'week') {
                const weekStart = new Date(currentDate);
                weekStart.setDate(currentDate.getDate() - currentDate.getDay());
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    currentWeekDates.push(date.getTime());
                }
            }
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'mini-day other-month';
                day.textContent = prevMonthDays - i;
                
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevYear = month === 0 ? year - 1 : year;
                const dayDate = new Date(prevYear, prevMonth, prevMonthDays - i);
                
                day.dataset.day = prevMonthDays - i;
                day.dataset.month = prevMonth;
                day.dataset.year = prevYear;
                day.dataset.timestamp = dayDate.getTime();
                
                setupDayEvents(day, dayDate, currentWeekDates);
                grid.appendChild(day);
            }
            
            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.className = 'mini-day';
                day.textContent = i;
                day.dataset.day = i;
                day.dataset.month = month;
                day.dataset.year = year;
                
                const dayDate = new Date(year, month, i);
                day.dataset.timestamp = dayDate.getTime();
                
                if (currentView === 'week' && currentWeekDates.includes(dayDate.getTime())) {
                    day.classList.add('week-highlighted');
                }
                
                if (i === todayDate.getDate() && 
                    month === todayDate.getMonth() && 
                    year === todayDate.getFullYear()) {
                    day.classList.add('today');
                }
                
                if (i === currentDate.getDate() && 
                    month === currentDate.getMonth() && 
                    year === currentDate.getFullYear()) {
                    day.classList.add('selected');
                }
                
                setupDayEvents(day, dayDate, currentWeekDates);
                grid.appendChild(day);
            }
            
            const remainingSlots = 42 - (firstDay + daysInMonth);
            for (let i = 1; i <= remainingSlots; i++) {
                const day = document.createElement('div');
                day.className = 'mini-day other-month';
                day.textContent = i;
                
                const nextMonth = month === 11 ? 0 : month + 1;
                const nextYear = month === 11 ? year + 1 : year;
                const dayDate = new Date(nextYear, nextMonth, i);
                
                day.dataset.day = i;
                day.dataset.month = nextMonth;
                day.dataset.year = nextYear;
                day.dataset.timestamp = dayDate.getTime();
                
                setupDayEvents(day, dayDate, currentWeekDates);
                grid.appendChild(day);
            }
        }
        
        function setupDayEvents(dayElement, dayDate, currentWeekDates) {
            dayElement.addEventListener('click', function() {
                selectDate(parseInt(this.dataset.day), parseInt(this.dataset.month), parseInt(this.dataset.year));
            });
            
            if (currentView === 'week') {
                dayElement.addEventListener('mouseenter', function() {
                    highlightWeekOnHover(dayDate);
                });
                
                dayElement.addEventListener('mouseleave', function() {
                    clearWeekHover();
                });
            }
        }
        
        function highlightWeekOnHover(date) {
            if (currentView !== 'week') return;
            
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                weekDates.push(d.getTime());
            }
            
            const allDays = document.querySelectorAll('.mini-day');
            allDays.forEach(day => {
                const timestamp = parseInt(day.dataset.timestamp);
                if (weekDates.includes(timestamp)) {
                    day.classList.add('week-hover');
                }
            });
        }
        // test
        function clearWeekHover() {
            const allDays = document.querySelectorAll('.mini-day');
            allDays.forEach(day => {
                day.classList.remove('week-hover');
            });
        }

        async function selectDate(day, month, year) {
            currentDate = new Date(year, month, day);
            if (currentViewType === 'employee') {
            // Employee view logic
            await getTodayAllEmployees();
            if (currentView === 'week') {
                await getBookingsForWeek();
                renderWeekView();
            } else {
                await getBookings();
                renderDayView();
            }
        } else if (currentViewType === 'run') {
            // Run view logic
            if (currentView === 'week') {
                await getBookingsForWeek();
                await renderRunViewWeek();
            } else {
                await getBookings();
                await renderRunView();
            }
        }
            
            renderMiniCalendar();
            toggleMiniCalendar();
        }

        function changeMiniMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderMiniCalendar();
        }

        document.addEventListener('click', (e) => {
            const miniCal = document.getElementById('miniCalendar');
            const calIcon = document.querySelectorAll('.calendar-icon')[1];
            if (miniCal && calIcon && miniCal.classList.contains('active') && 
                !miniCal.contains(e.target) && 
                !calIcon.contains(e.target)) {
                miniCal.classList.remove('active');
            }
        });

        // INITIALIZATION
        async function init() {
    inital_load = true;
    try {
        await getZohoData();
        
        // Initialize view switcher options
        updateViewSwitcherOptions();
        
        await switchView('day');
        await renderMiniCalendar();
        
        await new Promise(resolve => {
            requestAnimationFrame(() => {
                startAt6();
                resolve();
            });
        });
        await new Promise(resolve => setTimeout(resolve, 100));
        
    } catch (error) {
        console.error('Initialization error:', error);
    } finally {
        hideLoader();
        inital_load = false;
    }
}

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        let employeeSearchTimer = null;
        function filterEmployees(query) {
    clearTimeout(employeeSearchTimer);

    employeeSearchTimer = setTimeout(() => {
        const q = query.trim().toLowerCase();

        if (q === '') {
            renderDayView();
            return;
        }

        const visibleEmployees = employees.filter(e =>
            e.toLowerCase().includes(q)
        );

        visibleEmployees.unshift('');
        renderFilteredEmployeeRows(visibleEmployees);

        console.log(q, visibleEmployees);
    }, 1000);
}

async function renderFilteredEmployeeRows(emp) {
    const rowsContainer = document.getElementById('calendarRows');
    rowsContainer.innerHTML = '';

    const dateKey = getCurrentDateKey();
    const rowHeightsMap = {};
    const shiftsData = shiftsMap;
    
    
    // Calculate how much height each row needs to fill the screen
    const fillHeight = calculateFillHeight();
    const displayList = employees.length >= 0 ? employees : ['—'];   
    const employeeObj = appliedFilters.find(o => o.field === "staff" || o.field === "employee" );
    if(employeeObj){
        employeeValues = returnEmployees(employeeObj.searchValues);
        if (!employeeValues.includes('')) {
            employeeValues.unshift('');
            console.log(employeeValues);
        }
    }
    else{
        employeeValues = employees;
    }
    emp.forEach(employee => {
        const rawEvents = employee === '—' ? [] : getEventsForEmployee(employee, dateKey);
        const events = detectOverlaps([...rawEvents]);

        const maxConcurrent = events.length ? Math.max(...events.map(e => e.maxConcurrent)) : 1;
        const dynamicHeight = (maxConcurrent * (EVENT_HEIGHT + EVENT_GAP)) + (ROW_PADDING * 2);
        
        // Logic: Take the larger of (Height needed for events) OR (Height needed to fill screen)
        const finalRowHeight = Math.max(fillHeight, dynamicHeight);
        rowHeightsMap[employee] = finalRowHeight;

        const employeeRow = document.createElement('div');
        employeeRow.className = 'employee-calendar-row';
        employeeRow.dataset.employee = employee;
        employeeRow.style.height = finalRowHeight + 'px';

        const grid = document.createElement('div');
        grid.className = 'calendar-grid';

        for (let h = 0; h < 24; h++) {
            const hourCol = document.createElement('div');
            hourCol.className = 'hour-column';
            const innerGrid = document.createElement('div');
            innerGrid.className = 'hour-column-inner';
            for (let i = 0; i < 4; i++) {
                const line = document.createElement('div');
                line.className = 'quarter-line';
                innerGrid.appendChild(line);
            }
            hourCol.appendChild(innerGrid);

            for (let q = 0; q < 4; q++) {
                const slot = document.createElement('div');
                slot.className = 'quarter-slot';
                slot.dataset.hour = h;
                slot.dataset.quarter = q;
                slot.dataset.employee = employee;
                if (employee !== '—') {
                    slot.addEventListener('dragover', handleDayDragOver);
                    slot.addEventListener('drop', handleDayDrop);
                    slot.addEventListener('dragleave', handleDragLeave);
                }
                hourCol.appendChild(slot);
            }
            grid.appendChild(hourCol);
        }
        if (employee !== '—') {
            renderEmployeeWorkingHours(grid, employee, shiftsData);
        }
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'events-container';
        eventsContainer.dataset.employee = employee;
        renderEventsForEmployee(eventsContainer, events);

        grid.appendChild(eventsContainer);
        employeeRow.appendChild(grid);
        rowsContainer.appendChild(employeeRow);
    });

    renderEmployeeColumnBasedOnFilter(rowHeightsMap,emp);
}

async function getAllEmployees() {
     const serviceList = `[${services.join(",")}]`;
    const criteria_2 = `Sites.ID == ${serviceList} && Status == "Active"`;
    var staffs = {
        app_name: app_name,
        report_name: "Staffs_Details_Backend",
        criteria: criteria_2
    };       
    staff_resp = await ZOHO.CREATOR.DATA.getRecords(staffs);
    console.log(staff_resp);
}
function toggleEmployeeDropdown(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('employeeDropdown');
    dropdown.classList.toggle('active');
    getAllEmployees();
    let allEmployees = [...employees];
    let visibleEmployees = [...employees];
    renderEmployeeDropdownList(allEmployees);
}

function renderEmployeeDropdownList(list) {
    const container = document.getElementById('employeeDropdownList');
    container.innerHTML = '';

    list.forEach(emp => {
        const div = document.createElement('div');
        div.className = 'employee-dropdown-item';
        div.textContent = emp;
        div.onclick = () => {
            if (!visibleEmployees.includes(emp)) {
                visibleEmployees.push(emp);
                renderDayView();
            }
        };
        container.appendChild(div);
    });
}
function filterDropdownEmployees(query) {
    const q = query.toLowerCase();
    const filtered = allEmployees.filter(e =>
        e.toLowerCase().includes(q)
    );
    renderEmployeeDropdownList(filtered);
}
const tooltip = document.getElementById('eventTooltip');

function showTooltip(evtEl, mouseEvent) {
    const rect = evtEl.getBoundingClientRect();

    document.getElementById('ttServiceUser').textContent = evtEl.dataset.serviceUser;
    document.getElementById('ttStaff').textContent = evtEl.dataset.staff;
    document.getElementById('ttTime').textContent =
        `${evtEl.dataset.start} – ${evtEl.dataset.end}`;

    document.getElementById('ttMismatch').textContent = evtEl.dataset.status;
    // Mismatch
    // if (evtEl.dataset.mismatch) {
        
    //     document.getElementById('ttMismatchRow').classList.remove('hidden');
    // } else {
    //     document.getElementById('ttMismatchRow').classList.add('hidden');
    // }

    // Travel
    if (evtEl.dataset.travel) {
        document.getElementById('ttTravel').textContent = evtEl.dataset.travel;
        document.getElementById('ttTravelRow').classList.remove('hidden');
    } else {
        document.getElementById('ttTravelRow').classList.add('hidden');
    }
    console.log(evtEl.dataset.timeCritical);
    
    if( evtEl.dataset.timeCritical === "Yes" ){
        document.getElementById('ttTimeCrict').textContent = evtEl.dataset.timeCritical;
        document.getElementById('ttTimeCritical').classList.remove('hidden');
    }
    else{
        document.getElementById('ttTimeCritical').classList.add('hidden');
    }
    console.log();
    
    if( evtEl.dataset.female === "Yes" ){
         document.getElementById('ttFemal').textContent = evtEl.dataset.female;
        document.getElementById('ttFemaleOnly').classList.remove('hidden');
    }
    else{
        document.getElementById('ttFemaleOnly').classList.add('hidden');
    }
    
    tooltip.style.top = rect.bottom + 6 + 'px';
    tooltip.style.left = rect.left + 'px';
    tooltip.classList.remove('hidden');
}

function hideTooltip() {
    tooltip.classList.add('hidden');
}

/* GLOBAL DELEGATION (works for day + week) */
document.addEventListener('mouseover', e => {
    const evtEl = e.target.closest('.event');
    if (!evtEl) return;

    if (e.ctrlKey || e.metaKey) return;

    if (evtEl.classList.contains('dragging')) return;

    if (evtEl.classList.contains('selected')) return;
    showTooltip(evtEl, e);
});

document.addEventListener('mouseout', e => {
    if (e.target.closest('.event')) hideTooltip();
});

/* Hide on scroll / drag */
document.addEventListener('scroll', hideTooltip, true);
document.addEventListener('mousedown', hideTooltip);
function renderEmployeeWorkingHours(container, employee, shiftsData) {
    if (!shiftsData[employee]) return;
    
    const shift = shiftsData[employee];
    const hourWidth = 100; // PIXELS_PER_HOUR
    
    const startHour = Math.floor(shift.startMinutes / 60);
    const startMinute = shift.startMinutes % 60;
    const duration = shift.endMinutes - shift.startMinutes;
    
    const left = (startHour * hourWidth) + ((startMinute / 60) * hourWidth);
    const width = (duration / 60) * hourWidth;
    
    const indicator = document.createElement('div');
    indicator.className = 'employee-working-hours';
    indicator.style.left = left + 'px';
    indicator.style.width = width + 'px';
    indicator.title = `Working hours: ${minutesToHHMM(shift.startMinutes)} - ${minutesToHHMM(shift.endMinutes)}`;
    
    container.appendChild(indicator);
}
let shiftsMap = {};
async function getEmployeeShifts(date) {
    const dateStr = formatDateDDMMYYYY(date);
    const serviceList = `[${services.join(",")}]`;
    
    const criteria = `Date_From == '${dateStr}' && Date_To == '${dateStr}' && Site_Name.ID == ${serviceList}`;
    
    var shifts_config = {
        app_name: app_name,
        report_name: "Daily_schedule_for_Staff",
        criteria: criteria
    };
    
    try {
        const shift_resp = await ZOHO.CREATOR.DATA.getRecords(shifts_config);
        shiftsMap = {};
        
        if (shift_resp.code === 3000 && Array.isArray(shift_resp.data)) {
            shift_resp.data.forEach(rec => {
                const staffName = rec.Staff.zc_display_value;
                const startTime = rec.Start_Time; 
                const endTime = rec.End_Time;     
                
                if (startTime && endTime) {
                    const [startHour, startMin] = startTime.split(':').map(Number);
                    const [endHour, endMin] = endTime.split(':').map(Number);
                    
                    shiftsMap[staffName] = {
                        startMinutes: startHour * 60 + startMin,
                        endMinutes: endHour * 60 + endMin
                    };
                }
            });
        }
    } catch (err) {
        console.log("Error fetching employee shifts:", err);
        return {};
    }
}
async function populateInsightsTable(evt) {
  const tbody = document.getElementById('insightsTableBody');
  tbody.innerHTML = '';
  
  // Get all staff for this event group
  const groupRows = getEventGroupRows(evt);
  const dateKey = toYYYYMMDD(evt.date);
  

var config = {
        'http_method': 'POST',
        'api_name': 'Most_Probable_Staff',
        'public_key': 'Av7kPvbZrGVvnaHgqXpR4wFE8',
        'payload':{
            "id": evt.zoho_id
        }
        
    };
    
    
    ZOHO.CREATOR.DATA.invokeCustomApi(config).then(function (response)  {
        if (response.code === 3000) {

    Object.entries(response.result)
        .sort(([, a], [, b]) => b.Count - a.Count) 
        .forEach(([name, data]) => {

            const noOfVisits = data.Count;
            const availableOverlap = data.Avail;
            const skills = data?.Skills || '';
            const locality = data?.Locality || '';
            const exclude = data?.Exclude || '';

            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${name}</td>
                <td>${noOfVisits}</td>
                <td>${availableOverlap}</td>
                <td>${skills}</td>
                <td>${locality}</td>
                <td>${exclude}</td>
            `;

            tbody.appendChild(row);
        });
}

    }).catch(function (error) {
        console.log( error);
    });

    
  
  employees.forEach(employee => {
    if (!employee) return; // Skip empty employee
    
    // Get all events for this employee on this date
    const employeeEvents = getEventsForEmployee(employee, dateKey);
    const noOfVisits = employeeEvents.length;
    
    // Check if this employee is assigned to the current event
    const isAssigned = groupRows.some(r => r.employee === employee);
    
    // Check for overlaps
    const hasOverlap = employeeEvents.some(e => e.overlap === true);
    const availableOverlap = hasOverlap ? 'YES' : 'NO';
    
    // Get employee details (you'll need to fetch this from Zoho)
    const empDetails = employeeDetails.find(e => e.name === employee);
    const skills = empDetails?.skills || ''; // Add skills to employeeDetails
    const locality = empDetails?.locality || ''; // Add locality to employeeDetails
    
    // Create table row
    
  });
}
    </script>
</body>
</html>